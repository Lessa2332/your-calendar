<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ú–∞–≥—ñ—á–Ω–µ —Ä–æ–∑—Ñ–∞—Ä–±–æ–≤—É–≤–∞–Ω–Ω—è</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body, html { 
      margin:0; padding:0; height:100%; overflow:hidden; 
      background:#000; font-family:'Comic Sans MS',cursive; 
    }
    
    /* –ö–ê–ù–í–ê–° –î–õ–Ø –†–û–ó–ú–ê–õ–¨–û–í–£–í–ê–ù–ù–Ø */
    #drawingCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 100;
      display: none;
      cursor: crosshair;
      touch-action: none;
    }
    
    #hint {
      position:fixed; 
      top: max(20px, env(safe-area-inset-top,20px)); 
      left:50%; 
      transform:translateX(-50%);
      background:#ff1493; 
      color:#fff; 
      padding:12px 24px; 
      border-radius:50px; 
      font-size:clamp(16px,4vw,24px);
      z-index:999; 
      box-shadow:0 0 30px #ff1493; 
      text-align:center; 
      width:90%; 
      max-width:400px;
    }
    
    .controls {
      position:fixed; 
      bottom: max(20px, env(safe-area-inset-bottom,20px)); 
      left:50%; 
      transform:translateX(-50%);
      display:flex; 
      gap:10px; 
      align-items:center; 
      z-index:1000; 
      background:rgba(0,0,0,0.8);
      padding:12px 16px; 
      border-radius:25px; 
      backdrop-filter:blur(10px); 
      flex-wrap:wrap; 
      justify-content:center;
    }
    
    .color-btn {
      width:44px; 
      height:44px; 
      border-radius:50%; 
      border:3px solid transparent; 
      cursor:pointer;
      transition:all .2s; 
      background-size:cover;
    }
    
    .color-btn.active { 
      border:3px solid white; 
      transform:scale(1.2); 
      box-shadow:0 0 20px white; 
    }
    
    .zoom-btn { 
      width:50px; 
      height:50px; 
      border-radius:50%; 
      background:#fff; 
      color:#000; 
      font-size:28px; 
      font-weight:bold;
      display:flex; 
      align-items:center; 
      justify-content:center; 
      cursor:pointer; 
      user-select:none; 
    }
    
    #brushValue { 
      color:white; 
      font-size:18px; 
      min-width:40px; 
      text-align:center; 
    }
    
    input[type="range"] { 
      width:130px; 
      accent-color:#ff1493; 
    }
    
    #closeDrawing {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 20, 147, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 30px;
      cursor: pointer;
      z-index: 101;
      display: none;
    }
    
    /* AR —Å—Ü–µ–Ω–∞ –ø—Ä–æ–∑–æ—Ä–∞ */
    a-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      opacity: 1;
    }
  </style>
</head>
<body>

  <!-- –ö–ê–ù–í–ê–° –î–õ–Ø –†–û–ó–ú–ê–õ–¨–û–í–£–í–ê–ù–ù–Ø -->
  <canvas id="drawingCanvas"></canvas>
  <button id="closeDrawing">‚úï</button>
  
  <div id="hint">–ù–∞—Ç–∏—Å–Ω–∏ –µ–∫—Ä–∞–Ω ‚Üí –ø–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä ‚Üí –º–∞–ª—é–π!</div>

  <div class="controls">
    <div style="display:flex; gap:6px;">
      <div class="color-btn active" data-color="#ff6961" style="background:#ff6961"></div>
      <div class="color-btn" data-color="#fdfd96" style="background:#fdfd96"></div>
      <div class="color-btn" data-color="#77dd77" style="background:#77dd77"></div>
      <div class="color-btn" data-color="#84b6f4" style="background:#84b6f4"></div>
      <div class="color-btn" data-color="#fdcae1" style="background:#fdcae1"></div>
      <div class="color-btn" data-color="#ff9ff3" style="background:#ff9ff3"></div>
      <div class="color-btn" data-color="#feca57" style="background:#feca57"></div>
      <div class="color-btn" data-color="#2d3436" style="background:#2d3436"></div>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <input type="range" id="brushSize" min="5" max="40" value="15">
      <div id="brushValue">15</div>
    </div>
    <div style="display:flex; gap:8px;">
      <div class="zoom-btn" onclick="zoomIn()">+</div>
      <div class="zoom-btn" onclick="zoomOut()">‚Äì</div>
    </div>
  </div>

  <!-- AR –°–¶–ï–ù–ê (–¢–Ü–õ–¨–ö–ò –î–õ–Ø –ó–ê–ü–£–°–ö–£) -->
  <a-scene
    embedded
    mindar-image="imageTargetSrc: calendar.mind; filterMinCF:0.0001; filterBeta:1000; warmupTolerance:5; autoStart: false;"
    renderer="antialias:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false">

    <a-camera active="false"></a-camera>

    <!-- 12 –º–∞—Ä–∫–µ—Ä—ñ–≤ -->
    <a-entity mindar-image-target="targetIndex: 0" class="target" id="target-0"></a-entity>
    <a-entity mindar-image-target="targetIndex: 1" class="target" id="target-1"></a-entity>
    <a-entity mindar-image-target="targetIndex: 2" class="target" id="target-2"></a-entity>
    <a-entity mindar-image-target="targetIndex: 3" class="target" id="target-3"></a-entity>
    <a-entity mindar-image-target="targetIndex: 4" class="target" id="target-4"></a-entity>
    <a-entity mindar-image-target="targetIndex: 5" class="target" id="target-5"></a-entity>
    <a-entity mindar-image-target="targetIndex: 6" class="target" id="target-6"></a-entity>
    <a-entity mindar-image-target="targetIndex: 7" class="target" id="target-7"></a-entity>
    <a-entity mindar-image-target="targetIndex: 8" class="target" id="target-8"></a-entity>
    <a-entity mindar-image-target="targetIndex: 9" class="target" id="target-9"></a-entity>
    <a-entity mindar-image-target="targetIndex: 10" class="target" id="target-10"></a-entity>
    <a-entity mindar-image-target="targetIndex: 11" class="target" id="target-11"></a-entity>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // === –ó–ú–Ü–ù–ù–Ü –î–õ–Ø –ö–ê–ù–í–ê–°–£ ===
      let currentColor = '#ff6961';
      let brushSize = 15;
      let scale = 1;
      let canvas, ctx;
      let isDrawing = false;
      let lastX = 0, lastY = 0;
      let currentImage = null;
      let audio = null;
      let activeMarkerIndex = null;

      // === –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ö–ê–ù–í–ê–°–£ ===
      function initCanvas() {
        canvas = document.getElementById('drawingCanvas');
        ctx = canvas.getContext('2d');
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ canvas
        function resizeCanvas() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);
      }

      function handleTouchStart(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
      }

      function handleTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
      }

      function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
      }

      function draw(e) {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–µ–Ω–∑–ª—è
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize * scale;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—é
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        
        lastX = currentX;
        lastY = currentY;
      }

      function stopDrawing() {
        isDrawing = false;
      }

      // === –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –¢–ê –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø ===
      function loadImageForDrawing(index) {
        const imageNumber = String(index + 1).padStart(2, '0');
        const imageUrl = `images/${imageNumber}.jpg?t=${Date.now()}`;
        
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
          currentImage = img;
          showDrawingCanvas(img);
          
          // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∑–≤—É–∫
          try {
            if (audio) audio.pause();
            audio = new Audio(`fon/${imageNumber}.mp3`);
            audio.loop = true;
            audio.play().catch(e => {
              console.log('üîá –ê—É–¥—ñ–æ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–µ');
            });
          } catch (e) {
            console.log('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞—É–¥—ñ–æ');
          }
        };
        
        img.onerror = function() {
          createFallbackDrawing();
        };
        
        img.src = imageUrl;
      }

      function showDrawingCanvas(img) {
        // –ü–æ–∫–∞–∑—É—î–º–æ –∫–∞–Ω–≤–∞—Å
        canvas.style.display = 'block';
        document.getElementById('closeDrawing').style.display = 'block';
        document.getElementById('hint').style.display = 'none';
        
        // –û—á–∏—â–∞—î–º–æ –∫–∞–Ω–≤–∞—Å
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // –ú–∞–ª—é—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ —Ü–µ–Ω—Ç—Ä—É
        const scaleFactor = Math.min(
          canvas.width / img.width * 0.8,
          canvas.height / img.height * 0.8
        );
        
        const drawWidth = img.width * scaleFactor;
        const drawHeight = img.height * scaleFactor;
        const drawX = (canvas.width - drawWidth) / 2;
        const drawY = (canvas.height - drawHeight) / 2;
        
        ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–æ–∑–∏—Ü—ñ—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
        canvas.imageData = {
          x: drawX,
          y: drawY,
          width: drawWidth,
          height: drawHeight
        };
      }

      function createFallbackDrawing() {
        canvas.style.display = 'block';
        document.getElementById('closeDrawing').style.display = 'block';
        document.getElementById('hint').style.display = 'none';
        
        // –û—á–∏—â–∞—î–º–æ –∫–∞–Ω–≤–∞—Å
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // –ë—ñ–ª–∏–π —Ñ–æ–Ω
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –¢–µ–∫—Å—Ç
        ctx.fillStyle = '#333333';
        ctx.font = '40px Comic Sans MS';
        ctx.textAlign = 'center';
        ctx.fillText('–ú–∞–ª—é–π —Ç—É—Ç! üé®', canvas.width / 2, canvas.height / 2);
        
        currentImage = null;
      }

      function closeDrawing() {
        canvas.style.display = 'none';
        document.getElementById('closeDrawing').style.display = 'none';
        document.getElementById('hint').style.display = 'block';
        
        if (audio) {
          audio.pause();
          audio = null;
        }
        
        currentImage = null;
        activeMarkerIndex = null;
      }

      // === –ö–ï–†–£–í–ê–ù–ù–Ø –Ü–ù–¢–ï–†–§–ï–ô–°–û–ú ===
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelector('.color-btn.active').classList.remove('active');
          btn.classList.add('active');
          currentColor = btn.dataset.color;
        });
      });

      document.getElementById('brushSize').addEventListener('input', e => {
        brushSize = parseInt(e.target.value);
        document.getElementById('brushValue').textContent = brushSize;
      });

      window.zoomIn = () => { 
        scale = Math.min(3, scale + 0.3); 
        updateBrushSize();
      };
      
      window.zoomOut = () => { 
        scale = Math.max(0.7, scale - 0.3); 
        updateBrushSize();
      };
      
      function updateBrushSize() {
        // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä –ø–µ–Ω–∑–ª—è –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –º–∞—Å—à—Ç–∞–±—É
        document.getElementById('brushValue').textContent = Math.round(brushSize * scale);
      }

      // === AR –ú–ê–†–ö–ï–†–ò ===
      document.querySelector('a-scene').addEventListener('loaded', function() {
        initCanvas();
        
        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –º–∞—Ä–∫–µ—Ä—ñ–≤
        for (let i = 0; i < 12; i++) {
          const target = document.getElementById(`target-${i}`);
          target.addEventListener('targetFound', function() {
            if (!canvas || canvas.style.display === 'none') {
              activeMarkerIndex = i;
              loadImageForDrawing(i);
            }
          });
        }

        // –ó–∞–ø—É—Å–∫ AR –ø–æ –∫–ª—ñ–∫—É
        document.body.addEventListener('click', function() {
          document.getElementById('hint').textContent = '–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä!';
          const scene = document.querySelector('a-scene');
          if (scene && scene.systems['mindar-image-system']) {
            scene.systems['mindar-image-system'].start();
          }
        }, { once: true });
      });

      // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è —Ä–æ–∑–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è
      document.getElementById('closeDrawing').addEventListener('click', closeDrawing);

      // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è canvas (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
      function clearCanvas() {
        if (currentImage && canvas.imageData) {
          // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(
            currentImage, 
            canvas.imageData.x, 
            canvas.imageData.y, 
            canvas.imageData.width, 
            canvas.imageData.height
          );
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –æ—á–∏—â–µ–Ω–Ω—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
      const clearBtn = document.createElement('div');
      clearBtn.className = 'zoom-btn';
      clearBtn.textContent = 'C';
      clearBtn.onclick = clearCanvas;
      document.querySelector('.controls').appendChild(clearBtn);
    });
  </script>
</body>
</html>
