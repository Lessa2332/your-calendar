<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Магічний пазл для моєї зірочки</title>
  <!-- Нова версія A-Frame + MindAR, де вже виправлено useLegacyLights -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@2.2.1/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    body{margin:0;overflow:hidden;background:#000;font-family:"Comic Sans MS",sans-serif}
    .hint{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(255,20,180,0.9);color:#fff;padding:15px 30px;border-radius:40px;font-size:26px;z-index:999;box-shadow:0 0 30px hotpink}
    .win{position:fixed;inset:0;background:rgba(0,0,0,0.97);color:#fff;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:1000;font-size:80px}
    .win span{animation:pulse 1.4s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.5)}}
  </style>
</head>
<body>

  <div class="hint">Покажи маркер — і почнеться чарівництво!</div>
  <div class="win" id="win">
    <div><span>УРААА!</span></div>
    <div style="font-size:55px;margin-top:20px">Ти справжній маг!</div>
  </div>

  <a-scene 
    embedded 
    mindar-image="imageTargetSrc: calendar.mind;"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <!-- Додаємо курсор для кліків -->
    <a-entity cursor="rayOrigin: mouse" raycaster="objects: .piece"></a-entity>
    
    <a-entity camera position="0 0 0"></a-entity>
    
    <a-entity mindar-image-target="targetIndex: 0">
      <a-entity id="puzzle" init-puzzle></a-entity>
    </a-entity>
  </a-scene>

  <audio id="sound" src="https://assets.mixkit.co/sfx/preview/mixkit-magical-coin-win-1937.mp3" preload="auto"></audio>

  <script>
    AFRAME.registerComponent('init-puzzle', {
      init: function () {
        const el = this.el;
        
        // Чекаємо на завантаження AR
        el.sceneEl.addEventListener('targetFound', async () => {
          await new Promise(r => setTimeout(r, 1000));
          this.createPuzzle();
        });
      },

      createPuzzle: async function () {
        const img = new Image();
        img.crossOrigin = "anonymous";
        
        // Використовуємо зображення з папки images
        img.src = 'images/01.jpg?' + Date.now();
        
        await img.decode();

        const pw = img.width/3, ph = img.height/3;
        const sw = 0.5/3, sh = (img.height/img.width)*0.5/3;
        const pieces = [];

        for (let row=0; row<3; row++) {
          for (let col=0; col<3; col++) {
            const canvas = document.createElement('canvas');
            canvas.width = pw; 
            canvas.height = ph;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, col*pw, row*ph, pw, ph, 0, 0, pw, ph);

            const plane = document.createElement('a-plane');
            plane.setAttribute('src', canvas.toDataURL());
            plane.setAttribute('width', sw*2);
            plane.setAttribute('height', sh*2);
            plane.setAttribute('position', `${(Math.random()-0.5)*1.5} ${(Math.random()-0.5)*1.5} 0.02`);
            plane.setAttribute('data-target', `${(col-1)*sw} ${(1-row)*sh}`);
            plane.classList.add("piece", "raycastable");
            this.el.appendChild(plane);
            pieces.push(plane);
          }
        }

        // Обробник кліків
        this.el.sceneEl.addEventListener('click', (e) => {
          const clickedEl = e.detail.intersection?.object?.el;
          if (!clickedEl || !clickedEl.classList.contains('piece')) return;

          const otherPieces = pieces.filter(p => p !== clickedEl);
          const other = otherPieces[Math.floor(Math.random() * otherPieces.length)];
          
          const clickedPos = clickedEl.getAttribute('position');
          const otherPos = other.getAttribute('position');
          
          clickedEl.setAttribute('position', otherPos);
          other.setAttribute('position', clickedPos);

          // Перевірка перемоги
          this.checkWin(pieces);
        });
      },

      checkWin: function(pieces) {
        const allCorrect = pieces.every(p => {
          const pos = p.getAttribute('position');
          const [tx, ty] = p.getAttribute('data-target').split(' ').map(Number);
          return Math.abs(pos.x - tx) < 0.08 && Math.abs(pos.y - ty) < 0.08;
        });

        if (allCorrect) {
          document.getElementById('win').style.display = 'flex';
          document.getElementById('sound').play();
          confetti({particleCount:400, spread:100, origin:{y:0.6}});
        }
      }
    });
  </script>
</body>
</html>
