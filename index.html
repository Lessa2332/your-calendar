<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Магічне розфарбовування</title>

  <!-- КЛЮЧ: ПОВЕРТАЄМОСЯ ДО СТАБІЛЬНОЇ ВЕРСІЇ! -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
    
    /* Прозорий фон для A-Frame — працює тільки з 1.2.2! */
    a-scene { background: transparent !important; }
    a-scene canvas { background: transparent !important; }

    #drawingCanvas {
      position: fixed; top:0; left:0; width:100%; height:100%; z-index:100;
      display:none; cursor:crosshair; touch-action:none; background:transparent !important;
      pointer-events:none; image-rendering:-webkit-optimize-contrast;
    }

    #hint {
      position:fixed; top:max(20px, env(safe-area-inset-top,20px)); left:50%; transform:translateX(-50%);
      background:#ff1493; color:#fff; padding:14px 28px; border-radius:50px; font-size:clamp(18px,5vw,28px);
      z-index:999; box-shadow:0 0 30px #ff1493; text-align:center; font-family:'Comic Sans MS',cursive;
    }

    .controls {
      position:fixed; bottom:max(20px, env(safe-area-inset-bottom,20px)); left:50%; transform:translateX(-50%);
      display:flex; gap:12px; padding:12px 20px; border-radius:30px; background:rgba(0,0,0,0.7);
      backdrop-filter:blur(12px); z-index:1000; flex-wrap:wrap; justify-content:center;
    }

    .color-btn {
      width:48px; height:48px; border-radius:50%; border:3px solid transparent; cursor:pointer;
      transition:all .25s;
    }
    .color-btn.active { border:3px solid white; transform:scale(1.3); box-shadow:0 0 25px white; }

    .zoom-btn {
      width:54px; height:54px; border-radius:50%; background:#fff; color:#000;
      font-size:32px; font-weight:bold; display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
    }

    input[type="range"] { width:150px; accent-color:#ff1493; }

    #closeDrawing {
      position:fixed; top:max(20px, env(safe-area-inset-top,20px)); right:20px;
      background:rgba(255,20,147,0.9); color:white; border:none; border-radius:50%;
      width:60px; height:60px; font-size:32px; cursor:pointer; z-index:101; display:none;
      box-shadow:0 0 20px #ff1493;
    }

    .drawing-area {
      position:absolute; border:3px dashed rgba(255,255,255,0.6); border-radius:12px;
      pointer-events:none; z-index:99; display:none; box-shadow:0 0 30px rgba(255,20,147,0.5);
    }
  </style>
</head>
<body>

  <canvas id="drawingCanvas"></canvas>
  <div id="drawingArea" class="drawing-area"></div>
  <button id="closeDrawing">X</button>

  <div id="hint">Покажи маркер камері → малюй!</div>

  <div class="controls">
    <div style="display:flex; gap:8px;">
      <div class="color-btn active" data-color="#ff6961" style="background:#ff6961"></div>
      <div class="color-btn" data-color="#fdfd96" style="background:#fdfd96"></div>
      <div class="color-btn" data-color="#77dd77" style="background:#77dd77"></div>
      <div class="color-btn" data-color="#84b6f4" style="background:#84b6f4"></div>
      <div class="color-btn" data-color="#fdcae1" style="background:#fdcae1"></div>
      <div class="color-btn" data-color="#ff9ff3" style="background:#ff9ff3"></div>
      <div class="color-btn" data-color="#feca57" style="background:#feca57"></div>
      <div class="color-btn" data-color="#2d3436" style="background:#2d3436"></div>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
      <input type="range" id="brushSize" min="5" max="60" value="20">
      <span id="brushValue" style="color:white; min-width:50px; text-align:center;">20</span>
    </div>
    <div style="display:flex; gap:10px;">
      <div class="zoom-btn" onclick="zoomIn()">+</div>
      <div class="zoom-btn" onclick="zoomOut()">-</div>
      <div class="zoom-btn" onclick="clearCanvas()">C</div>
    </div>
  </div>

  <!-- НАЙВАЖЛИВІШЕ: MindAR 1.2.2 + без autoStart: false + без showBackground -->
  <a-scene
    embedded
    mindar-image="imageTargetSrc: calendar.mind; filterMinCF:0.0001; filterBeta:1000; warmupTolerance:5;"
    renderer="antialias:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false">
    
    <a-camera active="false"></a-camera>
    
    <a-entity mindar-image-target="targetIndex: 0" id="target-0"></a-entity>
    <a-entity mindar-image-target="targetIndex: 1" id="target-1"></a-entity>
    <a-entity mindar-image-target="targetIndex: 2" id="target-2"></a-entity>
    <a-entity mindar-image-target="targetIndex: 3" id="target-3"></a-entity>
    <a-entity mindar-image-target="targetIndex: 4" id="target-4"></a-entity>
    <a-entity mindar-image-target="targetIndex: 5" id="target-5"></a-entity>
    <a-entity mindar-image-target="targetIndex: 6" id="target-6"></a-entity>
    <a-entity mindar-image-target="targetIndex: 7" id="target-7"></a-entity>
    <a-entity mindar-image-target="targetIndex: 8" id="target-8"></a-entity>
    <a-entity mindar-image-target="targetIndex: 9" id="target-9"></a-entity>
    <a-entity mindar-image-target="targetIndex: 10" id="target-10"></a-entity>
    <a-entity mindar-image-target="targetIndex: 11" id="target-11"></a-entity>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let currentColor = '#ff6961';
      let brushSize = 20;
      let scale = 1;
      let canvas, ctx;
      let isDrawing = false;
      let lastX = 0, lastY = 0;
      let currentImage = null;
      let audio = null;
      let drawingArea = { x:0, y:0, width:0, height:0 };
      let isInDrawingArea = false;
      const dpr = window.devicePixelRatio || 1;

      // === ІНІЦІАЛІЗАЦІЯ КАНВАСУ ===
      canvas = document.getElementById('drawingCanvas');
      ctx = canvas.getContext('2d');

      function resize() {
        const w = window.innerWidth, h = window.innerHeight;
        canvas.width = w * dpr; canvas.height = h * dpr;
        canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
        ctx.scale(dpr, dpr);
        if (currentImage && canvas.style.display === 'block') {
          setTimeout(() => showDrawingCanvas(currentImage), 100);
        }
      }
      resize();
      window.addEventListener('resize', resize);
      window.addEventListener('orientationchange', () => setTimeout(resize, 200));

      // === МАЛЮВАННЯ ===
      const startDrawing = e => {
        if (!isInDrawingArea) return;
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
      };

      const draw = e => {
        if (!isDrawing || !isInDrawingArea) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize * scale;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        lastX = x; lastY = y;
      };

      const stopDrawing = () => { isDrawing = false; };

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('touchstart', e => { e.preventDefault(); const t = e.touches[0]; const ev = new MouseEvent('mousedown', {clientX: t.clientX, clientY: t.clientY}); canvas.dispatchEvent(ev); });
      canvas.addEventListener('mousemove', e => { draw(e); checkArea(e); });
      canvas.addEventListener('touchmove', e => { e.preventDefault(); const t = e.touches[0]; const ev = new MouseEvent('mousemove', {clientX: t.clientX, clientY: t.clientY}); canvas.dispatchEvent(ev); });
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('touchend', stopDrawing);

      const checkArea = e => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        isInDrawingArea = x >= drawingArea.x && x <= drawingArea.x + drawingArea.width && y >= drawingArea.y && y <= drawingArea.y + drawingArea.height;
        canvas.style.cursor = isInDrawingArea ? 'crosshair' : 'not-allowed';
      };

      // === ЗАВАНТАЖЕННЯ ЗОБРАЖЕННЯ ===
      function loadImage(index) {
        const num = String(index + 1).padStart(2, '0');
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          currentImage = img;
          showDrawingCanvas(img);
          if (audio) audio.pause();
          audio = new Audio(`fon/${num}.mp3`);
          audio.loop = true; audio.play().catch(() => {});
        };
        img.src = `images/${num}.jpg?t=${Date.now()}`;
      }

      function showDrawingCanvas(img) {
        canvas.style.display = 'block';
        canvas.style.pointerEvents = 'auto';
        document.getElementById('closeDrawing').style.display = 'block';
        document.getElementById('hint').style.display = 'none';

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const maxW = canvas.width / dpr * 0.9;
        const maxH = canvas.height / dpr * 0.8;
        const scaleFactor = Math.min(maxW / img.width, maxH / img.height);
        const w = img.width * scaleFactor;
        const h = img.height * scaleFactor;
        const x = (canvas.width / dpr - w) / 2;
        const y = (canvas.height / dpr - h) / 2;

        drawingArea = { x, y, width: w, height: h };
        document.getElementById('drawingArea').style.cssText = `display:block; left:${x}px; top:${y}px; width:${w}px; height:${h}px;`;

        ctx.drawImage(img, x, y, w, h);
      }

      window.clearCanvas = () => { if (currentImage) showDrawingCanvas(currentImage); };
      window.closeDrawing = () => {
        canvas.style.display = 'none';
        canvas.style.pointerEvents = 'none';
        document.getElementById('closeDrawing').style.display = 'none';
        document.getElementById('drawingArea').style.display = 'none';
        document.getElementById('hint').style.display = 'block';
        if (audio) { audio.pause(); audio = null; }
      };

      document.getElementById('closeDrawing').onclick = closeDrawing;

      // === КОЛЬОРИ ТА ПЕНЗЕЛЬ ===
      document.querySelectorAll('.color-btn').forEach(b => b.onclick = () => {
        document.querySelector('.color-btn.active').classList.remove('active');
        b.classList.add('active');
        currentColor = b.dataset.color;
      });

      document.getElementById('brushSize').oninput = e => {
        brushSize = +e.target.value;
        document.getElementById('brushValue').textContent = Math.round(brushSize * scale);
      };

      window.zoomIn = () => { scale = Math.min(3, scale + 0.3); document.getElementById('brushValue').textContent = Math.round(brushSize * scale); };
      window.zoomOut = () => { scale = Math.max(0.6, scale - 0.3); document.getElementById('brushValue').textContent = Math.round(brushSize * scale); };

      // === MINDAR 1.2.2 — КАМЕРА СТАРТУЄ АВТОМАТИЧНО ===
      document.querySelector('a-scene').addEventListener('loaded', () => {
        for (let i = 0; i < 12; i++) {
          document.getElementById(`target-${i}`).addEventListener('targetFound', () => {
            if (canvas.style.display === 'none') loadImage(i);
          });
        }
      });
    });
  </script>
</body>
</html>
