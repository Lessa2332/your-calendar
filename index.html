<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Магічне розфарбовування</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body, html {
      margin:0; padding:0; height:100%; overflow:hidden;
      background:#000; font-family:'Comic Sans MS',cursive;
    }

    /* ПОВНА ПРОЗОРІСТЬ ДЛЯ A-FRAME */
    a-scene canvas { 
      background: transparent !important; 
    }

    #drawingCanvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 100;
      display: none;
      cursor: crosshair;
      touch-action: none;
      background: transparent !important;
      image-rendering: -webkit-optimize-contrast; /* чіткість на Retina */
      pointer-events: none; /* вимкнено за замовчуванням */
    }

    #hint {
      position:fixed;
      top: max(20px, env(safe-area-inset-top,20px));
      left:50%;
      transform:translateX(-50%);
      background:#ff1493;
      color:#fff;
      padding:12px 24px;
      border-radius:50px;
      font-size:clamp(16px,4vw,24px);
      z-index:999;
      box-shadow:0 0 30px #ff1493;
      text-align:center;
      width:90%;
      max-width:400px;
    }

    .controls {
      position:fixed;
      bottom: max(20px, env(safe-area-inset-bottom,20px));
      left:50%;
      transform:translateX(-50%);
      display:flex;
      gap:12px;
      align-items:center;
      z-index:1000;
      background:rgba(0,0,0,0.75);
      padding:12px 16px;
      border-radius:30px;
      backdrop-filter:blur(12px);
      flex-wrap:wrap;
      justify-content:center;
    }

    .color-btn {
      width:46px; height:46px;
      border-radius:50%;
      border:3px solid transparent;
      cursor:pointer;
      transition:all .25s;
    }

    .color-btn.active {
      border:3px solid white;
      transform:scale(1.25);
      box-shadow:0 0 25px white;
    }

    .zoom-btn {
      width:52px; height:52px;
      border-radius:50%;
      background:#fff; color:#000;
      font-size:30px; font-weight:bold;
      display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
    }

    #brushValue { color:white; font-size:18px; min-width:44px; text-align:center; }

    input[type="range"] { width:140px; accent-color:#ff1493; }

    #closeDrawing {
      position: fixed;
      top: max(20px, env(safe-area-inset-top,20px));
      right: 20px;
      background: rgba(255, 20, 147, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px; height: 60px;
      font-size: 32px;
      cursor: pointer;
      z-index: 101;
      display: none;
      box-shadow: 0 0 20px #ff1493;
    }

    .drawing-area {
      position: absolute;
      border: 3px dashed rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      pointer-events: none;
      z-index: 99;
      display: none;
      box-shadow: 0 0 30px rgba(255, 20, 147, 0.5);
    }

    a-scene {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
    }
  </style>
</head>
<body>

  <canvas id="drawingCanvas"></canvas>
  <div id="drawingArea" class="drawing-area"></div>
  <button id="closeDrawing">✕</button>

  <div id="hint">Натисни екран → покажи маркер → малюй пальчиком!</div>

  <div class="controls">
    <div style="display:flex; gap:8px;">
      <div class="color-btn active" data-color="#ff6961" style="background:#ff6961"></div>
      <div class="color-btn" data-color="#fdfd96" style="background:#fdfd96"></div>
      <div class="color-btn" data-color="#77dd77" style="background:#77dd77"></div>
      <div class="color-btn" data-color="#84b6f4" style="background:#84b6f4"></div>
      <div class="color-btn" data-color="#fdcae1" style="background:#fdcae1"></div>
      <div class="color-btn" data-color="#ff9ff3" style="background:#ff9ff3"></div>
      <div class="color-btn" data-color="#feca57" style="background:#feca57"></div>
      <div class="color-btn" data-color="#2d3436" style="background:#2d3436"></div>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
      <input type="range" id="brushSize" min="5" max="50" value="18">
      <div id="brushValue">18</div>
    </div>
    <div style="display:flex; gap:10px;">
      <div class="zoom-btn" onclick="zoomIn()">+</div>
      <div class="zoom-btn" onclick="zoomOut()">–</div>
      <div class="zoom-btn" onclick="clearCanvas()">C</div>
    </div>
  </div>

  <a-scene
    embedded
    mindar-image="imageTargetSrc: calendar.mind; 
                  filterMinCF:0.0001; 
                  filterBeta:1000; 
                  warmupTolerance:5; 
                  autoStart: false;
                  showBackground: true;"
    renderer="antialias:true; colorManagement:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false">
    <a-camera active="false"></a-camera>
    <a-entity mindar-image-target="targetIndex: 0" id="target-0"></a-entity>
    <a-entity mindar-image-target="targetIndex: 1" id="target-1"></a-entity>
    <a-entity mindar-image-target="targetIndex: 2" id="target-2"></a-entity>
    <a-entity mindar-image-target="targetIndex: 3" id="target-3"></a-entity>
    <a-entity mindar-image-target="targetIndex: 4" id="target-4"></a-entity>
    <a-entity mindar-image-target="targetIndex: 5" id="target-5"></a-entity>
    <a-entity mindar-image-target="targetIndex: 6" id="target-6"></a-entity>
    <a-entity mindar-image-target="targetIndex: 7" id="target-7"></a-entity>
    <a-entity mindar-image-target="targetIndex: 8" id="target-8"></a-entity>
    <a-entity mindar-image-target="targetIndex: 9" id="target-9"></a-entity>
    <a-entity mindar-image-target="targetIndex: 10" id="target-10"></a-entity>
    <a-entity mindar-image-target="targetIndex: 11" id="target-11"></a-entity>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let currentColor = '#ff6961';
      let brushSize = 18;
      let scale = 1;
      let canvas, ctx;
      let isDrawing = false;
      let lastX = 0, lastY = 0;
      let currentImage = null;
      let audio = null;
      let activeMarkerIndex = null;
      let originalImageData = null;
      let drawingArea = { x: 0, y: 0, width: 0, height: 0 };
      let isInDrawingArea = false;
      const dpr = window.devicePixelRatio || 1;

      function initCanvas() {
        canvas = document.getElementById('drawingCanvas');
        ctx = canvas.getContext('2d');

        function resizeCanvas() {
          const w = window.innerWidth;
          const h = window.innerHeight;
          canvas.width = w * dpr;
          canvas.height = h * dpr;
          canvas.style.width = w + 'px';
          canvas.style.height = h + 'px';
          ctx.scale(dpr, dpr);

          if (currentImage && canvas.style.display === 'block') {
            showDrawingCanvas(currentImage);
          }
        }

        resizeCanvas();
        window.addEventListener('resize', () => setTimeout(resizeCanvas, 100));
        window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 200));

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('touchstart', e => { e.preventDefault(); handleTouch(e, 'mousedown'); });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', e => { e.preventDefault(); handleTouch(e, 'mousemove'); });
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);
        canvas.addEventListener('mousemove', checkDrawingArea);
        canvas.addEventListener('touchmove', checkDrawingArea);
      }

      function handleTouch(e, type) {
        const touch = e.touches[0];
        const ev = new MouseEvent(type, { clientX: touch.clientX, clientY: touch.clientY });
        canvas.dispatchEvent(ev);
      }

      function checkDrawingArea(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        isInDrawingArea = x >= drawingArea.x && x <= drawingArea.x + drawingArea.width &&
                          y >= drawingArea.y && y <= drawingArea.y + drawingArea.height;
        canvas.style.cursor = isInDrawingArea ? 'crosshair' : 'not-allowed';
      }

      function startDrawing(e) {
        if (!isInDrawingArea) return;
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
      }

      function draw(e) {
        if (!isDrawing || !isInDrawingArea) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize * scale;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();

        lastX = x;
        lastY = y;
      }

      function stopDrawing() { isDrawing = false; }

      function loadImageForDrawing(index) {
        const num = String(index + 1).padStart(2, '0');
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          currentImage = img;
          showDrawingCanvas(img);
          if (audio) audio.pause();
          audio = new Audio(`fon/${num}.mp3`);
          audio.loop = true;
          audio.play().catch(() => {});
        };
        img.onerror = createFallbackDrawing;
        img.src = `images/${num}.jpg?t=${Date.now()}`;
      }

      function showDrawingCanvas(img) {
        canvas.style.display = 'block';
        canvas.style.pointerEvents = 'auto';
        document.getElementById('closeDrawing').style.display = 'block';
        document.getElementById('hint').style.display = 'none';

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const maxWidth = canvas.width / dpr * 0.88;
        const maxHeight = canvas.height / dpr * 0.78;
        const scaleFactor = Math.min(maxWidth / img.width, maxHeight / img.height);

        const w = img.width * scaleFactor;
        const h = img.height * scaleFactor;
        const x = (canvas.width / dpr - w) / 2;
        const y = (canvas.height / dpr - h) / 2;

        drawingArea = { x, y, width: w, height: h };

        const areaEl = document.getElementById('drawingArea');
        areaEl.style.display = 'block';
        areaEl.style.left = x + 'px';
        areaEl.style.top = y + 'px';
        areaEl.style.width = w + 'px';
        areaEl.style.height = h + 'px';

        ctx.drawImage(img, x, y, w, h);
        originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      }

      function createFallbackDrawing() {
        canvas.style.display = 'block';
        canvas.style.pointerEvents = 'auto';
        document.getElementById('closeDrawing').style.display = 'block';
        document.getElementById('hint').style.display = 'none';

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const w = Math.min(600, canvas.width / dpr * 0.8);
        const h = w * 0.7;
        const x = (canvas.width / dpr - w) / 2;
        const y = (canvas.height / dpr - h) / 2;

        drawingArea = { x, y, width: w, height: h };
        document.getElementById('drawingArea').style.cssText = `
          display:block; left:${x}px; top:${y}px; width:${w}px; height:${h}px;
        `;

        ctx.fillStyle = '#ffffff44';
        ctx.fillRect(x, y, w, h);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 36px Comic Sans MS';
        ctx.textAlign = 'center';
        ctx.fillText('Малюй тут!', canvas.width / dpr / 2, canvas.height / dpr / 2);

        originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      }

      function clearCanvas() {
        if (originalImageData) {
          ctx.putImageData(originalImageData, 0, 0);
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      function closeDrawing() {
        canvas.style.display = 'none';
        canvas.style.pointerEvents = 'none';
        document.getElementById('closeDrawing').style.display = 'none';
        document.getElementById('drawingArea').style.display = 'none';
        document.getElementById('hint').style.display = 'block';
        if (audio) { audio.pause(); audio = null; }
        currentImage = null;
      }

      // UI
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelector('.color-btn.active').classList.remove('active');
          btn.classList.add('active');
          currentColor = btn.dataset.color;
        });
      });

      document.getElementById('brushSize').addEventListener('input', e => {
        brushSize = parseInt(e.target.value);
        document.getElementById('brushValue').textContent = Math.round(brushSize * scale);
      });

      window.zoomIn = () => { scale = Math.min(3, scale + 0.3); updateBrushSize(); };
      window.zoomOut = () => { scale = Math.max(0.6, scale - 0.3); updateBrushSize(); };
      window.clearCanvas = clearCanvas;
      function updateBrushSize() {
        document.getElementById('brushValue').textContent = Math.round(brushSize * scale);
      }

      // AR
      document.querySelector('a-scene').addEventListener('loaded', () => {
        initCanvas();

        for (let i = 0; i < 12; i++) {
          document.getElementById(`target-${i}`).addEventListener('targetFound', () => {
            if (canvas.style.display === 'none') {
              loadImageForDrawing(i);
            }
          });
        }

        document.body.addEventListener('click', () => {
          document.getElementById('hint').textContent = 'Покажи маркер камері!';
          document.querySelector('a-scene').systems['mindar-image-system'].start();
        }, { once: true });
      });

      document.getElementById('closeDrawing').addEventListener('click', closeDrawing);
    });
  </script>
</body>
</html>
