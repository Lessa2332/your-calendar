<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Магічне розфарбовування</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive; }
    #hint {
      position:fixed; top:max(20px, env(safe-area-inset-top,20px)); left:50%; transform:translateX(-50%);
      background:#ff1493; color:#fff; padding:12px 24px; border-radius:50px; font-size:clamp(16px,4vw,24px);
      z-index:999; box-shadow:0 0 30px #ff1493; text-align:center; width:90%; max-width:400px;
    }
    .controls {
      position:fixed; bottom:max(20px, env(safe-area-inset-bottom,20px)); left:50%; transform:translateX(-50%);
      display:flex; gap:10px; align-items:center; z-index:1000; background:rgba(0,0,0,0.8);
      padding:12px 16px; border-radius:25px; backdrop-filter:blur(10px); flex-wrap:wrap; justify-content:center;
    }
    .color-btn {
      width:44px; height:44px; border-radius:50%; border:3px solid transparent; cursor:pointer;
      transition:all .2s; background-size:cover;
    }
    .color-btn.active { border:3px solid white; transform:scale(1.2); box-shadow:0 0 20px white; }
    .zoom-btn { width:50px; height:50px; border-radius:50%; background:#fff; color:#000; font-size:28px; font-weight:bold;
      display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; }
    #brushValue { color:white; font-size:18px; min-width:40px; text-align:center; }
    input[type="range"] { width:130px; accent-color:#ff1493; }
  </style>
</head>
<body>

  <div id="hint">Натисни екран → покажи маркер → малюй!</div>

  <div class="controls">
    <div style="display:flex; gap:6px;">
      <div class="color-btn active" data-color="#ff6961" style="background:#ff6961"></div>
      <div class="color-btn" data-color="#fdfd96" style="background:#fdfd96"></div>
      <div class="color-btn" data-color="#77dd77" style="background:#77dd77"></div>
      <div class="color-btn" data-color="#84b6f4" style="background:#84b6f4"></div>
      <div class="color-btn" data-color="#fdcae1" style="background:#fdcae1"></div>
      <div class="color-btn" data-color="#ff9ff3" style="background:#ff9ff3"></div>
      <div class="color-btn" data-color="#feca57" style="background:#feca57"></div>
      <div class="color-btn" data-color="#2d3436" style="background:#2d3436"></div>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <input type="range" id="brushSize" min="5" max="40" value="15">
      <div id="brushValue">15</div>
    </div>
    <div style="display:flex; gap:8px;">
      <div class="zoom-btn" onclick="zoomIn()">+</div>
      <div class="zoom-btn" onclick="zoomOut()">–</div>
    </div>
  </div>

  <a-scene
    embedded
    mindar-image="imageTargetSrc: calendar.mind; filterMinCF:0.0001; filterBeta:1000; warmupTolerance:5"
    renderer="antialias:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false">

    <a-camera active="true"></a-camera>

    <!-- 12 СТАТИЧНИХ цілей -->
    <a-entity mindar-image-target="targetIndex: 0" class="target" id="target-0"></a-entity>
    <a-entity mindar-image-target="targetIndex: 1" class="target" id="target-1"></a-entity>
    <a-entity mindar-image-target="targetIndex: 2" class="target" id="target-2"></a-entity>
    <a-entity mindar-image-target="targetIndex: 3" class="target" id="target-3"></a-entity>
    <a-entity mindar-image-target="targetIndex: 4" class="target" id="target-4"></a-entity>
    <a-entity mindar-image-target="targetIndex: 5" class="target" id="target-5"></a-entity>
    <a-entity mindar-image-target="targetIndex: 6" class="target" id="target-6"></a-entity>
    <a-entity mindar-image-target="targetIndex: 7" class="target" id="target-7"></a-entity>
    <a-entity mindar-image-target="targetIndex: 8" class="target" id="target-8"></a-entity>
    <a-entity mindar-image-target="targetIndex: 9" class="target" id="target-9"></a-entity>
    <a-entity mindar-image-target="targetIndex: 10" class="target" id="target-10"></a-entity>
    <a-entity mindar-image-target="targetIndex: 11" class="target" id="target-11"></a-entity>

  </a-scene>

  <script>
    // Чекаємо, поки A-Frame повністю завантажиться
    document.addEventListener('DOMContentLoaded', function() {
      let currentColor = '#ff6961';
      let brushSize = 15;
      let scale = 1;
      let canvas, ctx;
      let isDrawing = false;
      let lastPoint = null;
      let activeIdx = null;
      let audio = null;

      // Реєструємо компонент для малювання
      AFRAME.registerComponent('draw-handler', {
        init: function () {
          this.el.addEventListener('mousedown', () => {
            isDrawing = true;
            lastPoint = null;
          });
          this.el.addEventListener('mouseup', () => { 
            isDrawing = false; 
            lastPoint = null; 
          });
          this.el.addEventListener('mousemove', e => {
            if (!isDrawing || !ctx || !canvas) return;
            
            const intersection = e.detail.intersection;
            if (!intersection || !intersection.uv) return;
            
            const uv = intersection.uv;
            const x = uv.x * canvas.width;
            const y = (1 - uv.y) * canvas.height;

            if (lastPoint) {
              ctx.strokeStyle = currentColor;
              ctx.lineWidth = brushSize;
              ctx.lineCap = 'round';
              ctx.lineJoin = 'round';
              ctx.beginPath();
              ctx.moveTo(lastPoint.x, lastPoint.y);
              ctx.lineTo(x, y);
              ctx.stroke();
              
              // Оновлюємо текстуру
              this.el.setAttribute('material', 'src', canvas.toDataURL());
            }
            lastPoint = { x, y };
          });
        }
      });

      // Обробники подій для цілей
      document.querySelector('a-scene').addEventListener('targetFound', e => {
        const target = e.target;
        const targetAttr = target.getAttribute('mindar-image-target');
        if (!targetAttr) return;
        
        const idx = targetAttr.targetIndex;
        if (activeIdx === idx) return;
        
        clearAll();
        activeIdx = idx;
        loadContent(idx);
        document.getElementById('hint').textContent = 'Малюй!';
      });

      document.querySelector('a-scene').addEventListener('targetLost', e => {
        const target = e.target;
        const targetAttr = target.getAttribute('mindar-image-target');
        if (!targetAttr) return;
        
        const idx = targetAttr.targetIndex;
        if (activeIdx === idx) {
          clearAll();
        }
      });

      function clearAll() {
        document.querySelectorAll('a-plane.draw').forEach(p => p.remove());
        if (audio) { 
          audio.pause(); 
          audio = null; 
        }
        canvas = null;
        ctx = null;
        scale = 1;
        activeIdx = null;
        isDrawing = false;
        lastPoint = null;
      }

      function loadContent(idx) {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => createDrawingPlane(img, idx);
        img.onerror = () => createFallback(idx);
        
        // ВИПРАВЛЕНІ ШЛЯХИ - відповідно до структури репозиторія
        const imageNumber = String(idx + 1).padStart(2, '0');
        img.src = `images/${imageNumber}.jpg?t=${Date.now()}`;

        // Аудіо - виправлені шляхи
        try {
          if (audio) audio.pause();
          audio = new Audio(`fon/${imageNumber}.mp3`);
          audio.loop = true;
          audio.play().catch(e => {
            console.log('Аудіо не може бути відтворене:', e);
          });
        } catch (e) {
          console.log('Помилка створення аудіо:', e);
        }
      }

      function createDrawingPlane(img, idx) {
        const targetElement = document.querySelector(`a-entity[targetIndex="${idx}"]`);
        if (!targetElement) {
          console.error(`Ціль з індексом ${idx} не знайдена`);
          return;
        }

        // Очищаємо попередні елементи
        targetElement.querySelectorAll('a-plane.draw').forEach(el => el.remove());

        canvas = document.createElement('canvas');
        canvas.width = 1024;
        canvas.height = 1024 * (img.height / img.width);
        ctx = canvas.getContext('2d');
        
        // Заповнюємо білим фоном
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Малюємо зображення
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const plane = document.createElement('a-plane');
        plane.classList.add('draw', 'draw-surface');
        plane.setAttribute('position', '0 0 0.01');
        plane.setAttribute('width', '0.6');
        plane.setAttribute('height', 0.6 * (canvas.height / canvas.width));
        plane.setAttribute('material', {
          src: canvas.toDataURL(),
          transparent: true,
          alphaTest: 0.5
        });
        plane.setAttribute('draw-handler', '');

        targetElement.appendChild(plane);
      }

      function createFallback(idx) {
        const targetElement = document.querySelector(`a-entity[targetIndex="${idx}"]`);
        if (!targetElement) return;

        canvas = document.createElement('canvas');
        canvas.width = 800; 
        canvas.height = 600;
        ctx = canvas.getContext('2d');
        
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, 800, 600);
        ctx.fillStyle = '#333333'; 
        ctx.font = '40px Arial'; 
        ctx.textAlign = 'center';
        ctx.fillText('Малюй тут!', 400, 300);

        const plane = document.createElement('a-plane');
        plane.classList.add('draw', 'draw-surface');
        plane.setAttribute('position', '0 0 0.01');
        plane.setAttribute('width', '0.6'); 
        plane.setAttribute('height', '0.45');
        plane.setAttribute('material', {
          src: canvas.toDataURL(),
          transparent: true,
          alphaTest: 0.5
        });
        plane.setAttribute('draw-handler', '');

        targetElement.appendChild(plane);
      }

      // Кольори, розмір, зум
      document.querySelectorAll('.color-btn').forEach(b => {
        b.addEventListener('click', () => {
          document.querySelector('.color-btn.active').classList.remove('active');
          b.classList.add('active');
          currentColor = b.dataset.color;
        });
      });

      document.getElementById('brushSize').addEventListener('input', e => {
        brushSize = parseInt(e.target.value);
        document.getElementById('brushValue').textContent = brushSize;
      });

      window.zoomIn = () => { 
        scale = Math.min(3, scale + 0.3); 
        updateZoom(); 
      };
      
      window.zoomOut = () => { 
        scale = Math.max(0.7, scale - 0.3); 
        updateZoom(); 
      };
      
      function updateZoom() {
        const plane = document.querySelector('a-plane.draw');
        if (plane) {
          plane.setAttribute('scale', `${scale} ${scale} 1`);
        }
      }

      // Старт після кліку
      document.body.addEventListener('click', () => {
        document.getElementById('hint').textContent = 'Покажи маркер!';
        const scene = document.querySelector('a-scene');
        if (scene && scene.systems['mindar-image-system']) {
          scene.systems['mindar-image-system'].start();
        }
      }, { once: true });
    });
  </script>
</body>
</html>

