<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>–ú–∞–≥—ñ—á–Ω–µ —Ä–æ–∑—Ñ–∞—Ä–±–æ–≤—É–≤–∞–Ω–Ω—è</title>

  <!-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ò–ô –ü–û–†–Ø–î–û–ö -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body, html { margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif; }
    #hint { 
      position:fixed; top:20px; left:50%; transform:translateX(-50%); 
      background:#ff1493; color:#fff; padding:16px 32px; border-radius:50px; 
      font-size:24px; z-index:999; box-shadow:0 0 30px #ff1493; text-align:center; 
    }
    .controls { 
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%); 
      display:flex; gap:15px; align-items:center; z-index:1000; 
      background:rgba(0,0,0,0.75); padding:15px 20px; border-radius:30px; 
    }
    .colors { display:flex; gap:8px; }
    .color-btn { 
      width:44px; height:44px; border-radius:50%; border:4px solid transparent; 
      cursor:pointer; transition:all .2s; 
    }
    .color-btn.active { 
      border:4px solid white; transform:scale(1.15); 
      box-shadow:0 0 15px rgba(255,255,255,0.6); 
    }
    input[type="range"] { width:130px; accent-color:#ff1493; }
    .zoom-btn { 
      width:50px; height:50px; border-radius:50%; background:#fff; color:#000; 
      font-size:28px; font-weight:bold; display:flex; align-items:center; 
      justify-content:center; cursor:pointer; user-select:none; 
    }
    #brushValue { color:white; font-size:18px; min-width:30px; text-align:center; }
    #cameraPreview {
      position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:0;
      display:none;
    }
  </style>
</head>
<body>

  <video id="cameraPreview" playsinline muted autoplay></video>
  <div id="hint">–ù–∞—Ç–∏—Å–Ω–∏ –µ–∫—Ä–∞–Ω ‚Üí –ø–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä ‚Üí –º–∞–ª—é–π!</div>

  <div class="controls">
    <div class="colors">
      <div class="color-btn active" data-color="#ff6961" style="background:#ff6961"></div>
      <div class="color-btn" data-color="#fdfd96" style="background:#fdfd96"></div>
      <div class="color-btn" data-color="#77dd77" style="background:#77dd77"></div>
      <div class="color-btn" data-color="#84b6f4" style="background:#84b6f4"></div>
      <div class="color-btn" data-color="#fdcae1" style="background:#fdcae1"></div>
      <div class="color-btn" data-color="#cbaacb" style="background:#cbaacb"></div>
      <div class="color-btn" data-color="#ff9ff3" style="background:#ff9ff3"></div>
      <div class="color-btn" data-color="#feca57" style="background:#feca57"></div>
      <div class="color-btn" data-color="#2d3436" style="background:#2d3436"></div>
    </div>
    <input type="range" id="brushSize" min="3" max="50" value="15">
    <div id="brushValue">15</div>
    <div class="zoom-btn" onclick="zoomIn()">+</div>
    <div class="zoom-btn" onclick="zoomOut()">‚Äì</div>
  </div>

  <a-scene
    embedded
    mindar-image="imageTargetSrc: ./calendar.mind; autoStart:false; uiLoading:no; uiError:no; uiScanning:no; filterMinCF:0.0001; filterBeta:1000; warmupTolerance:5"
    renderer="colorManagement:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false">
    
    <!-- ‚úÖ –î–û–î–ê–ù–û RAYCASTER -->
    <a-camera 
      active="false"
      raycaster="objects: .draw-surface; far: 100"
      cursor="fuse: false; rayOrigin: mouse">
    </a-camera>
    
    <a-entity id="drawing-container"></a-entity>
  </a-scene>

  <script>
    let currentColor = '#ff6961';
    let brushSize = 15;
    let scale = 1;
    let drawingCanvas = null;
    let ctx = null;
    let activeTargetIndex = null;
    let audio = null;
    let isDrawing = false;
    let lastIntersection = null;
    let cameraStream = null;
    let userInteracted = false;

    // === –ê—É–¥—ñ–æ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∫–∞ ===
    function unlockAudio() {
      if (userInteracted) return;
      userInteracted = true;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      ctx.resume();
    }

    // === –°—Ç–≤–æ—Ä–µ–Ω–Ω—è 12 —Ü—ñ–ª–µ–π ===
    function createTargets() {
      const container = document.getElementById('drawing-container');
      for (let i = 0; i < 12; i++) {
        const target = document.createElement('a-entity');
        target.setAttribute('mindar-image-target', { targetIndex: i });
        target.id = `target-${i}`;
        container.appendChild(target);
      }
    }

    // === –ó–ê–ü–ò–¢ –ö–ê–ú–ï–†–ò (—è–∫ —É Halloween –≤–µ—Ä—Å—ñ—ó) ===
    async function startAR() {
      try {
        console.log('üöÄ –ó–∞–ø—É—Å–∫ AR –∑ –∫–∞–º–µ—Ä–æ—é...');
        
        // –°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–µ–≤'—é –∫–∞–º–µ—Ä–∏
        const cameraPreview = document.getElementById('cameraPreview');
        cameraPreview.srcObject = cameraStream;
        cameraPreview.style.display = 'block';
        
        console.log('‚úÖ –ö–∞–º–µ—Ä–∞ —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞');

        // –¢–µ–ø–µ—Ä –∑–∞–ø—É—Å–∫–∞—î–º–æ MindAR
        const scene = document.querySelector('a-scene');
        const mindarSystem = scene.systems['mindar-image-system'];
        
        if (mindarSystem) {
          await mindarSystem.start();
          console.log('‚úÖ MindAR —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ');
          
          // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–∞–º–µ—Ä—É A-Frame
          const aframeCamera = document.querySelector('a-camera');
          aframeCamera.setAttribute('active', 'true');
          
          document.getElementById('hint').textContent = '–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ! üì±';
        }

      } catch (err) {
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏:', err);
        document.getElementById('hint').textContent = '‚ùå –î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏! –ù–∞—Ç–∏—Å–Ω–∏ –∑–Ω–æ–≤—É.';
        
        // –î–æ–∑–≤–æ–ª—è—î–º–æ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑
        userInteracted = false;
      }
    }

    // === –ü–æ–¥—ñ—ó –º–∞—Ä–∫–µ—Ä—ñ–≤ ===
    function onTargetFound(e) {
      const idx = e.detail.targetIndex;
      console.log('–ó–Ω–∞–π–¥–µ–Ω–æ –º–∞—Ä–∫–µ—Ä:', idx);
      if (activeTargetIndex === idx) return;
      resetAll();
      activeTargetIndex = idx;
      loadImageAndSound(idx);
    }

    function onTargetLost(e) {
      console.log('–í—Ç—Ä–∞—á–µ–Ω–æ –º–∞—Ä–∫–µ—Ä:', e.detail.targetIndex);
      if (activeTargetIndex === e.detail.targetIndex) {
        resetAll();
      }
    }

    function resetAll() {
      if (audio) { 
        audio.pause(); 
        audio = null; 
      }
      document.querySelectorAll('.draw-surface').forEach(el => el.remove());
      drawingCanvas = ctx = null;
      scale = 1;
      activeTargetIndex = null;
      isDrawing = false;
    }

    // === –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è + –∑–≤—É–∫ ===
    async function loadImageAndSound(idx) {
      try {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = `./images/${String(idx + 1).padStart(2, '0')}.jpg?t=${Date.now()}`;
        
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = () => reject(new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ${idx + 1}`));
        });

        // –°–ø—Ä–æ–±–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—É–∫
        try {
          audio = new Audio(`./fon/fon${idx + 1}.mp3`);
          audio.loop = true;
          await audio.play().catch(e => console.log('–ó–≤—É–∫ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä—é—î—Ç—å—Å—è:', e));
        } catch(e) {
          console.log('–§–∞–π–ª –∑–≤—É–∫—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        }

        createCanvas(img, idx);
      } catch(error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
        // –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ—Å—Ç—É –∫–æ–ª—å–æ—Ä–æ–≤—É –ø–æ–≤–µ—Ä—Ö–Ω—é —è–∫ –∑–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç
        createFallbackCanvas(idx);
      }
    }

    // === –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–ª–æ—Ç–Ω–∞ –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è ===
    function createCanvas(img, idx) {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      const plane = document.createElement('a-plane');
      plane.className = 'draw-surface';
      plane.setAttribute('position', '0 0 0.01');
      plane.setAttribute('width', 0.6);
      plane.setAttribute('height', (img.height / img.width) * 0.6);
      plane.setAttribute('material', 'src', canvas.toDataURL());
      plane.setAttribute('material', 'transparent', 'true');
      
      // ‚úÖ –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è
      plane.setAttribute('class', 'draw-surface interactive');
      
      document.getElementById(`target-${idx}`).appendChild(plane);
      drawingCanvas = canvas;

      console.log('–ü–æ–ª–æ—Ç–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ –¥–ª—è —Ü—ñ–ª—ñ:', idx);
    }

    // === –ó–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç (—è–∫—â–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ—Å—å) ===
    function createFallbackCanvas(idx) {
      const canvas = document.createElement('canvas');
      canvas.width = 800;
      canvas.height = 600;
      ctx = canvas.getContext('2d');
      ctx.fillStyle = '#2a2a2a';
      ctx.fillRect(0, 0, 800, 600);
      ctx.fillStyle = '#fff';
      ctx.font = '40px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('–ú–∞–ª—é–π —Ç—É—Ç!', 400, 300);

      const plane = document.createElement('a-plane');
      plane.className = 'draw-surface';
      plane.setAttribute('position', '0 0 0.01');
      plane.setAttribute('width', 0.6);
      plane.setAttribute('height', 0.45);
      plane.setAttribute('material', 'src', canvas.toDataURL());
      plane.setAttribute('material', 'transparent', 'true');
      plane.setAttribute('class', 'draw-surface interactive');
      
      document.getElementById(`target-${idx}`).appendChild(plane);
      drawingCanvas = canvas;
    }

    // === –û–±—Ä–æ–±–∫–∞ –º–∞–ª—é–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ Raycaster ===
    function handleDrawing(intersection) {
      if (!intersection || !drawingCanvas || !ctx) return;
      
      const uv = intersection.uv;
      if (!uv) return;
      
      const x = uv.x * drawingCanvas.width;
      const y = (1 - uv.y) * drawingCanvas.height; // –Ü–Ω–≤–µ—Ä—Ç—É—î–º–æ Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É
      
      if (isDrawing && lastIntersection) {
        const lastUV = lastIntersection.uv;
        const lastX = lastUV.x * drawingCanvas.width;
        const lastY = (1 - lastUV.y) * drawingCanvas.height;
        
        // –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—é
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç—É—Ä—É
        updateCanvasTexture();
      }
      
      lastIntersection = intersection;
    }

    function updateCanvasTexture() {
      const plane = document.querySelector('.draw-surface');
      if (plane && drawingCanvas) {
        plane.setAttribute('material', 'src', drawingCanvas.toDataURL());
      }
    }

    // === –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä–æ–º ===
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentColor = btn.dataset.color;
      });
    });

    // === –†–æ–∑–º—ñ—Ä –ø–µ–Ω–∑–ª—è ===
    document.getElementById('brushSize').addEventListener('input', e => {
      brushSize = Number(e.target.value);
      document.getElementById('brushValue').textContent = brushSize;
    });

    // === –ó—É–º ===
    function zoomIn()  { 
      scale = Math.min(3, scale + 0.25); 
      updateScale(); 
    }
    
    function zoomOut() { 
      scale = Math.max(0.6, scale - 0.25); 
      updateScale(); 
    }
    
    function updateScale() {
      const plane = document.querySelector('.draw-surface');
      if (!plane || !drawingCanvas) return;
      const baseW = 0.6;
      const baseH = (drawingCanvas.height / drawingCanvas.width) * 0.6;
      plane.setAttribute('width', baseW * scale);
      plane.setAttribute('height', baseH * scale);
    }

    // === –ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è ===
    function cleanup() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      resetAll();
    }

    // === –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ===
    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log('–°—Ü–µ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è...');
      createTargets();
      
      const scene = document.querySelector('a-scene');
      scene.addEventListener('targetFound', onTargetFound);
      scene.addEventListener('targetLost', onTargetLost);
      
      // ‚úÖ –û–±—Ä–æ–±–∫–∞ –º–∞–ª—é–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –ø–æ–¥—ñ—ó A-Frame
      scene.addEventListener('mousedown', (e) => {
        if (e.detail.intersectedEl && e.detail.intersectedEl.classList.contains('draw-surface')) {
          isDrawing = true;
          lastIntersection = e.detail.intersection;
          handleDrawing(e.detail.intersection);
        }
      });
      
      scene.addEventListener('mouseup', () => {
        isDrawing = false;
        lastIntersection = null;
      });
      
      scene.addEventListener('mousemove', (e) => {
        if (isDrawing && e.detail.intersectedEl && e.detail.intersectedEl.classList.contains('draw-surface')) {
          handleDrawing(e.detail.intersection);
        }
      });

      // –ó–∞–ø—É—Å–∫ AR –ø–æ –∫–ª—ñ–∫—É (–∑ –∞—É–¥—ñ–æ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∫–æ—é)
      document.body.addEventListener('click', () => {
        unlockAudio();
        startAR();
      }, { once: true });
      
      document.getElementById('hint').textContent = '–ì–æ—Ç–æ–≤–æ! –ù–∞—Ç–∏—Å–Ω–∏ –¥–ª—è –∑–∞–ø—É—Å–∫—É –∫–∞–º–µ—Ä–∏ üì±';
    });

    // –û–±—Ä–æ–±–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    window.addEventListener('beforeunload', cleanup);
    window.addEventListener('pagehide', cleanup);
  </script>
</body>
</html>
