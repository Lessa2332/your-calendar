<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Magic Coloring for My Star</title>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent !important;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    a-scene {
      position: fixed;
      inset: 0;
      background: transparent !important;
      pointer-events: none;
      z-index: 1;
    }
    
    #coloringCanvas {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      background: transparent;
      pointer-events: auto;
      display: none;
      border: 2px solid #ff1493;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(255, 20, 147, 0.5);
      max-width: min(90vw, 500px);
      max-height: min(70vh, 700px);
      cursor: crosshair;
    }
    
    #closeBtn {
      position: fixed;
      top: max(15px, env(safe-area-inset-top, 15px));
      right: 15px;
      width: 50px;
      height: 50px;
      background: #ff1493;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      font-weight: bold;
      z-index: 1002;
      box-shadow: 0 0 20px #ff1493;
      cursor: pointer;
      display: none;
    }
    
    .screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      z-index: 1001;
      text-align: center;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
    }
    
    #startScreen {
      background: radial-gradient(circle at center, rgba(255, 20, 147, 0.7), transparent);
    }
    
    button {
      background: #ff1493;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: clamp(18px, 4vw, 24px);
      cursor: pointer;
      box-shadow: 0 0 20px #ff1493;
      margin: 10px;
      transition: transform 0.3s;
      min-height: 50px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    #hintTextOnPuzzle {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      color: white;
      font-weight: bold;
      text-align: center;
      z-index: 1002;
      font-size: clamp(14px, 3.5vw, 20px);
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      display: none;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 10px;
    }
    
    #langBtn {
      position: fixed;
      top: max(15px, env(safe-area-inset-top, 15px));
      left: 15px;
      background: #ff1493;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: bold;
      z-index: 1002;
      box-shadow: 0 0 15px #ff1493;
      cursor: pointer;
      min-height: 40px;
    }
    
    #soundBtn {
      position: fixed;
      bottom: max(20px, env(safe-area-inset-bottom, 20px));
      right: 20px;
      background: rgba(255, 20, 147, 0.7);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      font-size: 20px;
      z-index: 1002;
      cursor: pointer;
      box-shadow: 0 0 15px #ff1493;
      min-width: 44px;
      min-height: 44px;
    }
    
    #etsyBtn {
      position: fixed;
      bottom: max(20px, env(safe-area-inset-bottom, 20px));
      left: 20px;
      background: #f16521;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1002;
      box-shadow: 0 0 15px #f16521;
      cursor: pointer;
      min-height: 40px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    
    #etsyBtn::before {
      content: "üõçÔ∏è";
      font-size: 16px;
    }
    
    #loadingIndicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: clamp(18px, 4vw, 22px);
      z-index: 1003;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 20px;
      border-radius: 15px;
      display: none;
    }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞ –ø–∞–ª—ñ—Ç—Ä–∞ –∫–æ–ª—å–æ—Ä—ñ–≤ */
    #colorPalette {
      position: fixed;
      bottom: 100px;
      left: 10px;
      right: 10px;
      display: none;
      z-index: 1002;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 25px;
      padding: 12px;
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    #colorPalette::-webkit-scrollbar {
      display: none;
    }
    
    .color-scroll-container {
      display: flex;
      gap: 8px;
      min-width: min-content;
    }
    
    .colorBtn {
      width: 40px;
      height: 40px;
      min-width: 40px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.2s;
    }

    .colorBtn:hover {
      transform: scale(1.1);
    }
    
    /* –°–ª–∞–π–¥–µ—Ä —Ç–æ–≤—â–∏–Ω–∏ –ø–µ–Ω–∑–ª—è */
    #brushSliderContainer {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 300px;
      display: none;
      z-index: 1002;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 15px;
      border-radius: 20px;
      text-align: center;
      color: white;
      font-weight: bold;
      font-size: clamp(14px, 3vw, 16px);
    }
    
    #brushSlider {
      width: 100%;
      margin-top: 8px;
      height: 8px;
      border-radius: 4px;
      background: #ddd;
      outline: none;
    }

    #brushSlider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ff1493;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    
    /* –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∞ */
    #screenshotBtn {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 50px;
      background: rgba(34, 139, 34, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      z-index: 1003;
      box-shadow: 0 0 15px rgba(34, 139, 34, 0.8);
      cursor: pointer;
      display: none;
      transition: transform 0.2s;
    }

    #screenshotBtn:hover {
      transform: translateX(-50%) scale(1.1);
    }
    
    /* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–∏–±—Ä–∞–Ω–æ–≥–æ –∫–æ–ª—å–æ—Ä—É */
    #currentColorIndicator {
      position: fixed;
      bottom: 165px;
      left: 50%;
      transform: translateX(-50%);
      width: 35px;
      height: 35px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      z-index: 1002;
      display: none;
    }
    
    h1 {
      font-size: clamp(24px, 8vw, 36px);
      margin: 10px 0;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
    }
    
    h2 {
      font-size: clamp(20px, 6vw, 28px);
      margin: 10px 0;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
    }
    
    p {
      font-size: clamp(14px, 4vw, 18px);
      margin: 8px 0;
      line-height: 1.4;
      max-width: 90%;
    }

    #imageLoading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      z-index: 1004;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 25px;
      border-radius: 15px;
      display: none;
    }

    .brush-size-text {
      font-size: clamp(12px, 3vw, 14px);
      margin-bottom: 5px;
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä */
    #progressBar {
      position: fixed;
      top: max(15px, env(safe-area-inset-top, 15px));
      right: 80px;
      background: rgba(255, 255, 255, 0.9);
      color: #ff1493;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1002;
      display: none;
    }

    /* –î–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—å –¥–ª—è –¥–µ–±–∞–≥ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó */
    .debug-info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: lime;
      padding: 5px;
      font-size: 12px;
      z-index: 1005;
      display: none;
    }
  </style>
</head>
<body>

  <canvas id="coloringCanvas"></canvas>
  <button id="closeBtn">‚úï</button>
  <div id="hintTextOnPuzzle"></div>
  <div id="loadingIndicator">Loading...</div>
  <div id="imageLoading">Loading image...</div>
  <div id="progressBar">0/12</div>
  <div id="debugInfo" class="debug-info"></div>

  <button id="langBtn">UA</button>
  <button id="soundBtn">üîà</button>
  <a href="https://smartlessa.etsy.com" target="_blank" id="etsyBtn">Our Store</a>

  <div id="currentColorIndicator"></div>
  <div id="colorPalette">
    <div class="color-scroll-container" id="colorScrollContainer"></div>
  </div>
  <div id="brushSliderContainer">
    <div class="brush-size-text" data-en="Brush Size" data-ua="–†–æ–∑–º—ñ—Ä –ø–µ–Ω–∑–ª—è">Brush Size</div>
    <input type="range" id="brushSlider" min="2" max="50" value="12">
  </div>
  <button id="screenshotBtn">üì∑</button>

  <div id="startScreen" class="screen">
    <h1 data-en="Magic Coloring" data-ua="–ú–∞–≥—ñ—á–Ω–∞ –†–æ–∑–º–∞–ª—å–æ–≤–∫–∞">Magic Coloring</h1>
    <p data-en="12 magical coloring pages for you" data-ua="12 —á–∞—Ä—ñ–≤–Ω–∏—Ö —Ä–æ–∑–º–∞–ª—å–æ–≤–æ–∫ –¥–ª—è —Ç–µ–±–µ">12 magical coloring pages for you</p>
    <button id="startBtn" data-en="START THE MAGIC!" data-ua="–ü–û–ß–ê–¢–ò –ú–ê–ì–Ü–Æ!">START THE MAGIC!</button>
  </div>

  <div id="hintScreen" class="screen" style="display:none">
    <h2 data-en="Find any picture from the calendar!" data-ua="–ó–Ω–∞–π–¥–∏ –±—É–¥—å-—è–∫—É –∫–∞—Ä—Ç–∏–Ω–∫—É –∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è!">
      Find any picture from the calendar!
    </h2>
    <p data-en="Show it to the camera ‚Äî and a coloring page will appear!" data-ua="–ü–æ–∫–∞–∂–∏ —ó—ó –∫–∞–º–µ—Ä—ñ ‚Äî —ñ –∑'—è–≤–∏—Ç—å—Å—è —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∞">
      Show it to the camera ‚Äî and a coloring page will appear!
    </p>
  </div>

  <audio id="bgMusic" loop preload="auto">
    <source src="fon/fon1.mp3" type="audio/mp3">
  </audio>

  <a-scene embedded
    mindar-image="imageTargetSrc: ./calendar.mind; filterMinCF:0.001; filterBeta:0.01; warmupTolerance:5; autoStart:false;"
    renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true; alpha:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    loading-screen="enabled:false"
    style="position:fixed;inset:0;background:transparent !important;">
    <a-camera active="false" mindar-image-target></a-camera>
  </a-scene>

  <script>
    console.log('üé® Magic Coloring –∑–∞–ø—É—â–µ–Ω–æ');

    const COLORING_PAGES = Array.from({length:12},(_,i)=>({
      id: i,
      image: `images/${String(i+1).padStart(2,'0')}.jpg`
    }));

    // 32 –∫–æ–ª—å–æ—Ä–∏
    const COLORS = [
      '#FF0000','#FFA500','#FFFF00','#008000','#0000FF','#4B0082','#EE82EE',
      '#FF69B4','#FF1493','#FFC0CB','#FFD700','#FF8C00','#FF4500','#A52A2A',
      '#8B4513','#D2691E','#CD853F','#F4A460','#DEB887','#DAA520','#B8860B',
      '#228B22','#32CD32','#00FF00','#00FA9A','#20B2AA','#48D1CC','#00CED1',
      '#5F9EA0','#4682B4','#6495ED','#00BFFF','#1E90FF','#4169E1','#0000CD'
    ].slice(0,32);

    let currentColoring = null;
    let currentMarkerId = null;
    let started = false;
    let isUA = false;
    let arSystem = null;
    let brushColor = COLORS[0];
    let brushSize = 12;
    let discoveredMarkers = new Set();

    const music = document.getElementById('bgMusic');
    music.volume = 0.3;
    let soundOn = false;

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ª–∞–¥–∫–∏
    function debugLog(message) {
      console.log('üîß ' + message);
      document.getElementById('debugInfo').textContent = message;
      document.getElementById('debugInfo').style.display = 'block';
      setTimeout(() => {
        document.getElementById('debugInfo').style.display = 'none';
      }, 3000);
    }

    function updateProgress() {
      const progress = discoveredMarkers.size;
      document.getElementById('progressBar').textContent = `${progress}/12`;
      if (progress > 0) {
        document.getElementById('progressBar').style.display = 'block';
      }
    }

    function saveDrawing(markerId) {
      if (!currentColoring) return;
      try {
        const dataURL = currentColoring.canvas.toDataURL('image/jpeg', 0.7);
        localStorage.setItem(`coloring-${markerId}`, dataURL);
        discoveredMarkers.add(markerId);
        updateProgress();
        debugLog('–ú–∞–ª—é–Ω–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ: ' + markerId);
      } catch (e) {
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', e);
      }
    }

    function playMusic() {
      if (soundOn && music.paused) {
        music.play().catch(e => {
          console.log('Audio play failed:', e);
        });
      }
    }

    function setLanguage(ua) {
      isUA = ua;
      document.querySelectorAll('[data-ua]').forEach(el => {
        if (el.dataset.ua && el.dataset.en) {
          el.textContent = ua ? el.dataset.ua : el.dataset.en;
        }
      });
      document.getElementById('langBtn').textContent = ua ? 'EN' : 'UA';
      document.getElementById('loadingIndicator').textContent = ua ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : 'Loading...';
      document.getElementById('imageLoading').textContent = ua ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...' : 'Loading image...';
      document.getElementById('etsyBtn').textContent = ua ? '–ù–∞—à –º–∞–≥–∞–∑–∏–Ω' : 'Our Store';
      document.getElementById('hintTextOnPuzzle').textContent = ua ?
        '–ú–∞–ª—é–π –ø–∞–ª—å—á–∏–∫–æ–º! –ó–±–µ—Ä—ñ–≥–∞–π üì∏' : 'Draw with your finger! Save üì∏';
    }

    function showMessage(text) {
      const hint = document.getElementById('hintTextOnPuzzle');
      hint.textContent = text;
      hint.style.display = 'block';
      setTimeout(() => hint.style.display = 'none', 2000);
    }

    function hideColoringUI() {
      document.getElementById('coloringCanvas').style.display = 'none';
      document.getElementById('colorPalette').style.display = 'none';
      document.getElementById('brushSliderContainer').style.display = 'none';
      document.getElementById('screenshotBtn').style.display = 'none';
      document.getElementById('closeBtn').style.display = 'none';
      document.getElementById('hintTextOnPuzzle').style.display = 'none';
      document.getElementById('currentColorIndicator').style.display = 'none';
      document.getElementById('imageLoading').style.display = 'none'; // –ö–†–ò–¢–ò–ß–ù–û: —Ö–æ–≤–∞—î–º–æ –ª–æ–∞–¥–µ—Ä
      debugLog('UI —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∏ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ');
    }

    class ColoringApp {
      constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.image = null;
        this.isDrawing = false;
        this.lastX = 0;
        this.lastY = 0;
        this.imageWidth = 0;
        this.imageHeight = 0;
        this.setupCanvas();
        this.setupEvents();
        debugLog('ColoringApp —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
      }

      setupCanvas() {
        // –°–ø–æ—á–∞—Ç–∫—É –Ω–µ–≤–µ–ª–∏–∫—ñ —Ä–æ–∑–º—ñ—Ä–∏
        this.canvas.width = 400;
        this.canvas.height = 500;
        this.canvas.style.width = '400px';
        this.canvas.style.height = '500px';
        
        // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è
        this.ctx.imageSmoothingEnabled = true;
        this.ctx.imageSmoothingQuality = 'high';
        this.ctx.globalCompositeOperation = 'source-over';
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        
        // –û—á–∏—â–∞—î–º–æ canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        debugLog('Canvas –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ');
      }

      setImage(img) {
        this.image = img;
        debugLog('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ' + img.width + 'x' + img.height);
        
        const maxWidth = Math.min(window.innerWidth * 0.8, 500);
        const maxHeight = Math.min(window.innerHeight * 0.7, 600);
        
        let width = img.width;
        let height = img.height;
        
        // –ú–∞—Å—à—Ç–∞–±—É—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        const scale = Math.min(maxWidth / width, maxHeight / height);
        width = width * scale;
        height = height * scale;
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ canvas
        this.canvas.width = width;
        this.canvas.height = height;
        this.canvas.style.width = width + 'px';
        this.canvas.style.height = height + 'px';
        
        this.imageWidth = width;
        this.imageHeight = height;
        
        this.redraw();
        debugLog('Canvas —Ä–æ–∑–º—ñ—Ä: ' + width + 'x' + height);
      }

      redraw() {
        if (!this.image) return;
        
        // –û—á–∏—â–∞—î–º–æ canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // –ú–∞–ª—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        this.ctx.drawImage(this.image, 0, 0, this.imageWidth, this.imageHeight);
        debugLog('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–º–∞–ª—å–æ–≤–∞–Ω–æ');
      }

      setupEvents() {
        const getCoords = (e) => {
          const rect = this.canvas.getBoundingClientRect();
          let clientX, clientY;
          
          if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }
          
          const x = clientX - rect.left;
          const y = clientY - rect.top;
          
          return { x, y };
        };

        const startDrawing = (e) => {
          debugLog('–ü–æ—á–∞—Ç–æ–∫ –º–∞–ª—é–≤–∞–Ω–Ω—è');
          this.isDrawing = true;
          const coords = getCoords(e);
          this.lastX = coords.x;
          this.lastY = coords.y;
          
          // –ü–æ—á–∏–Ω–∞—î–º–æ –Ω–æ–≤–∏–π —à–ª—è—Ö
          this.ctx.beginPath();
          this.ctx.moveTo(this.lastX, this.lastY);
          
          if (e.type.includes('touch')) {
            e.preventDefault();
          }
        };

        const draw = (e) => {
          if (!this.isDrawing) return;
          
          const coords = getCoords(e);
          const currentX = coords.x;
          const currentY = coords.y;
          
          // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –ø–µ–Ω–∑–µ–ª—å
          this.ctx.lineWidth = brushSize;
          this.ctx.strokeStyle = brushColor;
          
          // –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—é
          this.ctx.lineTo(currentX, currentY);
          this.ctx.stroke();
          
          this.lastX = currentX;
          this.lastY = currentY;
          
          if (e.type.includes('touch')) {
            e.preventDefault();
          }
        };

        const stopDrawing = () => {
          debugLog('–ö—ñ–Ω–µ—Ü—å –º–∞–ª—é–≤–∞–Ω–Ω—è');
          this.isDrawing = false;
          this.ctx.beginPath(); // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —à–ª—è—Ö
        };

        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
        this.canvas.addEventListener('mousedown', startDrawing);
        this.canvas.addEventListener('mousemove', draw);
        this.canvas.addEventListener('mouseup', stopDrawing);
        this.canvas.addEventListener('mouseleave', stopDrawing);
        
        this.canvas.addEventListener('touchstart', startDrawing, { passive: false });
        this.canvas.addEventListener('touchmove', draw, { passive: false });
        this.canvas.addEventListener('touchend', stopDrawing);
        this.canvas.addEventListener('touchcancel', stopDrawing);
        
        debugLog('–ü–æ–¥—ñ—ó –º–∞–ª—é–≤–∞–Ω–Ω—è –¥–æ–¥–∞–Ω–æ');
      }
    }

    function initUI() {
      const colorContainer = document.getElementById('colorScrollContainer');
      colorContainer.innerHTML = '';
      
      COLORS.forEach((c, index) => {
        const btn = document.createElement('button');
        btn.className = 'colorBtn';
        btn.style.background = c;
        btn.onclick = () => { 
          brushColor = c;
          document.getElementById('currentColorIndicator').style.background = c;
          debugLog('–û–±—Ä–∞–Ω–æ –∫–æ–ª—ñ—Ä: ' + c);
        };
        colorContainer.appendChild(btn);
      });
      
      document.getElementById('currentColorIndicator').style.background = brushColor;

      document.getElementById('brushSlider').oninput = (e) => {
        brushSize = parseInt(e.target.value);
        debugLog('–†–æ–∑–º—ñ—Ä –ø–µ–Ω–∑–ª—è: ' + brushSize);
      };

      document.getElementById('langBtn').onclick = () => setLanguage(!isUA);
      
      document.getElementById('soundBtn').onclick = () => {
        soundOn = !soundOn;
        if (soundOn) {
          playMusic();
          document.getElementById('soundBtn').textContent = 'üîä';
        } else {
          music.pause();
          document.getElementById('soundBtn').textContent = 'üîà';
        }
        debugLog('–ó–≤—É–∫: ' + (soundOn ? 'ON' : 'OFF'));
      };

      document.getElementById('screenshotBtn').onclick = () => {
        if (!currentColoring) return;
        
        const link = document.createElement('a');
        link.download = `magic-coloring-${currentMarkerId + 1}.png`;
        link.href = currentColoring.canvas.toDataURL('image/png');
        link.click();
        
        showMessage(isUA ? 'üì∏ –ó–Ω—ñ–º–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!' : 'üì∏ Screenshot saved!');
        saveDrawing(currentMarkerId);
      };

      document.getElementById('closeBtn').onclick = () => {
        debugLog('–ó–∞–∫—Ä–∏—Ç—Ç—è —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∏');
        if (currentColoring) {
          saveDrawing(currentMarkerId);
        }
        
        hideColoringUI();
        currentColoring = null;
        currentMarkerId = null;
        screens.show('hint');
      };
    }

    const screens = {
      show(name) {
        ['start','hint'].forEach(s => {
          const el = document.getElementById(s + 'Screen');
          if (el) el.style.display = (name === s) ? 'flex' : 'none';
        });
        document.getElementById('loadingIndicator').style.display = (name === 'loading') ? 'block' : 'none';
      }
    };

    document.getElementById('startBtn').onclick = async () => {
      if (started) return;
      started = true;
      screens.show('loading');
      debugLog('–°—Ç–∞—Ä—Ç AR...');
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment" } 
        });
        
        stream.getTracks().forEach(track => track.stop());
        
        arSystem = document.querySelector('a-scene').systems['mindar-image-system'];
        if (arSystem) {
          arSystem.start();
          screens.show('hint');
          playMusic();
          debugLog('AR –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
        } else {
          throw new Error('AR system not found');
        }
      } catch (e) {
        console.error('Camera error:', e);
        alert(isUA ? "–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏!" : "Allow camera access!");
        started = false;
        screens.show('start');
        debugLog('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: ' + e.message);
      }
    };

    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log('‚úÖ AR –≥–æ—Ç–æ–≤–∏–π');
      debugLog('AR —Å—Ü–µ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
      
      initUI();
      
      COLORING_PAGES.forEach(cfg => {
        const entity = document.createElement('a-entity');
        entity.setAttribute('mindar-image-target', `targetIndex: ${cfg.id}`);
        
        entity.addEventListener('targetFound', async () => {
          if (currentMarkerId === cfg.id) return;
          if (currentColoring) return;

          debugLog('–ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ: ' + cfg.id);
          currentMarkerId = cfg.id;

          try {
            document.getElementById('imageLoading').style.display = 'block';
            debugLog('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...');

            const img = new Image();
            
            await new Promise((resolve, reject) => {
              img.onload = () => {
                debugLog('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
                resolve();
              };
              img.onerror = () => {
                debugLog('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è');
                reject(new Error('Failed to load image'));
              };
              img.src = cfg.image + '?v=' + Date.now();
            });

            document.getElementById('imageLoading').style.display = 'none';
            debugLog('–õ–æ–∞–¥–µ—Ä –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ');

            currentColoring = new ColoringApp('coloringCanvas');
            currentColoring.setImage(img);

            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–µ
            const saved = localStorage.getItem(`coloring-${cfg.id}`);
            if (saved) {
              const savedImg = new Image();
              savedImg.onload = () => {
                currentColoring.ctx.drawImage(savedImg, 0, 0);
                debugLog('–ó–±–µ—Ä–µ–∂–µ–Ω–∏–π –º–∞–ª—é–Ω–æ–∫ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ');
              };
              savedImg.src = saved;
            }

            // –ü–æ–∫–∞–∑—É—î–º–æ UI
            document.getElementById('coloringCanvas').style.display = 'block';
            document.getElementById('colorPalette').style.display = 'block';
            document.getElementById('brushSliderContainer').style.display = 'block';
            document.getElementById('screenshotBtn').style.display = 'block';
            document.getElementById('closeBtn').style.display = 'block';
            document.getElementById('hintTextOnPuzzle').style.display = 'block';
            document.getElementById('currentColorIndicator').style.display = 'block';
            
            showMessage(isUA ? 
              '–ú–∞–ª—é–π –ø–∞–ª—å—á–∏–∫–æ–º! –ó–±–µ—Ä—ñ–≥–∞–π üì∏' : 
              'Draw with your finger! Save üì∏'
            );
            
            debugLog('UI —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∏ –ø–æ–∫–∞–∑–∞–Ω–æ');
            
          } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:', error);
            document.getElementById('imageLoading').style.display = 'none';
            showMessage(isUA ? 
              '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è' : 
              'Error loading image'
            );
            debugLog('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
          }
        });

        entity.addEventListener('targetLost', () => {
          if (currentMarkerId === cfg.id) {
            debugLog('–ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ: ' + cfg.id);
            if (currentColoring) {
              saveDrawing(currentMarkerId);
            }
            hideColoringUI();
            currentColoring = null;
            currentMarkerId = null;
          }
        });

        document.querySelector('a-scene').appendChild(entity);
      });
      
      setLanguage(false);
      screens.show('start');
    });

    music.addEventListener('error', (e) => {
      console.log('Audio load error:', e);
      document.getElementById('soundBtn').style.display = 'none';
      debugLog('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—É–¥—ñ–æ');
    });

    // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
    window.addEventListener('load', () => {
      for (let i = 0; i < 12; i++) {
        if (localStorage.getItem(`coloring-${i}`)) {
          discoveredMarkers.add(i);
        }
      }
      updateProgress();
      debugLog('–î–æ–¥–∞—Ç–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
    });
  </script>
</body>
</html>
