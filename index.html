<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Магічне розфарбовування</title>

  <!-- РОБОЧА комбінація 2025 року (без eval, без CORB) -->
  <script src="https://cdn.jsdelivr.net +.npm/aframe@1.6.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mindar-image-aframe@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body, html { margin:0; height:100%; overflow:hidden; background:#000; font-family:'Comic Sans MS',cursive,sans-serif; }
    #hint { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#ff1493; color:#fff; padding:16px 32px; border-radius:50px; font-size:24px; z-index:999; box-shadow:0 0 30px #ff1493; text-align:center; }
    .controls { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; gap:15px; z-index:1000; background:rgba(0,0,0,0.7); padding:15px; border-radius:30px; }
    .color-btn { width:44px; height:44px; border-radius:50%; border:4px solid transparent; cursor:pointer; transition:border 0.2s; }
    .color-btn.active { border:4px solid white; transform:scale(1.2); }
    input[type="range"] { width:120px; }
    .zoom-btn { width:50px; height:50px; border-radius:50%; background:#fff; color:#000; font-size:28px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
  </style>
</head>
<body>

<div id="hint">Натисни екран → покажи маркер → малюй!</div>

<div class="controls">
  <div class="colors">
    <div class="color-btn" style="background:#ff6961" data-color="#ff6961"></div>
    <div class="color-btn" style="background:#fdfd96" data-color="#fdfd96"></div>
    <div class="color-btn" style="background:#77dd77" data-color="#77dd77"></div>
    <div class="color-btn" style="background:#84b6f4" data-color="#84b6f4"></div>
    <div class="color-btn" style="background:#fdcae1" data-color="#fdcae1"></div>
    <div class="color-btn" style="background:#cbaacb" data-color="#cbaacb"></div>
    <div class="color-btn" style="background:#ff9ff3" data-color="#ff9ff3"></div>
    <div class="color-btn" style="background:#feca57" data-color="#feca57"></div>
    <div class="color-btn" style="background:#2d3436" data-color="#2d3436"></div>
  </div>
  <input type="range" id="brushSize" min="3" max="40" value="12">
  <div class="zoom-btn" onclick="zoomIn()">+</div>
  <div class="zoom-btn" onclick="zoomOut()">–</div>
</div>

<a-scene
  embedded
  mindar-image="imageTargetSrc: ./calendar.mind; autoStart:false; uiLoading:no; uiError:no; uiScanning:no; filterMinCF:0.0001; filterBeta:1000"
  renderer="colorManagement:true"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false">
  <a-camera></a-camera>
  <a-entity id="drawing-container"></a-entity>
</a-scene>

<script>
let currentColor = '#ff6961';
let brushSize = 12;
let scale = 1;
let drawingCanvas = null;
let ctx = null;
let activeTargetIndex = null;
let audio = null;

// Створення 12 цілей
function createTargets() {
  const container = document.getElementById('drawing-container');
  for (let i = 0; i < 12; i++) {
    const target = document.createElement('a-entity');
    target.setAttribute('mindar-image-target', { targetIndex: i });
    target.id = `target-${i}`;
    container.appendChild(target);
  }
}

function startAR() {
  const scene = document.querySelector('a-scene');
  const mindarSystem = scene.systems['mindar-image-system'];  // правильна назва в новій версії
  if (mindarSystem) mindarSystem.start();
  document.getElementById('hint').style.display = 'none';
}

async function onTargetFound(e) {
  const idx = e.detail.targetIndex;
  if (activeTargetIndex === idx) return;
  resetAll();
  activeTargetIndex = idx;
  await loadImageAndSound(idx);
}

function onTargetLost() {
  resetAll();
}

function resetAll() {
  if (audio) { audio.pause(); audio = null; }
  document.querySelectorAll('.draw-surface').forEach(el => el.remove());
  drawingCanvas = ctx = null;
  scale = 1;
  activeTargetIndex = null;
}

async function loadImageAndSound(idx) {
  const img = new Image();
  img.src = `./images/${String(idx + 1).padStart(2, '0')}.jpg?t=${Date.now()}`;
  await img.decode();

  // Звук
  try {
    audio = new Audio(`./fon/fon${idx + 1}.mp3`);
    audio.loop = true;
    audio.play();
  } catch(e) { console.log("Немає звуку або не вдалося відтворити"); }

  createCanvas(img, idx);
}

function createCanvas(img, idx) {
  const canvas = document.createElement('canvas');
  canvas.width = img.width;
  canvas.height = img.height;
  const context = canvas.getContext('2d');
  context.drawImageелі(img, 0, 0);

  const plane = document.createElement('a-plane');
  plane.className = 'draw-surface';
  plane.setAttribute('position', '0 0 0.01');
  plane.setAttribute('width', 0.6);
  plane.setAttribute('height', (img.height/img.width)*0.6);
  plane.setAttribute('material', 'src', canvas.toDataURL());

  document.getElementById(`target-${idx}`).appendChild(plane);

  drawingCanvas = canvas;
  ctx = context;

  // Події малювання (підтримка миші + тач)
  const drawEvents = {
    mousedown: startDrawing,
    mouseup: stopDrawing,
    mousemove: draw,
    touchstart: e => { e.preventDefault(); startDrawing(e); },
    touchend: stopDrawing,
    touchmove: e => { e.preventDefault(); draw(e); }
  };
  Object.entries(drawEvents).forEach(([ev, fn]) => plane.addEventListener(ev, fn));
}

function getCoords(e) {
  const plane = document.querySelector('.draw-surface');
  if (!plane) return null;
  const rect = plane.getBoundingClientRect();
  const x = (e.clientX || e.touches[0].clientX) - rect.left;
  const y = (e.clientY || e.touches[0].clientY) - rect.top;
  return {
    x: (x / rect.width) * drawingCanvas.width,
    y: (y / rect.height) * drawingCanvas.height
  };
}

let isDrawing = false;
let lastX, lastY;

function startDrawing(e) {
  isDrawing = true;
  const pos = getCoords(e);
  if (pos) [lastX, lastY] = [pos.x, pos.y];
}

function stopDrawing() {
  isDrawing = false;
}

function draw(e) {
  if (!isDrawing || !ctx) return;
  const pos = getCoords(e);
  if (!pos) return;

  ctx.globalCompositeOperation = 'source-over';
  ctx.strokeStyle = currentColor;
  ctx.lineWidth = brushSize;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();

  document.querySelector('.draw-surface').setAttribute('material', 'src', drawingCanvas.toDataURL());
  [lastX, lastY] = [pos.x, pos.y];
}

// Кольори
document.querySelectorAll('.color-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentColor = btn.dataset.color;
  });
});
document.querySelector('.color-btn').classList.add('active');

// Розмір пензля
document.getElementById('brushSize').addEventListener('input', e => {
  brushSize = e.target.value;
});

// Зум
function zoomIn()  { scale = Math.min(2.5, scale + 0.2); updateScale(); }
function zoomOut() { scale = Math.max(0.6, scale - 0.2); updateScale(); }
function updateScale() {
  const plane = document.querySelector('.draw-surface');
  if (plane && drawingCanvas) {
    const baseW = 0.6;
    const baseH = (drawingCanvas.height/drawingCanvas.width)*0.6;
    plane.setAttribute('width', baseW * scale);
    plane.setAttribute('height', baseH * scale);
  }
}

// Запуск
document.querySelector('a-scene').addEventListener('loaded', () => {
  createTargets();
  const scene = document.querySelector('a-scene');
  scene.addEventListener('targetFound', onTargetFound);
  scene.addEventListener('targetLost', onTargetLost);
  document.body.addEventListener('click', startAR, { once: true });
});
</script>
</body>
</html>
