<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Magic Coloring for My Star</title>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent !important;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    a-scene {
      position: fixed;
      inset: 0;
      background: transparent !important;
      pointer-events: none;
      z-index: 1;
    }
    
    #coloringCanvas {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: transparent;
      pointer-events: auto;
      display: none;
    }
    
    #closeBtn {
      position: fixed;
      top: max(15px, env(safe-area-inset-top, 15px));
      right: 15px;
      width: 50px;
      height: 50px;
      background: #ff1493;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      font-weight: bold;
      z-index: 1002;
      box-shadow: 0 0 20px #ff1493;
      cursor: pointer;
      display: none;
    }
    
    .screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      z-index: 1001;
      text-align: center;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
    }
    
    #startScreen {
      background: radial-gradient(circle at center, rgba(255, 20, 147, 0.7), transparent);
    }
    
    button {
      background: #ff1493;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: clamp(18px, 4vw, 24px);
      cursor: pointer;
      box-shadow: 0 0 20px #ff1493;
      margin: 10px;
      transition: transform 0.3s;
      min-height: 50px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    #hintTextOnPuzzle {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      color: white;
      font-weight: bold;
      text-align: center;
      z-index: 1002;
      font-size: clamp(14px, 3.5vw, 20px);
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      display: none;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 10px;
    }
    
    #langBtn {
      position: fixed;
      top: max(15px, env(safe-area-inset-top, 15px));
      left: 15px;
      background: #ff1493;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: bold;
      z-index: 1002;
      box-shadow: 0 0 15px #ff1493;
      cursor: pointer;
      min-height: 40px;
    }
    
    #soundBtn {
      position: fixed;
      bottom: max(20px, env(safe-area-inset-bottom, 20px));
      right: 20px;
      background: rgba(255, 20, 147, 0.7);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      font-size: 20px;
      z-index: 1002;
      cursor: pointer;
      box-shadow: 0 0 15px #ff1493;
      min-width: 44px;
      min-height: 44px;
    }
    
    #etsyBtn {
      position: fixed;
      bottom: max(20px, env(safe-area-inset-bottom, 20px));
      left: 20px;
      background: #f16521;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1002;
      box-shadow: 0 0 15px #f16521;
      cursor: pointer;
      min-height: 40px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    
    #etsyBtn::before {
      content: "üõçÔ∏è";
      font-size: 16px;
    }
    
    #loadingIndicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: clamp(18px, 4vw, 22px);
      z-index: 1003;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 20px;
      border-radius: 15px;
      display: none;
    }
    
    .store-link {
      background: #f16521;
      color: white;
      text-decoration: none;
      padding: 12px 25px;
      border-radius: 50px;
      font-size: clamp(16px, 3.5vw, 18px);
      margin: 8px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 0 20px #f16521;
      transition: transform 0.3s;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    
    .store-link:hover {
      transform: scale(1.05);
    }
    
    .store-link::before {
      content: "üõçÔ∏è";
      font-size: 18px;
    }
    
    .store-text {
      font-size: clamp(14px, 3.5vw, 16px);
      margin: 10px 0;
      opacity: 0.9;
      text-align: center;
      max-width: 90%;
    }
    
    /* –ü–∞–ª—ñ—Ç—Ä–∞ ‚Äî 32 –∫–æ–ª—å–æ—Ä–∏ */
    #colorPalette {
      position: fixed;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 1002;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      max-width: 95%;
      padding: 8px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 20px;
    }
    
    .colorBtn {
      width: clamp(30px, 8vw, 40px);
      height: clamp(30px, 8vw, 40px);
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      cursor: pointer;
    }
    
    /* –°–ª–∞–π–¥–µ—Ä —Ç–æ–≤—â–∏–Ω–∏ –ø–µ–Ω–∑–ª—è */
    #brushSliderContainer {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 350px;
      display: none;
      z-index: 1002;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 15px;
      text-align: center;
      color: white;
      font-weight: bold;
      font-size: clamp(14px, 3.5vw, 16px);
    }
    
    #brushSlider {
      width: 100%;
      margin-top: 5px;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∞ */
    #screenshotBtn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 50px;
      background: rgba(34, 139, 34, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      z-index: 1003;
      box-shadow: 0 0 15px rgba(34, 139, 34, 0.6);
      cursor: pointer;
      display: none;
    }
    
    h1 {
      font-size: clamp(24px, 8vw, 36px);
      margin: 10px 0;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
    }
    
    h2 {
      font-size: clamp(20px, 6vw, 28px);
      margin: 10px 0;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
    }
    
    p {
      font-size: clamp(14px, 4vw, 18px);
      margin: 8px 0;
      line-height: 1.4;
      max-width: 90%;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
    @media (max-height: 600px) {
      #colorPalette {
        bottom: 120px;
        gap: 4px;
      }
      
      #brushSliderContainer {
        bottom: 80px;
      }
      
      .colorBtn {
        width: 28px;
        height: 28px;
      }
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ—ó –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—ó */
    @media (max-height: 500px) and (orientation: landscape) {
      .screen {
        padding: 10px;
        justify-content: flex-start;
        overflow-y: auto;
      }
      
      #colorPalette {
        bottom: 100px;
      }
      
      #brushSliderContainer {
        bottom: 60px;
      }
      
      #screenshotBtn {
        bottom: 10px;
      }
    }
    
    /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ */
    @media (min-width: 768px) {
      .colorBtn {
        width: 44px;
        height: 44px;
      }
      
      button {
        padding: 18px 35px;
        font-size: 20px;
      }
      
      .store-link {
        padding: 15px 30px;
        font-size: 18px;
      }
    }
  </style>
</head>
<body>

  <canvas id="coloringCanvas"></canvas>
  <button id="closeBtn">‚úï</button>
  <div id="hintTextOnPuzzle"></div>
  <div id="loadingIndicator">Loading...</div>

  <button id="langBtn">UA</button>
  <button id="soundBtn">üîà</button>
  <a href="https://smartlessa.etsy.com" target="_blank" id="etsyBtn" style="display:none">Our Store</a>

  <div id="colorPalette"></div>
  <div id="brushSliderContainer">
    <div data-en="Brush Size" data-ua="–¢–æ–≤—â–∏–Ω–∞ –ø–µ–Ω–∑–ª—è">Brush Size</div>
    <input type="range" id="brushSlider" min="2" max="50" value="12">
  </div>
  <button id="screenshotBtn">üì∑</button>

  <div id="startScreen" class="screen">
    <h1 data-en="Magic Coloring" data-ua="–ú–∞–≥—ñ—á–Ω–∞ –†–æ–∑–º–∞–ª—å–æ–≤–∫–∞">Magic Coloring</h1>
    <p data-en="12 magical coloring pages for you" data-ua="12 —á–∞—Ä—ñ–≤–Ω–∏—Ö —Ä–æ–∑–º–∞–ª—å–æ–≤–æ–∫ –¥–ª—è —Ç–µ–±–µ">12 magical coloring pages for you</p>
    <button id="startBtn" data-en="START THE MAGIC!" data-ua="–ü–û–ß–ê–¢–ò –ú–ê–ì–Ü–Æ!">START THE MAGIC!</button>
    
    <p class="store-text" data-en="Get your own magical calendar!" data-ua="–û—Ç—Ä–∏–º–∞–π —Å–≤—ñ–π —á–∞—Ä—ñ–≤–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä!">
      Get your own magical calendar!
    </p>
    <a href="https://smartlessa.etsy.com" target="_blank" class="store-link" data-en="Visit Our Etsy Store" data-ua="–ù–∞—à –º–∞–≥–∞–∑–∏–Ω Etsy">
      Visit Our Etsy Store
    </a>
  </div>

  <div id="hintScreen" class="screen" style="display:none">
    <h2 data-en="Find any picture from the calendar!" data-ua="–ó–Ω–∞–π–¥–∏ –±—É–¥—å-—è–∫—É –∫–∞—Ä—Ç–∏–Ω–∫—É –∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è!">
      Find any picture from the calendar!
    </h2>
    <p data-en="Show it to the camera ‚Äî<br>and a coloring page will appear!" data-ua="–ü–æ–∫–∞–∂–∏ —ó—ó –∫–∞–º–µ—Ä—ñ ‚Äî<br>—ñ –∑'—è–≤–∏—Ç—å—Å—è —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∞">
      Show it to the camera ‚Äî<br>and a coloring page will appear!
    </p>
    
    <p class="store-text" data-en="Love this experience? Get the full calendar!" data-ua="–°–ø–æ–¥–æ–±–∞–ª–æ—Å—å? –û—Ç—Ä–∏–º–∞–π –ø–æ–≤–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä!">
      Love this experience? Get the full calendar!
    </p>
    <a href="https://smartlessa.etsy.com" target="_blank" class="store-link" data-en="Get Yours Now" data-ua="–ó–∞–º–æ–≤–∏—Ç–∏ –∑–∞—Ä–∞–∑">
      Get Yours Now
    </a>
  </div>

  <audio id="bgMusic" loop preload="auto">
    <source src="fon/fon1.mp3" type="audio/mp3">
  </audio>

  <a-scene embedded
    mindar-image="imageTargetSrc: ./calendar.mind; filterMinCF:0.001; filterBeta:0.01; warmupTolerance:5; autoStart:false;"
    renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true; alpha:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    loading-screen="enabled:false"
    style="position:fixed;inset:0;background:transparent !important;">
    <a-camera active="false" mindar-image-target></a-camera>
  </a-scene>

  <script>
    console.log('üé® Magic Coloring –∑–∞–ø—É—â–µ–Ω–æ');

    const COLORING_PAGES = Array.from({length:12},(_,i)=>({
      id: i,
      image: `images/${String(i+1).padStart(2,'0')}.jpg`
    }));

    // 32 –∫–æ–ª—å–æ—Ä–∏ ‚Äî —è—Å–∫—Ä–∞–≤—ñ, –¥–∏—Ç—è—á—ñ
    const COLORS = [
      '#FF0000','#FFA500','#FFFF00','#008000','#0000FF','#4B0082','#EE82EE',
      '#FF69B4','#FF1493','#FFC0CB','#FFD700','#FF8C00','#FF4500','#A52A2A',
      '#8B4513','#D2691E','#CD853F','#F4A460','#DEB887','#DAA520','#B8860B',
      '#228B22','#32CD32','#00FF00','#00FA9A','#20B2AA','#48D1CC','#00CED1',
      '#5F9EA0','#4682B4','#6495ED','#00BFFF','#1E90FF','#4169E1','#0000CD'
    ].slice(0,32);

    let currentColoring = null;
    let currentMarkerId = null;
    let started = false;
    let isUA = false;
    let arSystem = null;
    let brushColor = COLORS[0];
    let brushSize = 12;

    const music = document.getElementById('bgMusic');
    music.volume = 0.3;
    let soundOn = false;

    function playMusic() {
      if (soundOn && music.paused) {
        music.play().catch(e => {
          console.log('Audio play failed:', e);
        });
      }
    }

    function setLanguage(ua) {
      isUA = ua;
      document.querySelectorAll('[data-ua]').forEach(el => {
        if (el.dataset.ua && el.dataset.en) {
          el.textContent = ua ? el.dataset.ua : el.dataset.en;
        }
      });
      document.getElementById('langBtn').textContent = ua ? 'EN' : 'UA';
      document.getElementById('loadingIndicator').textContent = ua ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : 'Loading...';
      document.getElementById('etsyBtn').textContent = ua ? '–ù–∞—à –º–∞–≥–∞–∑–∏–Ω' : 'Our Store';
      document.getElementById('hintTextOnPuzzle').textContent = ua ?
        '–ú–∞–ª—é–π –ø–∞–ª—å—á–∏–∫–æ–º! –ó–±–µ—Ä—ñ–≥–∞–π üì∏' : 'Draw with your finger! Save üì∏';
    }

    function showMessage(text) {
      const hint = document.getElementById('hintTextOnPuzzle');
      hint.textContent = text;
      hint.style.display = 'block';
      setTimeout(() => hint.style.display = 'none', 2000);
    }

    function saveDrawing(markerId) {
      if (!currentColoring) return;
      try {
        localStorage.setItem(`coloring-${markerId}`, currentColoring.canvas.toDataURL());
      } catch (e) {
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', e);
      }
    }

    class ColoringApp {
      constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d', { alpha: true });
        this.image = null;
        this.isDrawing = false;
        this.lastX = 0;
        this.lastY = 0;
        this.setupCanvas();
        this.setupEvents();
      }

      setupCanvas() {
        const updateSize = () => {
          const w = window.innerWidth;
          const h = window.innerHeight;
          const dpr = Math.min(window.devicePixelRatio || 1, 2);
          this.canvas.width = w * dpr;
          this.canvas.height = h * dpr;
          this.canvas.style.width = w + 'px';
          this.canvas.style.height = h + 'px';
          this.ctx.scale(dpr, dpr);
          this.redraw();
        };
        updateSize();
        window.addEventListener('resize', updateSize);
      }

      setImage(img) {
        this.image = img;
        this.redraw();
      }

      redraw() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        if (this.image) {
          const imgAspect = this.image.width / this.image.height;
          const maxW = w * 0.9;
          const maxH = h * 0.85;
          let drawW = maxW, drawH = maxW / imgAspect;
          if (imgAspect < maxW / maxH) {
            drawH = maxH;
            drawW = maxH * imgAspect;
          }
          const x = (w - drawW) / 2;
          const y = (h - drawH) / 2;
          this.ctx.drawImage(this.image, x, y, drawW, drawH);
        }
      }

      setupEvents() {
        const getCoords = (e) => {
          const rect = this.canvas.getBoundingClientRect();
          const scaleX = this.canvas.width / rect.width;
          const scaleY = this.canvas.height / rect.height;
          
          let clientX, clientY;
          if (e.touches) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }
          
          return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
          };
        };

        const start = (e) => {
          this.isDrawing = true;
          const coords = getCoords(e);
          this.lastX = coords.x;
          this.lastY = coords.y;
          
          // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ —Å–∫—Ä–æ–ª—É –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö
          if (e.type.includes('touch')) {
            e.preventDefault();
          }
        };

        const draw = (e) => {
          if (!this.isDrawing) return;
          
          const coords = getCoords(e);
          const currentX = coords.x;
          const currentY = coords.y;
          
          this.ctx.beginPath();
          this.ctx.moveTo(this.lastX, this.lastY);
          this.ctx.lineTo(currentX, currentY);
          this.ctx.strokeStyle = brushColor;
          this.ctx.lineWidth = brushSize;
          this.ctx.lineCap = 'round';
          this.ctx.lineJoin = 'round';
          this.ctx.stroke();
          
          this.lastX = currentX;
          this.lastY = currentY;
          
          // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ —Å–∫—Ä–æ–ª—É –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö
          if (e.type.includes('touch')) {
            e.preventDefault();
          }
        };

        const stop = () => {
          this.isDrawing = false;
        };

        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
        this.canvas.addEventListener('mousedown', start);
        this.canvas.addEventListener('mousemove', draw);
        this.canvas.addEventListener('mouseup', stop);
        this.canvas.addEventListener('mouseout', stop);
        
        this.canvas.addEventListener('touchstart', start, { passive: false });
        this.canvas.addEventListener('touchmove', draw, { passive: false });
        this.canvas.addEventListener('touchend', stop);
        this.canvas.addEventListener('touchcancel', stop);
      }
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è UI
    function initUI() {
      const palette = document.getElementById('colorPalette');
      palette.innerHTML = '';
      
      COLORS.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'colorBtn';
        btn.style.background = c;
        btn.onclick = () => { 
          brushColor = c; 
          // –î–æ–¥–∞—î–º–æ –≤—ñ–∑—É–∞–ª—å–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–∏–±—Ä–∞–Ω–æ–≥–æ –∫–æ–ª—å–æ—Ä—É
          document.querySelectorAll('.colorBtn').forEach(b => {
            b.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.3)';
          });
          btn.style.boxShadow = '0 0 0 3px white, 0 0 10px ' + c;
        };
        palette.appendChild(btn);
      });
      
      // –í–∏–±–∏—Ä–∞—î–º–æ –ø–µ—Ä—à–∏–π –∫–æ–ª—ñ—Ä –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
      if (palette.firstChild) {
        palette.firstChild.style.boxShadow = '0 0 0 3px white, 0 0 10px ' + COLORS[0];
      }

      document.getElementById('brushSlider').oninput = (e) => {
        brushSize = parseInt(e.target.value);
      };

      document.getElementById('langBtn').onclick = () => setLanguage(!isUA);
      
      document.getElementById('soundBtn').onclick = () => {
        soundOn = !soundOn;
        if (soundOn) {
          playMusic();
          document.getElementById('soundBtn').textContent = 'üîä';
        } else {
          music.pause();
          document.getElementById('soundBtn').textContent = 'üîà';
        }
      };

      document.getElementById('screenshotBtn').onclick = () => {
        if (!currentColoring) return;
        
        const link = document.createElement('a');
        link.download = `magic-coloring-${currentMarkerId + 1}.png`;
        link.href = currentColoring.canvas.toDataURL('image/png');
        link.click();
        showMessage(isUA ? 'üì∏ –ó–Ω—ñ–º–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!' : 'üì∏ Screenshot saved!');
        saveDrawing(currentMarkerId);
      };

      document.getElementById('closeBtn').onclick = () => {
        if (currentColoring) {
          saveDrawing(currentMarkerId);
        }
        
        // –•–æ–≤–∞—î–º–æ UI —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∏
        document.getElementById('coloringCanvas').style.display = 'none';
        document.getElementById('colorPalette').style.display = 'none';
        document.getElementById('brushSliderContainer').style.display = 'none';
        document.getElementById('screenshotBtn').style.display = 'none';
        document.getElementById('closeBtn').style.display = 'none';
        document.getElementById('hintTextOnPuzzle').style.display = 'none';
        
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –ø–æ—à—É–∫—É –º–∞—Ä–∫–µ—Ä–∞
        currentColoring = null;
        currentMarkerId = null;
        screens.show('hint');
      };
    }

    const screens = {
      show(name) {
        ['start','hint'].forEach(s => {
          const el = document.getElementById(s + 'Screen');
          if (el) el.style.display = (name === s) ? 'flex' : 'none';
        });
        document.getElementById('etsyBtn').style.display = (name !== 'puzzle') ? 'flex' : 'none';
        document.getElementById('loadingIndicator').style.display = (name === 'loading') ? 'block' : 'none';
      }
    };

    document.getElementById('startBtn').onclick = async () => {
      if (started) return;
      started = true;
      screens.show('loading');
      
      try {
        await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        
        arSystem = document.querySelector('a-scene').systems['mindar-image-system'];
        if (arSystem) {
          arSystem.start();
          screens.show('hint');
          playMusic();
        } else {
          throw new Error('AR system not found');
        }
      } catch (e) {
        console.error('Camera error:', e);
        alert(isUA ? "–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏!" : "Allow camera access!");
        started = false;
        screens.show('start');
      }
    };

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log('‚úÖ AR –≥–æ—Ç–æ–≤–∏–π');
      
      initUI();
      
      COLORING_PAGES.forEach(cfg => {
        const entity = document.createElement('a-entity');
        entity.setAttribute('mindar-image-target', `targetIndex: ${cfg.id}`);
        
        entity.addEventListener('targetFound', async () => {
          if (currentColoring) return;

          console.log('üé® –ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ —Ä–æ–∑–º–∞–ª—å–æ–≤–∫—É:', cfg.id);
          currentMarkerId = cfg.id;

          try {
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            const img = new Image();
            img.crossOrigin = "anonymous";
            await new Promise((resolve, reject) => {
              img.onload = resolve;
              img.onerror = reject;
              img.src = cfg.image + '?v=' + Date.now();
            });

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Ä–æ–∑–º–∞–ª—å–æ–≤–∫—É
            currentColoring = new ColoringApp('coloringCanvas');
            currentColoring.setImage(img);

            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–µ
            const saved = localStorage.getItem(`coloring-${cfg.id}`);
            if (saved) {
              const savedImg = new Image();
              savedImg.onload = () => {
                const dpr = Math.min(window.devicePixelRatio || 1, 2);
                currentColoring.ctx.drawImage(
                  savedImg, 
                  0, 0, 
                  currentColoring.canvas.width / dpr, 
                  currentColoring.canvas.height / dpr
                );
              };
              savedImg.src = saved;
            }

            // –ü–æ–∫–∞–∑—É—î–º–æ UI
            document.getElementById('coloringCanvas').style.display = 'block';
            document.getElementById('colorPalette').style.display = 'flex';
            document.getElementById('brushSliderContainer').style.display = 'block';
            document.getElementById('screenshotBtn').style.display = 'block';
            document.getElementById('closeBtn').style.display = 'block';
            document.getElementById('hintTextOnPuzzle').style.display = 'block';
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É
            showMessage(isUA ? 
              '–ú–∞–ª—é–π –ø–∞–ª—å—á–∏–∫–æ–º! –ó–±–µ—Ä—ñ–≥–∞–π üì∏' : 
              'Draw with your finger! Save üì∏'
            );
            
          } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:', error);
            showMessage(isUA ? 
              '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è' : 
              'Error loading image'
            );
          }
        });

        document.querySelector('a-scene').appendChild(entity);
      });
      
      setLanguage(false);
      screens.show('start');
    });

    // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—É–¥—ñ–æ
    music.addEventListener('error', (e) => {
      console.log('Audio load error:', e);
      document.getElementById('soundBtn').style.display = 'none';
    });
  </script>
</body>
</html>
