<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ú–∞–≥—ñ—á–Ω–µ —Ä–æ–∑—Ñ–∞—Ä–±–æ–≤—É–≤–∞–Ω–Ω—è</title>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    * { 
      margin:0; padding:0; box-sizing:border-box; 
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    body, html { 
      margin:0; height:100%; overflow:hidden; 
      background:#000; font-family:'Comic Sans MS',cursive,sans-serif;
      touch-action: manipulation;
      position: fixed;
      width: 100%;
    }
    
    #hint { 
      position:fixed; top: max(20px, env(safe-area-inset-top, 20px)); 
      left:50%; transform:translateX(-50%); 
      background:#ff1493; color:#fff; padding:12px 24px; 
      border-radius:50px; font-size:clamp(16px, 4vw, 24px); 
      z-index:999; box-shadow:0 0 30px #ff1493; text-align:center;
      width: 90%;
      max-width: 400px;
    }
    
    .controls { 
      position:fixed; 
      bottom: max(20px, env(safe-area-inset-bottom, 20px));
      left:50%; transform:translateX(-50%); 
      display:flex; gap:10px; align-items:center; z-index:1000; 
      background:rgba(0,0,0,0.85); padding:12px 16px; border-radius:25px; 
      backdrop-filter: blur(10px);
      width: 95%;
      max-width: 500px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .colors { 
      display:flex; gap:6px; 
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .color-btn { 
      width:clamp(36px, 8vw, 44px); 
      height:clamp(36px, 8vw, 44px); 
      border-radius:50%; border:3px solid transparent; 
      cursor:pointer; transition:all .2s; 
      flex-shrink: 0;
    }
    
    .color-btn.active { 
      border:3px solid white; transform:scale(1.15); 
      box-shadow:0 0 15px rgba(255,255,255,0.6); 
    }
    
    input[type="range"] { 
      width:clamp(100px, 25vw, 130px); 
      accent-color:#ff1493; 
      flex-shrink: 0;
    }
    
    .zoom-btn { 
      width:clamp(42px, 10vw, 50px); 
      height:clamp(42px, 10vw, 50px); 
      border-radius:50%; background:#fff; color:#000; 
      font-size:clamp(20px, 6vw, 28px); font-weight:bold; 
      display:flex; align-items:center; justify-content:center; 
      cursor:pointer; user-select:none; flex-shrink: 0;
    }
    
    #brushValue { 
      color:white; font-size:clamp(14px, 4vw, 18px); 
      min-width:30px; text-align:center; 
      flex-shrink: 0;
    }
    
    @supports (-webkit-touch-callout: none) {
      .controls {
        padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      }
    }
    
    .color-btn:active, .zoom-btn:active {
      transform: scale(0.95);
      transition: transform 0.1s;
    }
    
    @media (max-height: 700px) {
      .controls { padding: 8px 12px; gap: 8px; }
      .colors { gap: 4px; }
      #hint { padding: 8px 16px; font-size: clamp(14px, 3.5vw, 18px); }
    }
    
    @media (max-width: 350px) {
      .controls { flex-direction: column; gap: 8px; }
      .colors { order: 1; }
    }
  </style>
</head>
<body>

  <div id="hint">–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ ‚Üí –º–∞–ª—é–π! üé®</div>

  <div class="controls">
    <div class="colors">
      <div class="color-btn active" data-color="#ff6961" style="background:#ff6961"></div>
      <div class="color-btn" data-color="#fdfd96" style="background:#fdfd96"></div>
      <div class="color-btn" data-color="#77dd77" style="background:#77dd77"></div>
      <div class="color-btn" data-color="#84b6f4" style="background:#84b6f4"></div>
      <div class="color-btn" data-color="#fdcae1" style="background:#fdcae1"></div>
      <div class="color-btn" data-color="#cbaacb" style="background:#cbaacb"></div>
      <div class="color-btn" data-color="#ff9ff3" style="background:#ff9ff3"></div>
      <div class="color-btn" data-color="#feca57" style="background:#feca57"></div>
      <div class="color-btn" data-color="#2d3436" style="background:#2d3436"></div>
    </div>
    <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
      <input type="range" id="brushSize" min="3" max="50" value="15">
      <div id="brushValue">15</div>
    </div>
    <div style="display: flex; gap: 5px; flex-shrink: 0;">
      <div class="zoom-btn" onclick="zoomIn()">+</div>
      <div class="zoom-btn" onclick="zoomOut()">‚Äì</div>
    </div>
  </div>

  <!-- ‚úÖ MindAR —Å–∞–º –∫–µ—Ä—É—î –∫–∞–º–µ—Ä–æ—é -->
  <a-scene
    mindar-image="imageTargetSrc: ./calendar.json; autoStart: true"
    renderer="colorManagement: true; antialias: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-camera></a-camera>
    <a-entity id="drawing-container"></a-entity>
  </a-scene>

  <script>
    // === –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ ===
    let currentColor = '#ff6961';
    let brushSize = 15;
    let scale = 1;
    let drawingCanvas = null;
    let ctx = null;
    let activeTargetIndex = null;
    let audio = null;
    let isDrawing = false;
    let lastIntersection = null;
    let userInteracted = false;

    // === –†–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞—É–¥—ñ–æ ===
    function unlockAudio() {
      if (userInteracted) return;
      userInteracted = true;
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        gain.gain.value = 0.001;
        oscillator.connect(gain);
        gain.connect(audioCtx.destination);
        oscillator.start();
        setTimeout(() => oscillator.stop(), 100);
      } catch (e) {
        console.log('–ê—É–¥—ñ–æ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
      }
    }

    // === Touch ‚Üí mouse –µ–º—É–ª—è—Ü—ñ—è ===
    function setupTouchEvents() {
      const scene = document.querySelector('a-scene');
      const emulate = (type, touch = {}) => {
        scene.dispatchEvent(new MouseEvent(type, { clientX: touch.clientX, clientY: touch.clientY }));
      };

      scene.addEventListener('touchstart', e => {
        if (e.touches.length > 0) emulate('mousedown', e.touches[0]);
        e.preventDefault();
      }, { passive: false });

      scene.addEventListener('touchmove', e => {
        if (e.touches.length > 0) emulate('mousemove', e.touches[0]);
        e.preventDefault();
      }, { passive: false });

      scene.addEventListener('touchend', e => {
        emulate('mouseup');
        e.preventDefault();
      }, { passive: false });
    }

    // === –°—Ç–≤–æ—Ä–µ–Ω–Ω—è 12 —Ü—ñ–ª–µ–π –∑—ñ —Å–ª—É—Ö–∞—á–∞–º–∏ ===
    function createTargets() {
      const container = document.getElementById('drawing-container');
      for (let i = 0; i < 12; i++) {
        const target = document.createElement('a-entity');
        target.setAttribute('mindar-image-target', { targetIndex: i });
        target.id = `target-${i}`;
        
        // ‚úÖ –ü–æ–¥—ñ—ó —Å–ª—É—Ö–∞—î–º–æ –Ω–∞ —Å–∞–º—ñ–π —Ü—ñ–ª—ñ
        target.addEventListener('targetFound', onTargetFound);
        target.addEventListener('targetLost', onTargetLost);
        
        container.appendChild(target);
      }
    }

    // === –ë–µ–∑–ø–µ—á–Ω—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π ===
    function onTargetFound(e) {
      if (!e?.detail?.targetIndex && e?.detail?.targetIndex !== 0) {
        console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –ø–æ–¥—ñ—è targetFound', e);
        return;
      }
      const idx = e.detail.targetIndex;
      console.log('üéØ –ó–Ω–∞–π–¥–µ–Ω–æ –º–∞—Ä–∫–µ—Ä:', idx);
      if (activeTargetIndex === idx) return;
      resetAll();
      activeTargetIndex = idx;
      loadImageAndSound(idx);
    }

    function onTargetLost(e) {
      if (!e?.detail?.targetIndex && e?.detail?.targetIndex !== 0) {
        console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –ø–æ–¥—ñ—è targetLost', e);
        return;
      }
      const idx = e.detail.targetIndex;
      console.log('‚ùå –í—Ç—Ä–∞—á–µ–Ω–æ –º–∞—Ä–∫–µ—Ä:', idx);
      if (activeTargetIndex === idx) resetAll();
    }

    function resetAll() {
      if (audio) { audio.pause(); audio = null; }
      document.querySelectorAll('.draw-surface').forEach(el => el.remove());
      drawingCanvas = ctx = null;
      scale = 1;
      activeTargetIndex = null;
      isDrawing = false;
    }

    // === –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞ –∑–≤—É–∫—É ===
    async function loadImageAndSound(idx) {
      try {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = `./images/${String(idx + 1).padStart(2, '0')}.jpg?t=${Date.now()}`;
        await new Promise((res, rej) => {
          img.onload = res;
          img.onerror = () => rej(new Error('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ—Å—å'));
        });

        try {
          audio = new Audio(`./fon/fon${idx + 1}.mp3`);
          audio.loop = true;
          audio.volume = 0.5;
          audio.play().catch(() => console.log('üîá –ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ'));
        } catch (e) {
          console.log('–§–æ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        }

        createCanvas(img, idx);
      } catch (err) {
        console.warn('–°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–≥–ª—É—à–∫—É –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è');
        createFallbackCanvas(idx);
      }
    }

    function createCanvas(img, idx) {
      const max = 1024;
      const ratio = Math.min(max / img.width, max / img.height, 1);
      const canvas = document.createElement('canvas');
      canvas.width = img.width * ratio;
      canvas.height = img.height * ratio;
      const ctx2d = canvas.getContext('2d');
      ctx2d.drawImage(img, 0, 0, canvas.width, canvas.height);

      const plane = document.createElement('a-plane');
      plane.className = 'draw-surface';
      const w = 0.6;
      const h = (canvas.height / canvas.width) * w;
      plane.setAttribute('position', '0 0 0.01');
      plane.setAttribute('width', w);
      plane.setAttribute('height', h);
      plane.setAttribute('material', 'src', canvas.toDataURL());
      plane.setAttribute('material', 'transparent', 'true');

      document.getElementById(`target-${idx}`).appendChild(plane);
      drawingCanvas = canvas;
      ctx = ctx2d;
    }

    function createFallbackCanvas(idx) {
      const canvas = document.createElement('canvas');
      canvas.width = 800; canvas.height = 600;
      const ctx2d = canvas.getContext('2d');
      ctx2d.fillStyle = '#2a2a2a';
      ctx2d.fillRect(0, 0, 800, 600);
      ctx2d.fillStyle = '#fff';
      ctx2d.font = '40px Arial';
      ctx2d.textAlign = 'center';
      ctx2d.fillText('–ú–∞–ª—é–π —Ç—É—Ç!', 400, 300);

      const plane = document.createElement('a-plane');
      plane.className = 'draw-surface';
      plane.setAttribute('position', '0 0 0.01');
      plane.setAttribute('width', 0.6);
      plane.setAttribute('height', 0.45);
      plane.setAttribute('material', 'src', canvas.toDataURL());
      plane.setAttribute('material', 'transparent', 'true');

      document.getElementById(`target-${idx}`).appendChild(plane);
      drawingCanvas = canvas;
      ctx = ctx2d;
    }

    // === –ú–∞–ª—é–≤–∞–Ω–Ω—è ===
    function handleDrawing(intersection) {
      if (!intersection || !drawingCanvas || !ctx || !intersection.uv) return;
      const uv = intersection.uv;
      const x = uv.x * drawingCanvas.width;
      const y = (1 - uv.y) * drawingCanvas.height;

      if (isDrawing && lastIntersection) {
        const lastUV = lastIntersection.uv;
        const lx = lastUV.x * drawingCanvas.width;
        const ly = (1 - lastUV.y) * drawingCanvas.height;

        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
        updateCanvasTexture();
      }
      lastIntersection = intersection;
    }

    function updateCanvasTexture() {
      const plane = document.querySelector('.draw-surface');
      if (plane && drawingCanvas) {
        plane.setAttribute('material', 'src', drawingCanvas.toDataURL());
      }
    }

    // === –ö–µ—Ä—É–≤–∞–Ω–Ω—è ===
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentColor = btn.dataset.color;
      });
    });

    document.getElementById('brushSize').addEventListener('input', e => {
      brushSize = Number(e.target.value);
      document.getElementById('brushValue').textContent = brushSize;
    });

    function zoomIn()  { scale = Math.min(3, scale + 0.25); updateScale(); }
    function zoomOut() { scale = Math.max(0.6, scale - 0.25); updateScale(); }
    
    function updateScale() {
      const plane = document.querySelector('.draw-surface');
      if (!plane || !drawingCanvas) return;
      const baseW = 0.6;
      const baseH = (drawingCanvas.height / drawingCanvas.width) * baseW;
      plane.setAttribute('width', baseW * scale);
      plane.setAttribute('height', baseH * scale);
    }

    // === –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ===
    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log('üé¨ –°—Ü–µ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
      createTargets();
      setupTouchEvents();

      const scene = document.querySelector('a-scene');
      
      // ‚úÖ –ü–æ–¥—ñ—ó —Ç–µ–ø–µ—Ä –Ω–∞ —Ü—ñ–ª—è—Ö ‚Äî –Ω–µ –¥–æ–¥–∞—î–º–æ —Å—é–¥–∏!

      scene.addEventListener('mousedown', (e) => {
        if (e.detail.intersectedEl?.classList.contains('draw-surface')) {
          isDrawing = true;
          lastIntersection = e.detail.intersection;
          handleDrawing(e.detail.intersection);
        }
      });

      scene.addEventListener('mouseup', () => {
        isDrawing = false;
        lastIntersection = null;
      });

      scene.addEventListener('mousemove', (e) => {
        if (isDrawing && e.detail.intersectedEl?.classList.contains('draw-surface')) {
          handleDrawing(e.detail.intersection);
        }
      });

      // –ü–µ—Ä—à–∏–π —Ç–∞–ø ‚Äî —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞—É–¥—ñ–æ
      document.body.addEventListener('click', unlockAudio, { once: true });

      document.getElementById('hint').textContent = '–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ ‚Üí –º–∞–ª—é–π! üé®';
    });

    window.addEventListener('beforeunload', resetAll);
  </script>
</body>
</html>
