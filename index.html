<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Calendar Puzzle | ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ AR ÐŸÐ°Ð·Ð»Ð¸</title>
    
    <!-- MindAR Ñ‚Ð° Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
        }
        .language-switcher {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255,255,255,0.95); padding: 10px 15px;
            border-radius: 20px; z-index: 100; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 2px solid #ff9e7d; display: flex; gap: 10px;
        }
        .lang-btn {
            background: none; border: none; padding: 8px 15px; cursor: pointer;
            border-radius: 15px; transition: all 0.3s; font-family: inherit; font-weight: bold;
        }
        .lang-btn.active { background: #4ecdc4; color: white; }
        #ar-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #instructions, #completion-message {
            background-color: rgba(255,255,255,0.95); border-radius: 20px; padding: 25px;
            text-align: center; max-width: 400px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            pointer-events: auto; border: 4px solid #ff9e7d; margin: 15px;
        }
        #instructions h2, #completion-message h2 {
            color: #ff6b6b; margin-bottom: 15px; font-size: 28px;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.5);
        }
        #instructions p, #completion-message p {
            margin-bottom: 20px; color: #333; line-height: 1.5; font-size: 18px;
        }
        button {
            background: linear-gradient(to bottom, #4ecdc4, #44a08d); color: white;
            border: none; padding: 12px 25px; border-radius: 30px; font-size: 18px;
            cursor: pointer; transition: all 0.3s; font-family: inherit; pointer-events: auto;
            box-shadow: 0 4px 0 #2a7c74; font-weight: bold; margin: 5px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #2a7c74; }
        button:active { transform: translateY(1px); box-shadow: 0 2px 0 #2a7c74; }
        .hidden { display: none !important; }
        .puzzle-counter {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.9); padding: 10px 15px; border-radius: 20px;
            font-weight: bold; color: #ff6b6b; pointer-events: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); border: 2px solid #ff9e7d; z-index: 100;
        }
        .marker-hint {
            position: absolute; bottom: 20px; left: 0; right: 0; text-align: center;
            color: white; font-size: 16px; pointer-events: none;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px; margin: 0 20px;
            z-index: 100;
        }
        @keyframes star-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .star-particle { animation: star-pulse 1s infinite; }
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; color: white;
        }
        .loader {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .processing-info {
            position: absolute; bottom: 80px; left: 0; right: 0; text-align: center;
            color: white; font-size: 14px; pointer-events: none;
            background: rgba(0,0,0,0.6); padding: 8px; margin: 0 20px;
            border-radius: 10px; z-index: 100;
        }
        @media (max-width: 768px) {
            #instructions, #completion-message { margin: 10px; padding: 20px; }
            #instructions h2, #completion-message h2 { font-size: 24px; }
            #instructions p, #completion-message p { font-size: 16px; }
            button { padding: 10px 20px; font-size: 16px; }
            .language-switcher { top: 10px; left: 10px; padding: 8px 12px; }
            .puzzle-counter { top: 10px; right: 10px; }
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loader"></div>
        <h2 data-i18n="loading.title">Loading AR Experience...</h2>
        <p data-i18n="loading.description">Preparing for your puzzle adventure</p>
        <div class="processing-info" id="processing-info">Initializing AR...</div>
    </div>

    <div class="language-switcher">
        <button class="lang-btn active" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="uk">UA</button>
    </div>

    <div id="ar-container">
        <a-scene 
            mindar-image="imageTargetSrc: https://raw.githubusercontent.com/Lessa2332/your-calendar/main/calendar.mind; autoStart: false; uiLoading: no; uiScanning: no; uiError: no;"
            embedded
            color-space="sRGB"
            renderer="colorManagement: true; physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false">
            
            <a-entity camera></a-entity>
            <a-entity id="puzzle-targets-container"></a-entity>

            <a-entity id="puzzle-board" position="0 0 -1.5" visible="false">
                <a-plane id="board" color="#f0f0f0" width="2.5" height="2.5" position="0 0 0"></a-plane>
                <a-entity id="grid-container"></a-entity>
            </a-entity>

            <a-entity id="victory-effects" visible="false"></a-entity>
        </a-scene>
    </div>

    <div id="ui-overlay">
        <div id="instructions">
            <h2 data-i18n="instructions.title">AR Calendar Puzzle Adventure! ðŸ§©</h2>
            <p data-i18n="instructions.description1">Point your device at any calendar image to reveal a puzzle!</p>
            <p data-i18n="instructions.description2">Drag the pieces to the board to complete it and see magic! âœ¨</p>
            <button id="start-btn" data-i18n="instructions.startButton">Start AR Experience</button>
        </div>
        <div id="completion-message" class="hidden">
            <h2 data-i18n="completion.title">Congratulations! ðŸŽ‰</h2>
            <p data-i18n="completion.description">You completed the puzzle! Amazing!</p>
            <button id="continue-btn" data-i18n="completion.continueButton">Try Another Image</button>
        </div>
    </div>

    <div class="puzzle-counter">
        <span data-i18n="counter.text">Pieces:</span> <span id="piece-count">0</span>/9
    </div>

    <div class="marker-hint" data-i18n="marker.hint">
        Point camera at any calendar image to start a puzzle
    </div>

    <canvas id="image-processor" style="display: none;"></canvas>

    <script>
        const translations = {
            en: {
                "loading.title": "Loading AR Experience...",
                "loading.description": "Preparing for your puzzle adventure",
                "instructions.title": "AR Calendar Puzzle Adventure! ðŸ§©",
                "instructions.description1": "Point your device at any calendar image to reveal a puzzle!",
                "instructions.description2": "Drag the pieces to the board to complete it and see magic! âœ¨",
                "instructions.startButton": "Start AR Experience",
                "completion.title": "Congratulations! ðŸŽ‰",
                "completion.description": "You completed the puzzle! Amazing!",
                "completion.continueButton": "Try Another Image",
                "counter.text": "Pieces:",
                "marker.hint": "Point camera at any calendar image to start a puzzle"
            },
            uk: {
                "loading.title": "Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ AR...",
                "loading.description": "Ð“Ð¾Ñ‚ÑƒÑ”Ð¼Ð¾ Ð¿Ñ€Ð¸Ð³Ð¾Ð´Ñƒ Ð· Ð¿Ð°Ð·Ð»Ð°Ð¼Ð¸",
                "instructions.title": "AR ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ ÐŸÐ°Ð·Ð»Ð¸! ðŸ§©",
                "instructions.description1": "ÐÐ°Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ð¿Ñ€Ð¸ÑÑ‚Ñ€Ñ–Ð¹ Ð½Ð° Ð±ÑƒÐ´ÑŒ-ÑÐºÐµ Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ñ, Ñ‰Ð¾Ð± Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ Ð¿Ð°Ð·Ð»!",
                "instructions.description2": "ÐŸÐµÑ€ÐµÑ‚ÑÐ³ÑƒÐ¹Ñ‚Ðµ Ð¿Ð°Ð·Ð»Ð¸ Ð½Ð° Ð´Ð¾ÑˆÐºÑƒ, Ñ‰Ð¾Ð± ÑÐºÐ»Ð°ÑÑ‚Ð¸ Ð¹Ð¾Ð³Ð¾ Ñ‚Ð° Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ Ð¼Ð°Ð³Ñ–ÑŽ! âœ¨",
                "instructions.startButton": "ÐŸÐ¾Ñ‡Ð°Ñ‚Ð¸ AR Ð“Ñ€Ñƒ",
                "completion.title": "Ð’Ñ–Ñ‚Ð°Ñ”Ð¼Ð¾! ðŸŽ‰",
                "completion.description": "Ð’Ð¸ ÑÐºÐ»Ð°Ð»Ð¸ Ð¿Ð°Ð·Ð»! Ð§ÑƒÐ´Ð¾Ð²Ð¾!",
                "completion.continueButton": "Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ²Ð°Ñ‚Ð¸ Ñ–Ð½ÑˆÐµ Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ",
                "counter.text": "ÐŸÐ°Ð·Ð»Ñ–Ð²:",
                "marker.hint": "ÐÐ°Ð²ÐµÐ´Ñ–Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° Ð±ÑƒÐ´ÑŒ-ÑÐºÐµ Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ñ, Ñ‰Ð¾Ð± Ð¿Ð¾Ñ‡Ð°Ñ‚Ð¸"
            }
        };

        class ImageSplitter {
            constructor() {
                this.canvas = document.getElementById('image-processor');
                this.ctx = this.canvas.getContext('2d');
            }
            async splitImage(imageUrl, rows = 3, cols = 3) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => {
                        try {
                            const w = img.width / cols, h = img.height / rows;
                            const pieces = [];
                            this.canvas.width = w; this.canvas.height = h;
                            for (let r = 0; r < rows; r++) {
                                for (let c = 0; c < cols; c++) {
                                    this.ctx.clearRect(0, 0, w, h);
                                    this.ctx.drawImage(img, c * w, r * h, w, h, 0, 0, w, h);
                                    pieces.push({
                                        dataURL: this.canvas.toDataURL('image/jpeg', 0.92),
                                        row: r, col: c, index: r * cols + c
                                    });
                                }
                            }
                            resolve(pieces);
                        } catch (e) { reject(e); }
                    };
                    img.onerror = () => reject(new Error('Image load failed'));
                    img.src = imageUrl;
                });
            }
        }

        class ARPuzzleGame {
            constructor() {
                this.scene = document.querySelector('a-scene');
                this.isDragging = false;
                this.currentPiece = null;
                this.placedPieces = [];
                this.gridSize = 3;
                this.gridSlots = [];
                this.puzzleCompleted = false;
                this.currentTargetIndex = null;
                this.imageSplitter = new ImageSplitter();
                this.init();
            }

            async init() {
                this.setupLocalization();
                this.createTargetContainers();
                this.createGrid();
                this.setupEventListeners();
                this.setupDragAndDrop();

                this.scene.addEventListener('loaded', () => {
                    const mindarComp = this.scene.querySelector('[mindar-image]').components['mindar-image'];
                    if (!mindarComp) {
                        document.getElementById('processing-info').textContent = "âŒ Failed to load AR engine.";
                        return;
                    }
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                    }, 500);
                });

                this.scene.addEventListener('mindar-image-targetFound', (e) => {
                    this.onTargetFound(e.detail.index);
                });
            }

            createTargetContainers() {
                const container = document.getElementById('puzzle-targets-container');
                for (let i = 0; i < 12; i++) {
                    const target = document.createElement('a-entity');
                    target.setAttribute('mindar-image-target', `targetIndex: ${i}`);
                    const puzzleContainer = document.createElement('a-entity');
                    puzzleContainer.setAttribute('id', `puzzle-container-${i}`);
                    target.appendChild(puzzleContainer);
                    container.appendChild(target);
                }
            }

            createGrid() {
                const gridContainer = document.getElementById('grid-container');
                const size = 0.8;
                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 3; c++) {
                        const x = (c - 1) * size;
                        const y = (1 - r) * size;
                        const slot = document.createElement('a-entity');
                        slot.setAttribute('position', `${x} ${y} 0.01`);
                        slot.setAttribute('geometry', `primitive: plane; width: ${size * 0.85}; height: ${size * 0.85}`);
                        slot.setAttribute('material', 'color: rgb(200, 200, 200); transparent: true; opacity: 0.3');
                        slot.setAttribute('visible', 'false');
                        gridContainer.appendChild(slot);
                        this.gridSlots.push({ element: slot, row: r, col: c, occupied: false });
                    }
                }
            }

            setupLocalization() {
                this.currentLang = 'en';
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lang = e.target.dataset.lang;
                        this.switchLanguage(lang);
                        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                    });
                });
                this.loadLanguage('en');
            }

            switchLanguage(lang) {
                this.currentLang = lang;
                this.loadLanguage(lang);
            }

            loadLanguage(lang) {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang]?.[key]) el.textContent = translations[lang][key];
                });
            }

            setupEventListeners() {
                document.getElementById('start-btn').addEventListener('click', () => {
                    document.getElementById('instructions').classList.add('hidden');
                    document.getElementById('puzzle-board').setAttribute('visible', 'true');
                    this.gridSlots.forEach(slot => slot.element.setAttribute('visible', 'true'));
                    const mindarComp = this.scene.querySelector('[mindar-image]').components['mindar-image'];
                    if (mindarComp) mindarComp.start();
                });

                document.getElementById('continue-btn').addEventListener('click', () => {
                    this.resetPuzzle();
                    document.getElementById('completion-message').classList.add('hidden');
                });
            }

            async onTargetFound(targetIndex) {
                if (this.puzzleCompleted && this.currentTargetIndex === targetIndex) return;
                if (this.currentTargetIndex !== null && this.currentTargetIndex !== targetIndex) {
                    this.resetPuzzle();
                }
                this.currentTargetIndex = targetIndex;
                await this.loadAndShowPuzzle(targetIndex);
            }

            async loadAndShowPuzzle(targetIndex) {
                const url = `https://raw.githubusercontent.com/Lessa2332/your-calendar/main/images/${String(targetIndex + 1).padStart(2, '0')}.jpg`;
                const container = document.getElementById(`puzzle-container-${targetIndex}`);
                while (container.firstChild) container.removeChild(container.firstChild);

                try {
                    const pieces = await this.imageSplitter.splitImage(url, 3, 3);
                    pieces.forEach((piece, idx) => {
                        const angle = (idx / 9) * Math.PI * 2;
                        const radius = 0.6 + (idx % 3) * 0.1;
                        const y = -0.2 + Math.floor(idx / 3) * 0.25;
                        const pieceEl = document.createElement('a-entity');
                        pieceEl.setAttribute('class', 'puzzle-piece');
                        pieceEl.setAttribute('data-piece-id', idx);
                        pieceEl.setAttribute('data-correct-row', piece.row);
                        pieceEl.setAttribute('data-correct-col', piece.col);
                        pieceEl.setAttribute('data-target-index', targetIndex);
                        pieceEl.setAttribute('position', `${Math.cos(angle) * radius} ${y} ${Math.sin(angle) * radius + 0.2}`);
                        pieceEl.setAttribute('scale', '0.28 0.28 0.28');

                        const plane = document.createElement('a-plane');
                        plane.setAttribute('width', '0.55'); plane.setAttribute('height', '0.55');
                        plane.setAttribute('src', piece.dataURL); plane.setAttribute('transparent', 'true');
                        pieceEl.appendChild(plane);
                        container.appendChild(pieceEl);
                    });
                } catch (err) {
                    console.error("Puzzle load error:", err);
                    document.getElementById('processing-info').textContent = "âš ï¸ Image not loaded. Check internet.";
                }
            }

            setupDragAndDrop() {
                const events = ['mousedown', 'touchstart', 'mousemove', 'touchmove', 'mouseup', 'touchend'];
                events.forEach(type => {
                    this.scene.addEventListener(type, (e) => {
                        if (type === 'mousedown' || type === 'touchstart') this.onInteractionStart(e);
                        if (type === 'mousemove' || type === 'touchmove') this.onInteractionMove(e);
                        if (type === 'mouseup' || type === 'touchend') this.onInteractionEnd(e);
                    });
                });
            }

            onInteractionStart(e) {
                if (this.puzzleCompleted) return;
                const el = e.detail?.intersectedEl;
                if (!el) return;
                let piece = el.classList.contains('puzzle-piece') ? el : el.parentElement;
                if (!piece || !piece.classList.contains('puzzle-piece')) return;
                if (parseInt(piece.getAttribute('data-target-index')) !== this.currentTargetIndex) return;

                this.isDragging = true;
                this.currentPiece = piece;
                this.currentPiece.setAttribute('scale', '0.32 0.32 0.32');
                e.preventDefault();
            }

            onInteractionMove(e) {
                if (!this.isDragging || !this.currentPiece) return;
                const cam = this.scene.querySelector('[camera]');
                const pos = cam.getAttribute('position');
                this.currentPiece.setAttribute('position', {
                    x: pos.x + (Math.random() - 0.5) * 0.2,
                    y: pos.y + (Math.random() - 0.5) * 0.2,
                    z: pos.z - 0.6
                });
                e.preventDefault();
            }

            onInteractionEnd(e) {
                if (!this.isDragging || !this.currentPiece) return;
                this.isDragging = false;
                this.snapToGrid(this.currentPiece);
                this.currentPiece = null;
                e.preventDefault();
            }

            snapToGrid(piece) {
                const r = parseInt(piece.getAttribute('data-correct-row'));
                const c = parseInt(piece.getAttribute('data-correct-col'));
                const slot = this.gridSlots.find(s => s.row === r && s.col === c);
                if (slot && !slot.occupied) {
                    const board = document.getElementById('puzzle-board').getAttribute('position');
                    const sPos = slot.element.getAttribute('position');
                    const target = { x: board.x + sPos.x, y: board.y + sPos.y, z: board.z + 0.02 };
                    piece.setAttribute('position', target);
                    piece.setAttribute('scale', '0.25 0.25 0.25');
                    slot.occupied = true;
                    this.placedPieces.push(piece.getAttribute('data-piece-id'));
                    document.getElementById('piece-count').textContent = this.placedPieces.length;
                    if (this.placedPieces.length === 9) this.showVictoryAnimation();
                } else {
                    piece.setAttribute('scale', '0.28 0.28 0.28');
                }
            }

            showVictoryAnimation() {
                this.puzzleCompleted = true;
                const fx = document.getElementById('victory-effects');
                fx.setAttribute('visible', 'true');
                for (let i = 0; i < 15; i++) {
                    const star = document.createElement('a-entity');
                    star.setAttribute('geometry', 'primitive: octahedron');
                    star.setAttribute('material', 'color: yellow; shader: flat');
                    star.setAttribute('scale', '0.1 0.1 0.1');
                    const a = Math.random() * Math.PI * 2;
                    const r = 0.3 + Math.random() * 0.7;
                    const y = -0.5 + Math.random() * 1;
                    star.setAttribute('position', { x: Math.cos(a) * r, y, z: Math.sin(a) * r - 1.5 });
                    star.setAttribute('animation', {
                        property: 'position',
                        to: `${Math.cos(a)*2} ${y+1.5} ${Math.sin(a)*2 - 1.5}`,
                        dur: 2000 + Math.random() * 1000,
                        easing: 'easeOutQuad'
                    });
                    fx.appendChild(star);
                }
                document.getElementById('completion-message').classList.remove('hidden');
            }

            resetPuzzle() {
                document.getElementById('puzzle-board').setAttribute('visible', 'false');
                document.getElementById('victory-effects').setAttribute('visible', 'false');
                while (document.getElementById('victory-effects').firstChild) {
                    document.getElementById('victory-effects').removeChild(document.getElementById('victory-effects').firstChild);
                }
                for (let i = 0; i < 12; i++) {
                    const cont = document.getElementById(`puzzle-container-${i}`);
                    if (cont) while (cont.firstChild) cont.removeChild(cont.firstChild);
                }
                this.placedPieces = [];
                this.puzzleCompleted = false;
                this.currentTargetIndex = null;
                document.getElementById('piece-count').textContent = '0';
                this.gridSlots.forEach(slot => {
                    slot.occupied = false;
                    slot.element.setAttribute('visible', 'false');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.puzzleGame = new ARPuzzleGame();
        });
    </script>
</body>
</html>
