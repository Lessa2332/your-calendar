<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Magical Ukraine Calendar 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="AR Calendar Adventure: Collect crystals from Ukraine's magical months!">
  <style>
    /* Global resets and base styles */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      touch-action: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #mindar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    #info {
      text-align: center;
      color: white;
      text-shadow: 0 0 10px #00ffff;
      padding: 10px 16px;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      font-size: clamp(14px, 4vw, 18px);
      line-height: 1.4;
      max-width: 90%;
      margin: 0 auto;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      gap: 10px;
      pointer-events: auto;
    }
    .lang-btn, .etsy-btn {
      pointer-events: auto;
      background: rgba(0, 200, 255, 0.2);
      border: 1px solid #00ffff;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      backdrop-filter: blur(4px);
      transition: background 0.2s ease;
      user-select: none;
    }
    .lang-btn:hover, .etsy-btn:hover,
    .lang-btn:active, .etsy-btn:active {
      background: rgba(0, 200, 255, 0.4);
    }
    #crystals {
      display: flex;
      gap: clamp(8px, 3vw, 14px);
      justify-content: center;
      padding: 0 8px 20px;
      pointer-events: none;
      flex-wrap: wrap;
    }
    .crystal-slot {
      width: clamp(40px, 12vw, 56px);
      height: clamp(40px, 12vw, 56px);
      border: 2px solid #00ffff77;
      border-radius: 50%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(24px, 7vw, 36px);
      font-weight: bold;
      color: white;
      transition: all 0.3s ease;
    }
    .crystal-slot.collected {
      background: linear-gradient(45deg, #00ffff, #ff00ff);
      transform: scale(1.1);
      box-shadow: 0 0 10px #00ffff;
    }
    /* Loading spinner */
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00ffff;
      font-size: 18px;
      z-index: 101;
      display: none;
    }
    .spinner {
      border: 4px solid rgba(0, 255, 255, 0.3);
      border-top: 4px solid #00ffff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div id="loading-text">Loading...</div>
  </div>
  <div id="mindar-container"></div>
  <div id="ui">
    <div id="top-bar">
      <button class="lang-btn" id="lang-toggle">Українська</button>
      <button class="etsy-btn" id="etsy-link">Shop on Etsy</button>
    </div>
    <div id="info">Point your camera at any calendar marker ❤️</div>
    <div id="crystals"></div>
  </div>

  <!-- Використовуємо правильні CDN посилання -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.10/dist/mindar-image-three.prod.js"></script>

  <script>
    // Translations for internationalization
    const translations = {
      en: {
        infoScan: "Point your camera at any calendar marker ❤️",
        infoComplete: "UKRAINE'S HEART IS COMPLETE!<br>You are a true hero ❤️",
        langBtn: "Українська",
        etsyBtn: "Shop on Etsy",
        loading: "Loading...",
        scanning: "Scanning for marker...",
        errorCamera: "❌ Please allow camera access or refresh the page.",
        errorLibrary: "❌ AR library failed to load. Please refresh."
      },
      uk: {
        infoScan: "Наведи камеру на будь-який маркер календаря ❤️",
        infoComplete: "СЕРЦЕ УКРАЇНИ ЗІБРАНО!<br>Ти — справжній герой ❤️",
        langBtn: "English",
        etsyBtn: "Купити на Etsy",
        loading: "Завантажуємо...",
        scanning: "Шукаємо маркер...",
        errorCamera: "❌ Дозволь доступ до камери або онови сторінку.",
        errorLibrary: "❌ Помилка завантаження AR. Оновіть сторінку."
      }
    };

    let currentLang = 'en';
    const DPR = window.devicePixelRatio || 1;

    // Localization function
    function setLang(lang) {
      currentLang = lang;
      localStorage.setItem('calendar-lang', lang);
      const t = translations[lang];
      document.getElementById('info').innerHTML = t.infoScan;
      document.getElementById('lang-toggle').textContent = t.langBtn;
      document.getElementById('etsy-link').textContent = t.etsyBtn;
      document.getElementById('loading-text').textContent = t.loading;
      updateCrystalsUI();
    }

    // Initialize language
    const savedLang = localStorage.getItem('calendar-lang');
    if (savedLang === 'uk') setLang('uk');

    // Event listeners for buttons
    document.getElementById('lang-toggle').addEventListener('click', () => {
      setLang(currentLang === 'en' ? 'uk' : 'en');
    });
    document.getElementById('etsy-link').addEventListener('click', () => {
      window.open('https://smartlessa.etsy.com', '_blank');
    });

    // Data management
    let collectedCrystals = JSON.parse(localStorage.getItem('ua-crystals2026') || '[]');
    const totalMonths = 12;
    const images = [];
    let allImagesLoaded = false;

    // Preload images
    let loadedImagesCount = 0;
    for (let i = 1; i <= 12; i++) {
      const img = new Image();
      // Використовуємо fallback URL для тестування
      img.src = `images/${i.toString().padStart(2, '0')}.jpg`;
      img.onload = () => {
        loadedImagesCount++;
        console.log(`Image ${i} loaded successfully`);
        if (loadedImagesCount === totalMonths) {
          allImagesLoaded = true;
          console.log('All images loaded successfully');
        }
      };
      img.onerror = () => {
        console.error(`Failed to load image: images/${i.toString().padStart(2, '0')}.jpg`);
        loadedImagesCount++;
        // Навіть якщо зображення не завантажилось, продовжуємо
        if (loadedImagesCount === totalMonths) {
          allImagesLoaded = true;
        }
      };
      images.push(img);
    }

    // Wait for everything to load
    window.addEventListener('load', function() {
      const loadingEl = document.getElementById('loading');
      
      // Check if required libraries are available
      if (typeof THREE === 'undefined') {
        loadingEl.style.display = 'none';
        document.getElementById('info').innerHTML = translations[currentLang].errorLibrary;
        console.error('THREE.js is not defined');
        return;
      }

      if (typeof MindARThree === 'undefined') {
        loadingEl.style.display = 'none';
        document.getElementById('info').innerHTML = translations[currentLang].errorLibrary;
        console.error('MindARThree is not defined. Available globals:', Object.keys(window));
        return;
      }

      console.log('All libraries loaded successfully');
      
      // Initialize MindAR
      try {
        const mindarThree = new MindARThree({
          container: document.getElementById("mindar-container"),
          imageTargetSrc: "calendar.mind",
          maxTrack: 1, // Спочатку спробуємо з одним маркером
          uiScanning: translations[currentLang].scanning,
          uiLoading: translations[currentLang].loading,
        });

        const { renderer, scene, camera } = mindarThree;
        renderer.setPixelRatio(DPR);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        // Lighting setup
        const directionalLight = new THREE.DirectionalLight(0xffffff, 2.5);
        directionalLight.position.set(0, 1, 1);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));

        // AR groups for targets
        const arGroups = [];
        for (let i = 0; i < 12; i++) {
          const group = new THREE.Group();
          const anchor = mindarThree.addAnchor(i);
          anchor.group.add(group);
          arGroups.push(group);
        }

        // Resize handler
        function onWindowResize() {
          const w = window.innerWidth, h = window.innerHeight;
          camera.aspect = w / h;
          camera.updateProjectionMatrix();
          renderer.setSize(w, h);
        }
        window.addEventListener('resize', onWindowResize, { passive: true });
        window.addEventListener('orientationchange', () => setTimeout(onWindowResize, 300));

        // Unified touch/mouse handler
        const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
        let dragging = false;
        
        function addUnifiedTouch(el, onStart, onMove = () => {}, onEnd = () => {}) {
          const startHandler = (e) => {
            e.preventDefault();
            dragging = true;
            const touch = isMobile ? e.touches[0] : e;
            onStart(touch);
          };
          const moveHandler = (e) => {
            if (!dragging) return;
            e.preventDefault();
            const touch = isMobile ? e.touches[0] : e;
            onMove(touch);
          };
          const endHandler = (e) => {
            e.preventDefault();
            dragging = false;
            onEnd();
          };

          if (isMobile) {
            el.addEventListener('touchstart', startHandler, { passive: false });
            el.addEventListener('touchmove', moveHandler, { passive: false });
            el.addEventListener('touchend', endHandler, { passive: false });
            el.addEventListener('touchcancel', endHandler, { passive: false });
          } else {
            el.addEventListener('mousedown', startHandler);
            el.addEventListener('mousemove', moveHandler);
            el.addEventListener('mouseup', endHandler);
            el.addEventListener('mouseleave', endHandler);
          }
        }

        // Haptic feedback for mobile
        function hapticFeedback(pattern = [100]) {
          if (isMobile && navigator.vibrate) {
            navigator.vibrate(pattern);
          }
        }

        // Start AR
        loadingEl.style.display = 'block';
        
        mindarThree.start().then(() => {
          loadingEl.style.display = 'none';
          let lastVisible = -1;
          const clock = new THREE.Clock();

          const animate = () => {
            const delta = clock.getDelta();
            renderer.render(scene, camera);
            
            let currentVisible = -1;
            for (let i = 0; i < 12; i++) {
              if (mindarThree.anchors[i] && mindarThree.anchors[i].visible) {
                currentVisible = i;
                break;
              }
            }
            
            if (currentVisible !== lastVisible) {
              if (lastVisible !== -1) arGroups[lastVisible].clear();
              if (currentVisible !== -1 && allImagesLoaded) {
                setTimeout(() => showMonthContent(currentVisible, arGroups[currentVisible]), 300);
              }
              lastVisible = currentVisible;
            }
            requestAnimationFrame(animate);
          };
          animate();
        }).catch(e => {
          loadingEl.style.display = 'none';
          document.getElementById('info').innerHTML = translations[currentLang].errorCamera;
          console.error('AR Error:', e);
        });

        // Main mechanics
        function showMonthContent(month, arGroup) {
          if (collectedCrystals.includes(month)) {
            showCrystalReward(month, arGroup);
            return;
          }
          
          const img = images[month];
          
          arGroup.clear();
          
          // Створюємо просту геометрію для тесту
          const geometry = new THREE.PlaneGeometry(1, 1);
          const material = new THREE.MeshBasicMaterial({ 
            color: 0x00ffff,
            transparent: true,
            opacity: 0.8
          });
          const mesh = new THREE.Mesh(geometry, material);
          arGroup.add(mesh);

          // Додаємо текст з номером місяця
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = 256;
          canvas.height = 256;
          context.fillStyle = '#00ffff';
          context.font = 'bold 100px Arial';
          context.textAlign = 'center';
          context.textBaseline = 'middle';
          context.fillText((month + 1).toString(), 128, 128);
          
          const texture = new THREE.CanvasTexture(canvas);
          const textMaterial = new THREE.MeshBasicMaterial({ 
            map: texture,
            transparent: true
          });
          const textMesh = new THREE.Mesh(geometry, textMaterial);
          textMesh.position.z = 0.01;
          arGroup.add(textMesh);

          const startInteraction = () => {
            hapticFeedback([50]);
            arGroup.clear();
            showCrystalReward(month, arGroup);
          };

          addUnifiedTouch(renderer.domElement, startInteraction);
        }

        function showCrystalReward(month, arGroup) {
          if (collectedCrystals.includes(month)) return;
          collectedCrystals.push(month);
          localStorage.setItem('ua-crystals2026', JSON.stringify(collectedCrystals));
          updateCrystalsUI();
          arGroup.clear();

          const colors = ['#00ffff', '#ff00ff', '#00ff00', '#ffff00', '#ff8800', '#ff0066', '#0066ff', '#ff3399', '#33ff99', '#ffcc00', '#cc00ff', '#00ccff'];
          const crystalGeo = new THREE.IcosahedronGeometry(0.35, 1);
          const crystalMat = new THREE.MeshStandardMaterial({
            color: colors[month],
            emissive: colors[month],
            emissiveIntensity: 4,
            roughness: 0,
            metalness: 0.85
          });
          const crystal = new THREE.Mesh(crystalGeo, crystalMat);
          crystal.position.z = 0.2;
          crystal.castShadow = true;
          arGroup.add(crystal);

          const animateCrystal = () => {
            if (!arGroup.parent) return;
            crystal.rotation.y += 0.015;
            crystal.rotation.x += 0.005;
            const scale = 1 + Math.sin(Date.now() * 0.004) * 0.08;
            crystal.scale.setScalar(scale);
            requestAnimationFrame(animateCrystal);
          };
          animateCrystal();
          hapticFeedback([200]);

          if (collectedCrystals.length === 12) {
            setTimeout(() => {
              arGroup.clear();
              document.getElementById('info').innerHTML = translations[currentLang].infoComplete;
              hapticFeedback([300, 100, 300]);
            }, 2000);
          }
        }

      } catch (error) {
        loadingEl.style.display = 'none';
        document.getElementById('info').innerHTML = translations[currentLang].errorLibrary;
        console.error('Initialization error:', error);
      }

    });

    function updateCrystalsUI() {
      const container = document.getElementById('crystals');
      container.innerHTML = '';
      for (let i = 0; i < totalMonths; i++) {
        const div = document.createElement('div');
        div.className = 'crystal-slot';
        if (collectedCrystals.includes(i)) {
          div.innerHTML = '✦';
          div.classList.add('collected');
        } else {
          div.innerHTML = (i + 1);
        }
        container.appendChild(div);
      }
    }

    // Initial UI update
    updateCrystalsUI();
  </script>
</body>
</html>
