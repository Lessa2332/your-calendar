<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Magic Coloring for My Star</title>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent !important;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    a-scene {
      position: fixed;
      inset: 0;
      background: transparent !important;
      pointer-events: none;
      z-index: 1;
    }
    
    #coloringCanvas {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      background: transparent;
      pointer-events: auto;
      display: none;
      border: 2px solid #ff1493;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(255, 20, 147, 0.5);
      max-width: min(90vw, 500px);
      max-height: min(70vh, 700px);
      cursor: crosshair;
    }
    
    #closeBtn {
      position: fixed;
      top: max(15px, env(safe-area-inset-top, 15px));
      right: 15px;
      width: 45px;
      height: 45px;
      background: #ff1493;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      font-weight: bold;
      z-index: 1002;
      box-shadow: 0 0 15px #ff1493;
      cursor: pointer;
      display: none;
    }
    
    .screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      z-index: 1001;
      text-align: center;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
    }
    
    #startScreen {
      background: radial-gradient(circle at center, rgba(255, 20, 147, 0.7), transparent);
    }
    
    button {
      background: #ff1493;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 50px;
      font-size: clamp(16px, 3.5vw, 20px);
      cursor: pointer;
      box-shadow: 0 0 15px #ff1493;
      margin: 8px;
      transition: transform 0.3s;
      min-height: 44px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    #hintTextOnPuzzle {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      color: white;
      font-weight: bold;
      text-align: center;
      z-index: 1002;
      font-size: clamp(12px, 3vw, 16px);
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      display: none;
      background: rgba(0, 0, 0, 0.5);
      padding: 6px 10px;
      border-radius: 8px;
    }
    
    #langBtn {
      position: fixed;
      top: max(15px, env(safe-area-inset-top, 15px));
      left: 15px;
      background: #ff1493;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1002;
      box-shadow: 0 0 12px #ff1493;
      cursor: pointer;
      min-height: 36px;
    }
    
    #soundBtn {
      position: fixed;
      bottom: max(15px, env(safe-area-inset-bottom, 15px));
      right: 15px;
      background: rgba(255, 20, 147, 0.7);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 50%;
      font-size: 18px;
      z-index: 1002;
      cursor: pointer;
      box-shadow: 0 0 12px #ff1493;
      min-width: 40px;
      min-height: 40px;
    }
    
    #etsyBtn {
      position: fixed;
      bottom: max(15px, env(safe-area-inset-bottom, 15px));
      left: 15px;
      background: #f16521;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 25px;
      font-size: 12px;
      font-weight: bold;
      z-index: 1002;
      box-shadow: 0 0 12px #f16521;
      cursor: pointer;
      min-height: 36px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 4px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    
    #etsyBtn::before {
      content: "üõçÔ∏è";
      font-size: 14px;
    }
    
    #loadingIndicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: clamp(16px, 3.5vw, 20px);
      z-index: 1003;
      background: rgba(0, 0, 0, 0.8);
      padding: 12px 18px;
      border-radius: 12px;
      display: none;
    }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞ –ø–∞–ª—ñ—Ç—Ä–∞ –∫–æ–ª—å–æ—Ä—ñ–≤ */
    #colorPalette {
      position: fixed;
      bottom: 90px;
      left: 8px;
      right: 8px;
      display: none;
      z-index: 1002;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      padding: 8px;
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    #colorPalette::-webkit-scrollbar {
      display: none;
    }
    
    .color-scroll-container {
      display: flex;
      gap: 6px;
      min-width: min-content;
    }
    
    .colorBtn {
      width: 32px;
      height: 32px;
      min-width: 32px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.2s;
    }

    .colorBtn:hover {
      transform: scale(1.1);
    }

    .colorBtn.active {
      transform: scale(1.2);
      border-color: #ff1493;
      box-shadow: 0 0 8px #ff1493;
    }
    
    /* –°–ª–∞–π–¥–µ—Ä —Ç–æ–≤—â–∏–Ω–∏ –ø–µ–Ω–∑–ª—è */
    #brushSliderContainer {
      position: fixed;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      width: 85%;
      max-width: 280px;
      display: none;
      z-index: 1002;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 15px;
      text-align: center;
      color: white;
      font-weight: bold;
      font-size: clamp(12px, 2.5vw, 14px);
    }
    
    #brushSlider {
      width: 100%;
      margin-top: 6px;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
    }

    #brushSlider::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ff1493;
      cursor: pointer;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
      border: 2px solid white;
    }

    #brushSlider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ff1493;
      cursor: pointer;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
      border: 2px solid white;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ –¥—ñ–π */
    .action-buttons {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 1003;
      gap: 10px;
      align-items: center;
    }
    
    .action-btn {
      width: 42px;
      height: 42px;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .action-btn:hover {
      transform: scale(1.1);
    }

    .action-btn.active {
      transform: scale(1.15);
      box-shadow: 0 0 10px currentColor;
    }
    
    #screenshotBtn {
      background: rgba(34, 139, 34, 0.9);
      color: white;
      box-shadow: 0 0 12px rgba(34, 139, 34, 0.8);
    }

    #undoBtn {
      background: rgba(255, 69, 0, 0.9);
      color: white;
      box-shadow: 0 0 12px rgba(255, 69, 0, 0.8);
    }

    #clearBtn {
      background: rgba(255, 215, 0, 0.9);
      color: white;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.8);
    }

    #eraserBtn {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.8);
    }
    
    /* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–∏–±—Ä–∞–Ω–æ–≥–æ –∫–æ–ª—å–æ—Ä—É */
    #currentColorIndicator {
      position: fixed;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
      z-index: 1002;
      display: none;
    }

    /* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º—É */
    #modeIndicator {
      position: fixed;
      bottom: 145px;
      left: calc(50% + 25px);
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: bold;
      z-index: 1002;
      display: none;
    }
    
    h1 {
      font-size: clamp(20px, 6vw, 30px);
      margin: 8px 0;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
    }
    
    h2 {
      font-size: clamp(18px, 5vw, 24px);
      margin: 8px 0;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
    }
    
    p {
      font-size: clamp(12px, 3.5vw, 16px);
      margin: 6px 0;
      line-height: 1.4;
      max-width: 90%;
    }

    #imageLoading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 16px;
      z-index: 1004;
      background: rgba(0, 0, 0, 0.8);
      padding: 12px 20px;
      border-radius: 12px;
      display: none;
    }

    .brush-size-text {
      font-size: clamp(10px, 2.5vw, 12px);
      margin-bottom: 4px;
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä */
    #progressBar {
      position: fixed;
      top: max(12px, env(safe-area-inset-top, 12px));
      right: 70px;
      background: rgba(255, 255, 255, 0.9);
      color: #ff1493;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
      z-index: 1002;
      display: none;
    }

    /* –î–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—å –¥–ª—è –¥–µ–±–∞–≥ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó */
    .debug-info {
      position: fixed;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.7);
      color: lime;
      padding: 4px;
      font-size: 10px;
      z-index: 1005;
      display: none;
    }

    /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
    @media (max-height: 600px) {
      #colorPalette {
        bottom: 80px;
        padding: 6px;
      }
      
      .colorBtn {
        width: 28px;
        height: 28px;
        min-width: 28px;
      }
      
      #brushSliderContainer {
        bottom: 45px;
      }
      
      #currentColorIndicator {
        bottom: 120px;
        width: 25px;
        height: 25px;
      }

      .action-btn {
        width: 38px;
        height: 38px;
        font-size: 16px;
      }

      #modeIndicator {
        bottom: 125px;
        font-size: 9px;
      }
    }

    /* –î–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ—ó –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—ó */
    @media (max-height: 500px) and (orientation: landscape) {
      #colorPalette {
        bottom: 60px;
      }
      
      #brushSliderContainer {
        bottom: 40px;
      }
      
      .action-buttons {
        bottom: 8px;
      }

      #currentColorIndicator {
        bottom: 100px;
      }
    }
  </style>
</head>
<body>

  <canvas id="coloringCanvas"></canvas>
  <button id="closeBtn">‚úï</button>
  <div id="hintTextOnPuzzle"></div>
  <div id="loadingIndicator">Loading...</div>
  <div id="imageLoading">Loading image...</div>
  <div id="progressBar">0/12</div>
  <div id="debugInfo" class="debug-info"></div>

  <button id="langBtn">UA</button>
  <button id="soundBtn">üîà</button>
  <a href="https://smartlessa.etsy.com" target="_blank" id="etsyBtn">Our Store</a>

  <div id="currentColorIndicator"></div>
  <div id="modeIndicator"></div>
  <div id="colorPalette">
    <div class="color-scroll-container" id="colorScrollContainer"></div>
  </div>
  <div id="brushSliderContainer">
    <div class="brush-size-text" data-en="Brush Size" data-ua="–†–æ–∑–º—ñ—Ä –ø–µ–Ω–∑–ª—è">Brush Size</div>
    <input type="range" id="brushSlider" min="2" max="30" value="8">
  </div>
  
  <div class="action-buttons">
    <button id="undoBtn" title="Undo">‚Ü∂</button>
    <button id="eraserBtn" title="Eraser">üßΩ</button>
    <button id="screenshotBtn" title="Save">üì∑</button>
    <button id="clearBtn" title="Clear All">üóëÔ∏è</button>
  </div>

  <div id="startScreen" class="screen">
    <h1 data-en="Magic Coloring" data-ua="–ú–∞–≥—ñ—á–Ω–∞ –†–æ–∑–º–∞–ª—å–æ–≤–∫–∞">Magic Coloring</h1>
    <p data-en="12 magical coloring pages for you" data-ua="12 —á–∞—Ä—ñ–≤–Ω–∏—Ö —Ä–æ–∑–º–∞–ª—å–æ–≤–æ–∫ –¥–ª—è —Ç–µ–±–µ">12 magical coloring pages for you</p>
    <button id="startBtn" data-en="START THE MAGIC!" data-ua="–ü–û–ß–ê–¢–ò –ú–ê–ì–Ü–Æ!">START THE MAGIC!</button>
  </div>

  <div id="hintScreen" class="screen" style="display:none">
    <h2 data-en="Find any picture from the calendar!" data-ua="–ó–Ω–∞–π–¥–∏ –±—É–¥—å-—è–∫—É –∫–∞—Ä—Ç–∏–Ω–∫—É –∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è!">
      Find any picture from the calendar!
    </h2>
    <p data-en="Show it to the camera ‚Äî and a coloring page will appear!" data-ua="–ü–æ–∫–∞–∂–∏ —ó—ó –∫–∞–º–µ—Ä—ñ ‚Äî —ñ –∑'—è–≤–∏—Ç—å—Å—è —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∞">
      Show it to the camera ‚Äî and a coloring page will appear!
    </p>
  </div>

  <audio id="bgMusic" loop preload="auto">
    <source src="fon/fon1.mp3" type="audio/mp3">
  </audio>

  <a-scene embedded
    mindar-image="imageTargetSrc: ./calendar.mind; filterMinCF:0.001; filterBeta:0.01; warmupTolerance:5; autoStart:false;"
    renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true; alpha:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    loading-screen="enabled:false"
    style="position:fixed;inset:0;background:transparent !important;">
    <a-camera active="false" mindar-image-target></a-camera>
  </a-scene>

  <script>
    console.log('üé® Magic Coloring –∑–∞–ø—É—â–µ–Ω–æ');

    const COLORING_PAGES = Array.from({length:12},(_,i)=>({
      id: i,
      image: `images/${String(i+1).padStart(2,'0')}.jpg`
    }));

    // –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –ø–∞–ª—ñ—Ç—Ä–∞ –∫–æ–ª—å–æ—Ä—ñ–≤: –≤—ñ–¥ —á–æ—Ä–Ω–æ–≥–æ –¥–æ –±—ñ–ª–æ–≥–æ + –∫–æ–ª—å–æ—Ä–∏ –≤–µ—Å–µ–ª–∫–∏
    const COLORS = [
      // –ì—Ä–∞–¥—ñ—î–Ω—Ç —Å—ñ—Ä–æ–≥–æ
      '#000000', '#333333', '#666666', '#999999', '#CCCCCC', '#FFFFFF',
      // –ö–æ–ª—å–æ—Ä–∏ –≤–µ—Å–µ–ª–∫–∏
      '#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#8B00FF',
      // –î–æ–¥–∞—Ç–∫–æ–≤—ñ —è—Å–∫—Ä–∞–≤—ñ –∫–æ–ª—å–æ—Ä–∏
      '#FF1493', '#00CED1', '#FFD700', '#32CD32', '#FF69B4', '#1E90FF',
      '#FF4500', '#00FA9A', '#DA70D6', '#FF8C00', '#40E0D0', '#FF6347'
    ];

    let currentColoring = null;
    let currentMarkerId = null;
    let started = false;
    let isUA = false;
    let arSystem = null;
    let brushColor = COLORS[0];
    let brushSize = 8;
    let discoveredMarkers = new Set();
    let isEraserMode = false;
    let originalBrushColor = COLORS[0];

    const music = document.getElementById('bgMusic');
    music.volume = 0.3;
    let soundOn = false;

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ª–∞–¥–∫–∏
    function debugLog(message) {
      console.log('üîß ' + message);
      document.getElementById('debugInfo').textContent = message;
      document.getElementById('debugInfo').style.display = 'block';
      setTimeout(() => {
        document.getElementById('debugInfo').style.display = 'none';
      }, 3000);
    }

    function updateProgress() {
      const progress = discoveredMarkers.size;
      document.getElementById('progressBar').textContent = `${progress}/12`;
      if (progress > 0) {
        document.getElementById('progressBar').style.display = 'block';
      }
    }

    function saveDrawing(markerId) {
      if (!currentColoring) return;
      try {
        const dataURL = currentColoring.canvas.toDataURL('image/jpeg', 0.7);
        localStorage.setItem(`coloring-${markerId}`, dataURL);
        discoveredMarkers.add(markerId);
        updateProgress();
        debugLog('–ú–∞–ª—é–Ω–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ: ' + markerId);
      } catch (e) {
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', e);
      }
    }

    function playMusic() {
      if (soundOn && music.paused) {
        music.play().catch(e => {
          console.log('Audio play failed:', e);
        });
      }
    }

    function setLanguage(ua) {
      isUA = ua;
      document.querySelectorAll('[data-ua]').forEach(el => {
        if (el.dataset.ua && el.dataset.en) {
          el.textContent = ua ? el.dataset.ua : el.dataset.en;
        }
      });
      document.getElementById('langBtn').textContent = ua ? 'EN' : 'UA';
      document.getElementById('loadingIndicator').textContent = ua ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : 'Loading...';
      document.getElementById('imageLoading').textContent = ua ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...' : 'Loading image...';
      document.getElementById('etsyBtn').textContent = ua ? '–ù–∞—à –º–∞–≥–∞–∑–∏–Ω' : 'Our Store';
      document.getElementById('hintTextOnPuzzle').textContent = ua ?
        '–ú–∞–ª—é–π –ø–∞–ª—å—á–∏–∫–æ–º! –ó–±–µ—Ä—ñ–≥–∞–π üì∏' : 'Draw with your finger! Save üì∏';
      
      // –û–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
      document.getElementById('undoBtn').title = ua ? '–ù–∞–∑–∞–¥' : 'Undo';
      document.getElementById('screenshotBtn').title = ua ? '–ó–±–µ—Ä–µ–≥—Ç–∏' : 'Save';
      document.getElementById('clearBtn').title = ua ? '–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ' : 'Clear All';
      document.getElementById('eraserBtn').title = ua ? '–ì—É–º–∫–∞' : 'Eraser';
      
      // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º—É
      updateModeIndicator();
    }

    function updateModeIndicator() {
      const modeIndicator = document.getElementById('modeIndicator');
      if (isEraserMode) {
        modeIndicator.textContent = isUA ? '–ì—É–º–∫–∞' : 'Eraser';
        modeIndicator.style.display = 'block';
      } else {
        modeIndicator.style.display = 'none';
      }
    }

    function toggleEraser() {
      isEraserMode = !isEraserMode;
      
      if (isEraserMode) {
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–ª—ñ—Ä —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≥—É–º–∫—É
        originalBrushColor = brushColor;
        brushColor = '#FFFFFF'; // –ë—ñ–ª–∏–π –∫–æ–ª—ñ—Ä –¥–ª—è –≥—É–º–∫–∏
        document.getElementById('eraserBtn').classList.add('active');
        debugLog('–†–µ–∂–∏–º –≥—É–º–∫–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ');
      } else {
        // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–ª—ñ—Ä
        brushColor = originalBrushColor;
        document.getElementById('eraserBtn').classList.remove('active');
        debugLog('–†–µ–∂–∏–º –≥—É–º–∫–∏ –≤–∏–º–∫–Ω–µ–Ω–æ');
      }
      
      updateModeIndicator();
      updateColorButtons();
    }

    function updateColorButtons() {
      document.querySelectorAll('.colorBtn').forEach((btn, index) => {
        if (brushColor === COLORS[index] && !isEraserMode) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    function showMessage(text) {
      const hint = document.getElementById('hintTextOnPuzzle');
      hint.textContent = text;
      hint.style.display = 'block';
      setTimeout(() => hint.style.display = 'none', 2000);
    }

    function hideColoringUI() {
      document.getElementById('coloringCanvas').style.display = 'none';
      document.getElementById('colorPalette').style.display = 'none';
      document.getElementById('brushSliderContainer').style.display = 'none';
      document.querySelector('.action-buttons').style.display = 'none';
      document.getElementById('closeBtn').style.display = 'none';
      document.getElementById('hintTextOnPuzzle').style.display = 'none';
      document.getElementById('currentColorIndicator').style.display = 'none';
      document.getElementById('modeIndicator').style.display = 'none';
      document.getElementById('imageLoading').style.display = 'none';
      debugLog('UI —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∏ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ');
    }

    function showColoringUI() {
      // –ö–†–ò–¢–ò–ß–ù–û: —Ö–æ–≤–∞—î–º–æ –µ–∫—Ä–∞–Ω –ø—ñ–¥–∫–∞–∑–∫–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º UI —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∏
      document.getElementById('hintScreen').style.display = 'none';
      
      document.getElementById('coloringCanvas').style.display = 'block';
      document.getElementById('colorPalette').style.display = 'block';
      document.getElementById('brushSliderContainer').style.display = 'block';
      document.querySelector('.action-buttons').style.display = 'flex';
      document.getElementById('closeBtn').style.display = 'block';
      document.getElementById('hintTextOnPuzzle').style.display = 'block';
      document.getElementById('currentColorIndicator').style.display = 'block';
      
      updateModeIndicator();
      updateColorButtons();
      
      debugLog('UI —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∏ –ø–æ–∫–∞–∑–∞–Ω–æ');
    }

    class ColoringApp {
      constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.image = null;
        this.isDrawing = false;
        this.lastX = 0;
        this.lastY = 0;
        this.imageWidth = 0;
        this.imageHeight = 0;
        
        // –Ü—Å—Ç–æ—Ä—ñ—è –¥–ª—è Undo
        this.history = [];
        this.maxHistorySize = 20;
        
        this.setupCanvas();
        this.setupEvents();
        debugLog('ColoringApp —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
      }

      setupCanvas() {
        // –°–ø–æ—á–∞—Ç–∫—É –Ω–µ–≤–µ–ª–∏–∫—ñ —Ä–æ–∑–º—ñ—Ä–∏
        this.canvas.width = 400;
        this.canvas.height = 500;
        this.canvas.style.width = '400px';
        this.canvas.style.height = '500px';
        
        // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è
        this.ctx.imageSmoothingEnabled = true;
        this.ctx.imageSmoothingQuality = 'high';
        this.ctx.globalCompositeOperation = 'source-over';
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        
        // –û—á–∏—â–∞—î–º–æ canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        debugLog('Canvas –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ');
      }

      setImage(img) {
        this.image = img;
        debugLog('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ' + img.width + 'x' + img.height);
        
        const maxWidth = Math.min(window.innerWidth * 0.8, 500);
        const maxHeight = Math.min(window.innerHeight * 0.7, 600);
        
        let width = img.width;
        let height = img.height;
        
        // –ú–∞—Å—à—Ç–∞–±—É—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        const scale = Math.min(maxWidth / width, maxHeight / height);
        width = width * scale;
        height = height * scale;
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ canvas
        this.canvas.width = width;
        this.canvas.height = height;
        this.canvas.style.width = width + 'px';
        this.canvas.style.height = height + 'px';
        
        this.imageWidth = width;
        this.imageHeight = height;
        
        this.redraw();
        debugLog('Canvas —Ä–æ–∑–º—ñ—Ä: ' + width + 'x' + height);
      }

      redraw() {
        if (!this.image) return;
        
        // –û—á–∏—â–∞—î–º–æ canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // –ú–∞–ª—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        this.ctx.drawImage(this.image, 0, 0, this.imageWidth, this.imageHeight);
        debugLog('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–º–∞–ª—å–æ–≤–∞–Ω–æ');
      }

      // –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –≤ —ñ—Å—Ç–æ—Ä—ñ—é
      saveState() {
        if (this.history.length >= this.maxHistorySize) {
          this.history.shift();
        }
        
        this.history.push(this.canvas.toDataURL());
        debugLog('–°—Ç–∞–Ω –∑–±–µ—Ä–µ–∂–µ–Ω–æ. –Ü—Å—Ç–æ—Ä—ñ—è: ' + this.history.length);
      }

      // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Å—Ç–∞–Ω (Undo)
      undo() {
        if (this.history.length > 0) {
          this.history.pop();
          
          if (this.history.length > 0) {
            const lastState = this.history[this.history.length - 1];
            const img = new Image();
            img.onload = () => {
              this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
              this.ctx.drawImage(this.image, 0, 0, this.imageWidth, this.imageHeight);
              this.ctx.drawImage(img, 0, 0);
            };
            img.src = lastState;
          } else {
            this.redraw();
          }
          
          debugLog('Undo –≤–∏–∫–æ–Ω–∞–Ω–æ. –ó–∞–ª–∏—à–∏–ª–æ—Å—å —Å—Ç–∞–Ω—ñ–≤: ' + this.history.length);
          showMessage(isUA ? '‚Ü∂ –û—Å—Ç–∞–Ω–Ω—ñ–π —à—Ç—Ä–∏—Ö –≤–∏–¥–∞–ª–µ–Ω–æ' : '‚Ü∂ Last stroke removed');
        } else {
          debugLog('–ù–µ–º–∞—î —â–æ –≤—ñ–¥–º—ñ–Ω—è—Ç–∏');
          showMessage(isUA ? '‚ùå –ù–µ–º–∞—î —â–æ –≤—ñ–¥–º—ñ–Ω—è—Ç–∏' : '‚ùå Nothing to undo');
        }
      }

      // –û—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å –º–∞–ª—é–Ω–æ–∫
      clear() {
        if (confirm(isUA ? '–û—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å –º–∞–ª—é–Ω–æ–∫?' : 'Clear all drawing?')) {
          this.history = [];
          this.redraw();
          debugLog('–í–µ—Å—å –º–∞–ª—é–Ω–æ–∫ –æ—á–∏—â–µ–Ω–æ');
          showMessage(isUA ? 'üóëÔ∏è –í—Å–µ –æ—á–∏—â–µ–Ω–æ' : 'üóëÔ∏è All cleared');
        }
      }

      setupEvents() {
        const getCoords = (e) => {
          const rect = this.canvas.getBoundingClientRect();
          let clientX, clientY;
          
          if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }
          
          const x = clientX - rect.left;
          const y = clientY - rect.top;
          
          return { x, y };
        };

        const startDrawing = (e) => {
          debugLog('–ü–æ—á–∞—Ç–æ–∫ –º–∞–ª—é–≤–∞–Ω–Ω—è');
          this.isDrawing = true;
          const coords = getCoords(e);
          this.lastX = coords.x;
          this.lastY = coords.y;
          
          // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º –º–∞–ª—é–≤–∞–Ω–Ω—è
          this.saveState();
          
          // –ü–æ—á–∏–Ω–∞—î–º–æ –Ω–æ–≤–∏–π —à–ª—è—Ö
          this.ctx.beginPath();
          this.ctx.moveTo(this.lastX, this.lastY);
          
          if (e.type.includes('touch')) {
            e.preventDefault();
          }
        };

        const draw = (e) => {
          if (!this.isDrawing) return;
          
          const coords = getCoords(e);
          const currentX = coords.x;
          const currentY = coords.y;
          
          // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –ø–µ–Ω–∑–µ–ª—å
          this.ctx.lineWidth = brushSize;
          this.ctx.strokeStyle = brushColor;
          this.ctx.globalCompositeOperation = isEraserMode ? 'destination-out' : 'source-over';
          
          // –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—é
          this.ctx.lineTo(currentX, currentY);
          this.ctx.stroke();
          
          this.lastX = currentX;
          this.lastY = currentY;
          
          if (e.type.includes('touch')) {
            e.preventDefault();
          }
        };

        const stopDrawing = () => {
          debugLog('–ö—ñ–Ω–µ—Ü—å –º–∞–ª—é–≤–∞–Ω–Ω—è');
          this.isDrawing = false;
          this.ctx.beginPath();
          // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º –º–∞–ª—é–≤–∞–Ω–Ω—è
          this.ctx.globalCompositeOperation = 'source-over';
        };

        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
        this.canvas.addEventListener('mousedown', startDrawing);
        this.canvas.addEventListener('mousemove', draw);
        this.canvas.addEventListener('mouseup', stopDrawing);
        this.canvas.addEventListener('mouseleave', stopDrawing);
        
        this.canvas.addEventListener('touchstart', startDrawing, { passive: false });
        this.canvas.addEventListener('touchmove', draw, { passive: false });
        this.canvas.addEventListener('touchend', stopDrawing);
        this.canvas.addEventListener('touchcancel', stopDrawing);
        
        debugLog('–ü–æ–¥—ñ—ó –º–∞–ª—é–≤–∞–Ω–Ω—è –¥–æ–¥–∞–Ω–æ');
      }
    }

    function initUI() {
      const colorContainer = document.getElementById('colorScrollContainer');
      colorContainer.innerHTML = '';
      
      COLORS.forEach((c, index) => {
        const btn = document.createElement('button');
        btn.className = 'colorBtn';
        btn.style.background = c;
        btn.onclick = () => { 
          if (isEraserMode) {
            toggleEraser(); // –í–∏–º–∏–∫–∞—î–º–æ –≥—É–º–∫—É –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –∫–æ–ª—å–æ—Ä—É
          }
          brushColor = c;
          document.getElementById('currentColorIndicator').style.background = c;
          updateColorButtons();
          debugLog('–û–±—Ä–∞–Ω–æ –∫–æ–ª—ñ—Ä: ' + c);
        };
        colorContainer.appendChild(btn);
      });
      
      document.getElementById('currentColorIndicator').style.background = brushColor;
      updateColorButtons();

      document.getElementById('brushSlider').oninput = (e) => {
        brushSize = parseInt(e.target.value);
        debugLog('–†–æ–∑–º—ñ—Ä –ø–µ–Ω–∑–ª—è: ' + brushSize);
      };

      document.getElementById('langBtn').onclick = () => setLanguage(!isUA);
      
      document.getElementById('soundBtn').onclick = () => {
        soundOn = !soundOn;
        if (soundOn) {
          playMusic();
          document.getElementById('soundBtn').textContent = 'üîä';
        } else {
          music.pause();
          document.getElementById('soundBtn').textContent = 'üîà';
        }
        debugLog('–ó–≤—É–∫: ' + (soundOn ? 'ON' : 'OFF'));
      };

      document.getElementById('screenshotBtn').onclick = () => {
        if (!currentColoring) return;
        
        const link = document.createElement('a');
        link.download = `magic-coloring-${currentMarkerId + 1}.png`;
        link.href = currentColoring.canvas.toDataURL('image/png');
        link.click();
        
        showMessage(isUA ? 'üì∏ –ó–Ω—ñ–º–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!' : 'üì∏ Screenshot saved!');
        saveDrawing(currentMarkerId);
      };

      // –ö–Ω–æ–ø–∫–∞ Undo
      document.getElementById('undoBtn').onclick = () => {
        if (currentColoring) {
          currentColoring.undo();
        }
      };

      // –ö–Ω–æ–ø–∫–∞ Clear All
      document.getElementById('clearBtn').onclick = () => {
        if (currentColoring) {
          currentColoring.clear();
        }
      };

      // –ö–Ω–æ–ø–∫–∞ Eraser
      document.getElementById('eraserBtn').onclick = toggleEraser;

      document.getElementById('closeBtn').onclick = () => {
        debugLog('–ó–∞–∫—Ä–∏—Ç—Ç—è —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∏');
        if (currentColoring) {
          saveDrawing(currentMarkerId);
        }
        
        hideColoringUI();
        currentColoring = null;
        currentMarkerId = null;
        // –í–∏–º–∏–∫–∞—î–º–æ –≥—É–º–∫—É –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
        if (isEraserMode) {
          toggleEraser();
        }
        // –ü–æ–∫–∞–∑—É—î–º–æ –µ–∫—Ä–∞–Ω –ø—ñ–¥–∫–∞–∑–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
        document.getElementById('hintScreen').style.display = 'flex';
      };
    }

    const screens = {
      show(name) {
        ['start','hint'].forEach(s => {
          const el = document.getElementById(s + 'Screen');
          if (el) el.style.display = (name === s) ? 'flex' : 'none';
        });
        document.getElementById('loadingIndicator').style.display = (name === 'loading') ? 'block' : 'none';
      }
    };

    document.getElementById('startBtn').onclick = async () => {
      if (started) return;
      started = true;
      screens.show('loading');
      debugLog('–°—Ç–∞—Ä—Ç AR...');
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment" } 
        });
        
        stream.getTracks().forEach(track => track.stop());
        
        arSystem = document.querySelector('a-scene').systems['mindar-image-system'];
        if (arSystem) {
          arSystem.start();
          screens.show('hint');
          playMusic();
          debugLog('AR –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
        } else {
          throw new Error('AR system not found');
        }
      } catch (e) {
        console.error('Camera error:', e);
        alert(isUA ? "–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏!" : "Allow camera access!");
        started = false;
        screens.show('start');
        debugLog('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: ' + e.message);
      }
    };

    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log('‚úÖ AR –≥–æ—Ç–æ–≤–∏–π');
      debugLog('AR —Å—Ü–µ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
      
      initUI();
      
      COLORING_PAGES.forEach(cfg => {
        const entity = document.createElement('a-entity');
        entity.setAttribute('mindar-image-target', `targetIndex: ${cfg.id}`);
        
        entity.addEventListener('targetFound', async () => {
          if (currentMarkerId === cfg.id) return;
          if (currentColoring) return;

          debugLog('–ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ: ' + cfg.id);
          currentMarkerId = cfg.id;

          try {
            document.getElementById('imageLoading').style.display = 'block';
            debugLog('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...');

            const img = new Image();
            
            await new Promise((resolve, reject) => {
              img.onload = () => {
                debugLog('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
                resolve();
              };
              img.onerror = () => {
                debugLog('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è');
                reject(new Error('Failed to load image'));
              };
              img.src = cfg.image + '?v=' + Date.now();
            });

            document.getElementById('imageLoading').style.display = 'none';
            debugLog('–õ–æ–∞–¥–µ—Ä –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ');

            currentColoring = new ColoringApp('coloringCanvas');
            currentColoring.setImage(img);

            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–µ
            const saved = localStorage.getItem(`coloring-${cfg.id}`);
            if (saved) {
              const savedImg = new Image();
              savedImg.onload = () => {
                currentColoring.ctx.drawImage(savedImg, 0, 0);
                debugLog('–ó–±–µ—Ä–µ–∂–µ–Ω–∏–π –º–∞–ª—é–Ω–æ–∫ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ');
              };
              savedImg.src = saved;
            }

            // –ö–†–ò–¢–ò–ß–ù–û: –ø–æ–∫–∞–∑—É—î–º–æ UI —Ä–æ–∑–º–∞–ª—å–æ–≤–∫–∏ —Ç–∞ —Ö–æ–≤–∞—î–º–æ –µ–∫—Ä–∞–Ω –ø—ñ–¥–∫–∞–∑–∫–∏
            showColoringUI();
            
            showMessage(isUA ? 
              '–ú–∞–ª—é–π –ø–∞–ª—å—á–∏–∫–æ–º! –ó–±–µ—Ä—ñ–≥–∞–π üì∏' : 
              'Draw with your finger! Save üì∏'
            );
            
          } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:', error);
            document.getElementById('imageLoading').style.display = 'none';
            showMessage(isUA ? 
              '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è' : 
              'Error loading image'
            );
            debugLog('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
          }
        });

        entity.addEventListener('targetLost', () => {
          if (currentMarkerId === cfg.id) {
            debugLog('–ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ: ' + cfg.id);
            if (currentColoring) {
              saveDrawing(currentMarkerId);
            }
            hideColoringUI();
            currentColoring = null;
            currentMarkerId = null;
            // –í–∏–º–∏–∫–∞—î–º–æ –≥—É–º–∫—É –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –º–∞—Ä–∫–µ—Ä–∞
            if (isEraserMode) {
              toggleEraser();
            }
            // –ü–æ–∫–∞–∑—É—î–º–æ –µ–∫—Ä–∞–Ω –ø—ñ–¥–∫–∞–∑–∫–∏ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –º–∞—Ä–∫–µ—Ä–∞
            document.getElementById('hintScreen').style.display = 'flex';
          }
        });

        document.querySelector('a-scene').appendChild(entity);
      });
      
      setLanguage(false);
      screens.show('start');
    });

    music.addEventListener('error', (e) => {
      console.log('Audio load error:', e);
      document.getElementById('soundBtn').style.display = 'none';
      debugLog('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—É–¥—ñ–æ');
    });

    // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
    window.addEventListener('load', () => {
      for (let i = 0; i < 12; i++) {
        if (localStorage.getItem(`coloring-${i}`)) {
          discoveredMarkers.add(i);
        }
      }
      updateProgress();
      debugLog('–î–æ–¥–∞—Ç–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
    });
  </script>
</body>
</html>
