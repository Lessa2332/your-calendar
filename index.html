<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Magical Ukraine Calendar 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAAAAAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAP//AP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAT/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wAARCAABAAEDAREAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnKytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnKytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9AAAAAElFTkSuQmCC">
 
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
   
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif;
      touch-action: none;
      position: fixed;
    }
   
    #mindar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      background: #000;
    }
   
    #ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: env(safe-area-inset-top, 0px) env(safe-area-inset-right, 0px)
                env(safe-area-inset-bottom, 0px) env(safe-area-inset-left, 0px);
    }
   
    #info {
      text-align: center;
      color: white;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 16px;
      font-size: clamp(14px, 4vw, 18px);
      line-height: 1.4;
      max-width: 90%;
      margin: 0 auto;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
   
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: max(12px, env(safe-area-inset-top, 12px)) 12px 0;
      gap: 10px;
      flex-wrap: wrap;
    }
   
    .lang-btn, .etsy-btn {
      pointer-events: auto;
      background: rgba(0, 200, 255, 0.25);
      border: 1px solid rgba(0, 255, 255, 0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
   
    .lang-btn:hover, .etsy-btn:hover {
      background: rgba(0, 200, 255, 0.4);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
    }
   
    #crystals {
      display: flex;
      gap: clamp(6px, 2.5vw, 12px);
      justify-content: center;
      padding: 0 8px max(20px, env(safe-area-inset-bottom, 20px));
      flex-wrap: wrap;
    }
   
    .crystal-slot {
      width: clamp(36px, 10vw, 52px);
      height: clamp(36px, 10vw, 52px);
      border: 2px solid rgba(0, 255, 255, 0.5);
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(20px, 6vw, 32px);
      color: white;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
    }
   
    .crystal-slot.collected {
      background: linear-gradient(135deg, #00ffff, #ff00ff);
      border-color: #ffffff;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
      animation: pulse 2s infinite;
    }
   
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
   
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: white;
    }
   
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #00ffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
   
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
   
    .error-message {
      background: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      max-width: 80%;
      margin: 20px auto;
    }
  </style>
</head>
<body>
<div id="mindar-container"></div>
<div id="ui">
  <div id="top-bar">
    <button class="lang-btn" id="lang-toggle">Українська</button>
    <a class="etsy-btn" id="etsy-link" href="https://smartlessa.etsy.com" target="_blank" rel="noopener">Shop on Etsy</a>
  </div>
  <div id="info">Point your camera at any calendar marker ❤️</div>
  <div id="crystals"></div>
</div>
<div class="loading-overlay" id="loading">
  <div class="loading-spinner"></div>
  <div id="loading-text">Initializing AR Experience...</div>
</div>
<script>
// === Глобальні змінні ===
let mindarThree = null;
let renderer = null;
let scene = null;
let camera = null;
let arGroups = [];
let currentLang = localStorage.getItem('calendar-lang') || 'en';
let collectedCrystals = JSON.parse(localStorage.getItem('ua-crystals2026') || '[]');
let isARRunning = false;
let currentTarget = -1;
// === Переклади ===
const translations = {
  en: {
    infoScan: "Point your camera at any calendar marker ❤️",
    infoComplete: "UKRAINE'S HEART IS COMPLETE!<br>You are a true hero ❤️",
    langBtn: "Українська",
    etsyBtn: "Shop on Etsy",
    loading: "Initializing AR Experience...",
    errorCamera: "❌ Camera access denied. Please allow camera permissions and refresh.",
    errorAR: "❌ AR initialization failed. Please try again."
  },
  uk: {
    infoScan: "Наведи камеру на будь-який маркер календаря ❤️",
    infoComplete: "СЕРЦЕ УКРАЇНИ ЗІБРАНО!<br>Ти — справжній герой ❤️",
    langBtn: "English",
    etsyBtn: "Купити на Etsy",
    loading: "Ініціалізація AR...",
    errorCamera: "❌ Доступ до камери заборонено. Дозвольте доступ та оновіть сторінку.",
    errorAR: "❌ Помилка ініціалізації AR. Спробуйте ще раз."
  }
};
// === Утиліти ===
function updateUIText() {
  const t = translations[currentLang];
  document.getElementById('info').innerHTML = t.infoScan;
  document.getElementById('lang-toggle').textContent = t.langBtn;
  document.getElementById('etsy-link').textContent = t.etsyBtn;
  document.getElementById('loading-text').textContent = t.loading;
}
function toggleLanguage() {
  currentLang = currentLang === 'en' ? 'uk' : 'en';
  localStorage.setItem('calendar-lang', currentLang);
  updateUIText();
}
function updateCrystalsUI() {
  const container = document.getElementById('crystals');
  container.innerHTML = '';
  for (let i = 0; i < 12; i++) {
    const div = document.createElement('div');
    div.className = 'crystal-slot' + (collectedCrystals.includes(i) ? ' collected' : '');
    div.innerHTML = collectedCrystals.includes(i) ? '✦' : (i + 1);
    container.appendChild(div);
  }
}
function hideLoading() {
  const loading = document.getElementById('loading');
  if (loading) {
    loading.style.opacity = '0';
    setTimeout(() => loading.style.display = 'none', 300);
  }
}
function showError(message) {
  hideLoading();
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error-message';
  errorDiv.innerHTML = message;
  document.body.appendChild(errorDiv);
 
  setTimeout(() => {
    if (errorDiv.parentNode) {
      errorDiv.parentNode.removeChild(errorDiv);
    }
  }, 5000);
}
// === Завантаження скриптів ===
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = () => {
      console.log(`Loaded: ${src}`);
      resolve();
    };
    script.onerror = (e) => {
      console.error(`Failed to load ${src}:`, e);
      reject(new Error(`Failed to load ${src}: ${e.type}`));
    };
    document.head.appendChild(script);
  });
}
// === Ініціалізація AR ===
async function initializeAR() {
  try {
    // Оновлено: Three.js 0.181.1 (остання на листопад 2025)
    await loadScript('https://cdn.jsdelivr.net/npm/three@0.181.1/build/three.min.js');
   
    // MindAR 1.2.5 (остання стабільна)
    await loadScript('https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js');
   
    // Перевіряємо чи завантажились бібліотеки
    if (typeof THREE === 'undefined') {
      throw new Error('Three.js failed to load');
    }
    if (typeof MINDAR === 'undefined') {
      throw new Error('MindAR failed to load');
    }
   
    // Ініціалізуємо MindAR
    mindarThree = new MINDAR.IMAGE.MindARThree({
      container: document.getElementById('mindar-container'),
      imageTargetSrc: 'calendar.mind',
      maxTrack: 6,
      filterMinCF: 0.001,
      filterBeta: 0.01,
      warmupTolerance: 5,
      missTolerance: 8
    });
    ({ renderer, scene, camera } = mindarThree);
   
    // Налаштування рендерера (оптимізовано для мобільних)
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.toneMapping = THREE.ACESFilmicToneMapping; // Додано для кращого освітлення
   
    // Додаємо світло
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
    directionalLight.position.set(1, 1, 1);
    scene.add(ambientLight, directionalLight);
   
    // Створюємо групи для маркерів
    for (let i = 0; i < 12; i++) {
      const group = new THREE.Group();
      const targetGroup = mindarThree.addAnchor(i);
      targetGroup.group.add(group);
      arGroups.push(group);
    }
   
    // Запускаємо AR
    await mindarThree.start();
    isARRunning = true;
   
    // Запускаємо анімацію
    animate();
   
    // Ховаємо loading screen
    hideLoading();
   
  } catch (error) {
    console.error('AR Initialization Error:', error);
    showError(translations[currentLang].errorAR);
  }
}
// === Анімація ===
function animate() {
  if (!isARRunning) return;
 
  renderer.render(scene, camera);
 
  // Перевіряємо видимість маркерів (оптимізовано)
  let visibleTarget = -1;
  for (let i = 0; i < 12; i++) {
    if (arGroups[i] && arGroups[i].visible) {
      visibleTarget = i;
      break;
    }
  }
 
  if (visibleTarget !== currentTarget) {
    if (currentTarget !== -1 && arGroups[currentTarget]) {
      clearTargetGroup(currentTarget);
    }
    if (visibleTarget !== -1) {
      setTimeout(() => handleTargetFound(visibleTarget), 100);
    }
    currentTarget = visibleTarget;
  }
 
  requestAnimationFrame(animate);
}
function clearTargetGroup(index) {
  const group = arGroups[index];
  if (group) {
    // Покращено: правильне очищення ресурсів
    while (group.children.length > 0) {
      const child = group.children[0];
      if (child.material) {
        if (child.material.map) child.material.map.dispose();
        child.material.dispose();
      }
      if (child.geometry) child.geometry.dispose();
      group.remove(child);
    }
  }
}
function handleTargetFound(targetIndex) {
  if (collectedCrystals.includes(targetIndex)) {
    showCrystalReward(targetIndex);
  } else {
    showMonthContent(targetIndex);
  }
}
// === Основний функціонал ===
function showMonthContent(monthIndex) {
  const group = arGroups[monthIndex];
  if (!group) return;
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = function() {
    const texture = new THREE.Texture(img);
    texture.needsUpdate = true;
   
    const aspect = img.width / img.height;
    const size = Math.min(1.6, window.innerWidth / 1000 * 1.6);
    const geometry = new THREE.PlaneGeometry(size, size / aspect);
   
    const material = new THREE.MeshBasicMaterial({
      map: texture,
      transparent: true,
      opacity: 0.9
    });
   
    const mesh = new THREE.Mesh(geometry, material);
    mesh.position.z = 0.01;
    group.add(mesh);
   
    // Додаємо обробник кліку (одноразовий)
    const handleClick = () => {
      startPuzzleInteraction(monthIndex, texture, group, size, size / aspect);
      renderer.domElement.removeEventListener('click', handleClick);
    };
   
    renderer.domElement.addEventListener('click', handleClick, { once: true });
  };
  img.onerror = () => {
    console.error(`Failed to load image for month ${monthIndex + 1}`);
    group.add(new THREE.Mesh(
      new THREE.PlaneGeometry(1, 1),
      new THREE.MeshBasicMaterial({ color: 0xff0000 })
    ));
  };
 
  img.src = `images/${(monthIndex + 1).toString().padStart(2, '0')}.png`;
}
function startPuzzleInteraction(monthIndex, texture, group, width, height) {
  // Спрощена версія пазлу для демонстрації (можна розширити)
  // Очищуємо групу
  clearTargetGroup(monthIndex);
 
  const geometry = new THREE.PlaneGeometry(width, height);
  const material = new THREE.MeshBasicMaterial({
    map: texture,
    transparent: true
  });
 
  const mesh = new THREE.Mesh(geometry, material);
  group.add(mesh);
 
  // Анімація зникнення (плавніша)
  let opacity = 1;
  const animateOut = () => {
    opacity -= 0.02;
    material.opacity = opacity;
   
    if (opacity > 0) {
      requestAnimationFrame(animateOut);
    } else {
      clearTargetGroup(monthIndex);
      showCrystalReward(monthIndex);
    }
  };
 
  setTimeout(() => animateOut(), 500);
}
function showCrystalReward(monthIndex) {
  if (collectedCrystals.includes(monthIndex)) return;
 
  collectedCrystals.push(monthIndex);
  localStorage.setItem('ua-crystals2026', JSON.stringify(collectedCrystals));
  updateCrystalsUI();
 
  const group = arGroups[monthIndex];
  if (!group) return;
 
  clearTargetGroup(monthIndex);
 
  const colors = ['#00ffff','#ff00ff','#00ff00','#ffff00','#ff8800','#ff0066',
                 '#0066ff','#ff3399','#33ff99','#ffcc00','#cc00ff','#00ccff'];
 
  const geometry = new THREE.SphereGeometry(0.3, 16, 16);
  const material = new THREE.MeshBasicMaterial({
    color: colors[monthIndex],
    transparent: true,
    opacity: 0.9
  });
 
  const crystal = new THREE.Mesh(geometry, material);
  group.add(crystal);
 
  // Анімація кристала (оптимізовано)
  const animateCrystal = () => {
    if (group.visible && isARRunning) {
      crystal.rotation.y += 0.02;
      crystal.rotation.x += 0.01;
      requestAnimationFrame(animateCrystal);
    }
  };
 
  animateCrystal();
 
  // Перевіряємо чи всі кристали зібрані
  if (collectedCrystals.length === 12) {
    setTimeout(() => {
      document.getElementById('info').innerHTML = translations[currentLang].infoComplete;
    }, 1000);
  }
}
// === Обробники подій ===
function onWindowResize() {
  if (!camera || !renderer) return;
 
  const width = window.innerWidth;
  const height = window.innerHeight;
 
  camera.aspect = width / height;
  camera.updateProjectionMatrix();
  renderer.setSize(width, height);
}
// === Ініціалізація додатку ===
document.addEventListener('DOMContentLoaded', function() {
  // Налаштовуємо UI
  updateUIText();
  updateCrystalsUI();
 
  // Додаємо обробники подій
  document.getElementById('lang-toggle').addEventListener('click', toggleLanguage);
 
  window.addEventListener('resize', onWindowResize);
  window.addEventListener('orientationchange', function() {
    setTimeout(onWindowResize, 300);
  });
 
  // Запускаємо AR
  initializeAR();
});
// Cleanup при закритті сторінки
window.addEventListener('beforeunload', function() {
  if (mindarThree) {
    mindarThree.stop();
    isARRunning = false;
  }
});
</script>
</body>
</html>
