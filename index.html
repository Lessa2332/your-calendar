<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Дитячий AR-пазл 3×3</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@2.2.0/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body { margin:0; overflow:hidden; font-family:"Comic Sans MS",cursive,sans-serif; }
    .hint {
      position:absolute; top:10px; left:0; right:0; text-align:center;
      font-size:26px; color:#fff; background:rgba(0,0,0,0.6); padding:12px; border-radius:20px;
      z-index:100;
    }
    .win {
      position:absolute; inset:0; background:rgba(0,0,0,0.95);
      color:gold; font-size:80px; display:none; align-items:center;
      justify-content:center; flex-direction:column; z-index:200;
    }
    .win span { animation:bounce 1.2s infinite; }
    @keyframes bounce { 0%,100%{transform:scale(1)} 50%{transform:scale(1.3)} }
  </style>
</head>
<body>

  <div class="hint">Наведи камеру на маркер</div>
  <div class="win" id="win">
    <span>УРА!</span><br>ТИ ЗІБРАВ ПАЗЛ!
  </div>

  <!-- MindAR сена з маркером у корені -->
  <a-scene embedded mindar-image="imageTargetSrc: calendar.mind; filterMinCF:0.0001; filterBeta:1000;"
           renderer="colorManagement:true; physicallyCorrectLights: true" vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:false">

    <a-entity camera></a-entity>

    <!-- Пазл з’явиться тут -->
    <a-entity mindar-image-target="targetIndex:0">
      <a-entity id="puzzle-container"></a-entity>
    </a-entity>

  </a-scene>

  <script>
    document.querySelector('a-scene').addEventListener('arReady', () => {
      setTimeout(createPuzzle, 1200); // трохи почекаємо стабільного трекінгу
    });

    async function createPuzzle() {
      const container = document.getElementById('puzzle-container');
      
      // Завантажуємо ціле фото з папки images
      const img = new Image();
      img.src = 'images/01.jpg?' + Date.now(); // ?+timestamp щоб не кешувалося
      await img.decode();

      const pieceW = img.width / 3;
      const pieceH = img.height / 3;
      const scaleW = 0.5 / 3;   // весь пазл шириною 0.5 м
      const scaleH = (img.height / img.width) * 0.5 / 3;

      const pieces = [];

      for (let y = 0; y < 3; y++) {
        for (let x = 0; x < 3; x++) {
          // Ріжемо шматочок на canvas
          const canvas = document.createElement('canvas');
          canvas.width = pieceW;
          canvas.height = pieceH;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, x*pieceW, y*pieceH, pieceW, pieceH, 0, 0, pieceW, pieceH);

          // Створюємо a-plane з текстурою
          const plane = document.createElement('a-plane');
          plane.setAttribute('src', canvas.toDataURL());
          plane.setAttribute('width', scaleW * 2);
          plane.setAttribute('height', scaleH * 2);
          
          // Правильна позиція
          const correctX = (x - 1) * scaleW;
          const correctY = (1 - y) * scaleH;
          plane.setAttribute('data-correct', `${correctX} ${correctY}`);

          // Початкова випадкова позиція (ВИПРАВЛЕНО: прибрано "job")
          const randX = (Math.random() - 0.5) * 1.3;
          const randY = (Math.random() - 0.5) * 1.3;
          plane.setAttribute('position', `${randX} ${randY} 0.01`);
          
          plane.classList.add('piece', 'clickable');
          container.appendChild(plane);
          pieces.push(plane);
        }
      }

      // Клік — міняємо місцями з випадковим шматочком
      document.querySelectorAll('.piece').forEach(p => {
        p.addEventListener('click', () => {
          const others = pieces.filter(el => el !== p);
          const swap = others[Math.floor(Math.random() * others.length)];

          const temp = p.getAttribute('position');
          p.setAttribute('position', swap.getAttribute('position'));
          swap.setAttribute('position', temp);

          checkWin();
        });
      });

      function checkWin() {
        let correct = 0;
        pieces.forEach(p => {
          const pos = p.getAttribute('position');
          const [targetX, targetY] = p.getAttribute('data-correct').split(' ').map(parseFloat);
          if (Math.abs(pos.x - targetX) < 0.06 && Math.abs(pos.y - targetY) < 0.06) correct++;
        });
        if (correct === 9) {
          document.getElementById('win').style.display = 'flex';
        }
      }
    }
  </script>
</body>
</html>


