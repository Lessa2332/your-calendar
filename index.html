<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Magic Coloring for My Star</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
      background: black; font-family: 'Comic Sans MS', cursive, sans-serif;
      touch-action: none; -webkit-tap-highlight-color: transparent;
    }
    a-scene { position: fixed; inset: 0; background: transparent !important; }
    
    #coloringCanvas {
      position: fixed; z-index: 100; pointer-events: auto; display: none;
      border: 4px solid #ff1493; border-radius: 20px;
      box-shadow: 0 0 40px rgba(255,20,147,0.8);
      transform: translate(-50%, -50%);
    }
    #closeBtn, #undoBtn {
      position: fixed; z-index: 1002; width: 56px; height: 56px;
      background: #ff1493; color: white; border: none; border-radius: 50%;
      font-size: 28px; font-weight: bold; box-shadow: 0 0 20px #ff1493;
      cursor: pointer;
    }
    #closeBtn { top: max(15px, env(safe-area-inset-top,15px)); right: 15px; }
    #undoBtn  { top: max(15px, env(safe-area-inset-top,15px)); left: 15px; display: none; }

    .screen {
      position: fixed; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center; color: white; z-index: 1001;
      text-align: center; background: rgba(0,0,0,0.9); padding: 20px;
    }
    #startScreen { background: radial-gradient(circle at center, rgba(255,20,147,0.7), transparent); }

    button {
      background: #ff1493; color: white; border: none; padding: 15px 30px;
      border-radius: 50px; font-size: clamp(18px, 4vw, 24px); cursor: pointer;
      box-shadow: 0 0 20px #ff1493; margin: 10px; min-height: 50px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    button:active { transform: scale(0.95); }

    #hintTextOnPuzzle {
      position: fixed; top: 10px; left: 10px; right: 10px; color: white;
      font-weight: bold; text-align: center; z-index: 1002; font-size: clamp(14px, 3.5vw, 20px);
      text-shadow: 2px 2px 8px #000; pointer-events: none; background: rgba(0,0,0,0.6);
      padding: 10px; border-radius: 12px; display: none;
    }

    #langBtn, #soundBtn, #etsyBtn {
      position: fixed; z-index: 1002; background: #ff1493; color: white;
      border: none; border-radius: 30px; font-weight: bold; cursor: pointer;
      box-shadow: 0 0 15px #ff1493; font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    #langBtn  { top: max(15px, env(safe-area-inset-top,15px)); left: 15px; padding: 10px 18px; }
    #soundBtn { bottom: max(20px, env(safe-area-inset-bottom,20px)); right: 20px; width: 56px; height: 56px; font-size: 24px; border-radius: 50%; }
    #etsyBtn  { bottom: max(20px, env(safe-area-inset-bottom,20px)); left: 20px; padding: 10px 16px; background: #f16521; box-shadow: 0 0 15px #f16521; text-decoration: none; display: flex; align-items: center; gap: 6px; }
    #etsyBtn::before { content: "Shopping"; font-size: 18px; }

    #colorPalette, #brushSliderContainer, #screenshotBtn, #currentColorIndicator {
      position: fixed; z-index: 1002; display: none;
    }
    #colorPalette {
      bottom: 100px; left: 10px; right: 10px; background: rgba(0,0,0,0.7);
      border-radius: 25px; padding: 12px; overflow-x: auto; white-space: nowrap;
    }
    .color-scroll-container { display: flex; gap: 10px; }
    .colorBtn {
      width: 48px; height: 48px; border-radius: 50%; border: 3px solid white;
      box-shadow: 0 0 10px rgba(0,0,0,0.5); cursor: pointer; flex-shrink: 0;
    }
    #brushSliderContainer {
      bottom: 60px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 320px;
      background: rgba(0,0,0,0.7); padding: 10px; border-radius: 20px; text-align: center; color: white;
    }
    #screenshotBtn {
      bottom: 15px; left: 50%; transform: translateX(-50%);
      width: 60px; height: 60px; background: #228B22; border-radius: 50%;
      font-size: 28px; box-shadow: 0 0 20px #228B22;
    }
    #currentColorIndicator {
      bottom: 165px; left: 50%; transform: translateX(-50%);
      width: 40px; height: 40px; border-radius: 50%; border: 4px solid white;
      box-shadow: 0 0 15px rgba(0,0,0,0.7);
    }

    #progressText {
      position: fixed; top: max(80px, env(safe-area-inset-top,80px)); left: 0; right: 0;
      text-align: center; color: #ff1493; font-size: 18px; z-index: 1001; font-weight: bold;
      text-shadow: 2px 2px 8px #000;
    }

    #loadingIndicator, #imageLoading {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: rgba(0,0,0,0.9); color: white; padding: 20px 30px; border-radius: 20px;
      font-size: 20px; z-index: 1004; display: none;
    }
  </style>
</head>
<body>

  <canvas id="coloringCanvas"></canvas>
  <button id="closeBtn">X</button>
  <button id="undoBtn">Undo</button>
  <div id="hintTextOnPuzzle"></div>
  <div id="progressText">0 / 12</div>

  <div id="loadingIndicator">Loading AR...</div>
  <div id="imageLoading">Loading magic...</div>

  <button id="langBtn">UA</button>
  <button id="soundBtn">Mute</button>
  <a href="https://smartlessa.etsy.com" target="_blank" id="etsyBtn">Our Store</a>

  <div id="currentColorIndicator"></div>
  <div id="colorPalette"><div class="color-scroll-container" id="colorScrollContainer"></div></div>
  <div id="brushSliderContainer">
    <div data-en="Brush Size" data-ua="Товщина пензля">Brush Size</div>
    <input type="range" id="brushSlider" min="3" max="40" value="12">
  </div>
  <button id="screenshotBtn">Camera</button>

  <div id="startScreen" class="screen">
    <h1 data-en="Magic Coloring" data-ua="Магічна Розмальовка">Magic Coloring</h1>
    <p data-en="12 magical pages are waiting for you!" data-ua="12 чарівних розмальовок чекають на тебе!">
      12 magical pages are waiting for you!
    </p>
    <button id="startBtn" data-en="START THE MAGIC!" data-ua="ПОЧАТИ МАГІЮ!">START THE MAGIC!</button>
  </div>

  <div id="hintScreen" class="screen" style="display:none">
    <h2 data-en="Point camera at any calendar picture!" data-ua="Наведи камеру на будь-яку картинку з календаря!">
      Point camera at any calendar picture!
    </h2>
    <p data-en="Magic coloring page will appear!" data-ua="З'явиться чарівна розмальовка!">
      Magic coloring page will appear!
    </p>
  </div>

  <audio id="bgMusic" loop preload="auto">
    <source src="fon/01.mp3" type="audio/mp3">
  </audio>
  <audio id="drawSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" type="audio/mp3">
  </audio>

  <a-scene embedded mindar-image="imageTargetSrc: calendar.mind; filterMinCF:0.0001; filterBeta:1000; warmupTolerance:3;"
    renderer="antialias: true; alpha: true; colorManagement: true;"
    vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
    <a-camera active="false"></a-camera>
  </a-scene>

  <script>
    console.log('Magic Coloring 2.0 — ready!');

    const TOTAL_PAGES = 12;
    const COLORS = ['#FF1493','#FF69B4','#FFB6C1','#FFA500','#FFFF00','#ADFF2F','#00FF00','#00CED1','#1E90FF','#9370DB','#FF69B4','#FFD700'];
    let currentColoring = null;
    let currentMarkerId = null;
    let isUA = false;
    let soundOn = false;
    let completedPages = new Set(JSON.parse(localStorage.getItem('completedPages') || '[]'));
    
    const music = document.getElementById('bgMusic');
    const drawSound = document.getElementById('drawSound');
    music.volume = 0.4;

    function updateProgress() {
      document.getElementById('progressText').textContent = 
        isUA ? `${completedPages.size} / ${TOTAL_PAGES}` : `${completedPages.size} / ${TOTAL_PAGES}`;
    }

    function setLanguage(ua) {
      isUA = ua;
      document.querySelectorAll('[data-ua]').forEach(el => {
        el.textContent = ua ? el.dataset.ua : el.dataset.en;
      });
      document.getElementById('langBtn').textContent = ua ? 'EN' : 'UA';
      document.getElementById('etsyBtn').textContent = ua ? 'Наш магазин' : 'Our Store';
      updateProgress();
    }

    function showHint(text) {
      const el = document.getElementById('hintTextOnPuzzle');
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    function saveDrawing(id) {
      if (!currentColoring) return;
      try {
        localStorage.setItem(`drawing-${id}`, currentColoring.canvas.toDataURL());
        completedPages.add(id);
        localStorage.setItem('completedPages', JSON.stringify([...completedPages]));
        updateProgress();
      } catch(e) { console.error('Save failed', e); }
    }

    class ColoringApp {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d', { alpha: true });
        this.history = [];
        this.isDrawing = false;
        this.lastX = 0; this.lastY = 0;
        this.setupEvents();
        this.saveState();
      }
      setImage(img) {
        const maxW = window.innerWidth * 0.85;
        const maxH = window.innerHeight * 0.75;
        let w = img.width, h = img.height;
        if (w > maxW) { h = (maxW/w)*h; w = maxW; }
        if (h > maxH) { w = (maxH/h)*w; h = maxH; }

        this.canvas.width = w;
        this.canvas.height = h;
        this.canvas.style.width = w + 'px';
        this.canvas.style.height = h + 'px';
        this.canvas.style.left = '50%';
        this.canvas.style.top = '50%';

        this.ctx.drawImage(img, 0, 0, w, h);
        this.saveState();
      }
      saveState() {
        this.history.push(this.canvas.toDataURL());
        if (this.history.length > 20) this.history.shift();
      }
      undo() {
        if (this.history.length <= 1) return;
        this.history.pop();
        const img = new Image();
        img.onload = () => this.ctx.drawImage(img, 0, 0);
        img.src = this.history[this.history.length-1];
      }
      setupEvents() {
        const getCoord = e => {
          const rect = this.canvas.getBoundingClientRect();
          const touch = e.touches ? e.touches[0] : e;
          return {
            x: (touch.clientX - rect.left) * (this.canvas.width / rect.width),
            y: (touch.clientY - rect.top) * (this.canvas.height / rect.height)
          };
        };

        const start = e => {
          this.isDrawing = true;
          const pos = getCoord(e);
          this.lastX = pos.x; this.lastY = pos.y;
          e.preventDefault();
        };
        const move = e => {
          if (!this.isDrawing) return;
          const pos = getCoord(e);
          this.ctx.globalCompositeOperation = 'source-over';
          this.ctx.lineWidth = brushSize;
          this.ctx.lineCap = this.ctx.lineJoin = 'round';
          this.ctx.strokeStyle = brushColor;
          this.ctx.beginPath();
          this.ctx.moveTo(this.lastX, this.lastY);
          this.ctx.lineTo(pos.x, pos.y);
          this.ctx.stroke();
          this.lastX = pos.x; this.lastY = pos.y;
          if (soundOn) { drawSound.currentTime = 0; drawSound.play(); }
          if ('vibrate' in navigator) navigator.vibrate(10);
          e.preventDefault();
        };
        const end = () => {
          if (this.isDrawing) this.saveState();
          this.isDrawing = false;
        };

        ['touchstart','mousedown'].forEach(ev => this.canvas.addEventListener(ev, start, {passive:false}));
        ['touchmove','mousemove'].forEach(ev => this.canvas.addEventListener(ev, move, {passive:false}));
        ['touchend','mouseup','touchcancel','mouseout'].forEach(ev => this.canvas.addEventListener(ev, end));
      }
    }

    // === UI ===
    const canvas = document.getElementById('coloringCanvas');
    let brushColor = COLORS[0];
    let brushSize = 12;

    function showColoringUI(show) {
      const display = show ? 'block' : 'none';
      ['coloringCanvas','colorPalette','brushSliderContainer','screenshotBtn','closeBtn','undoBtn','currentColorIndicator','hintTextOnPuzzle'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = display;
      });
    }

    document.getElementById('colorScrollContainer').innerHTML = COLORS.map(c => 
      `<button class="colorBtn" style="background:${c}" onclick="brushColor='${c}';document.getElementById('currentColorIndicator').style.background='${c}'"></button>`
    ).join('');
    document.getElementById('currentColorIndicator').style.background = brushColor;
    document.getElementById('brushSlider').oninput = e => brushSize = +e.target.value;

    document.getElementById('langBtn').onclick = () => setLanguage(!isUA);
    document.getElementById('soundBtn').onclick = () => {
      soundOn = !soundOn;
      document.getElementById('soundBtn').textContent = soundOn ? 'Sound On' : 'Mute';
      if (soundOn && music.paused) music.play();
      else music.pause();
    };
    document.getElementById('undoBtn').onclick = () => currentColoring?.undo();
    document.getElementById('closeBtn').onclick = () => {
      if (currentColoring) saveDrawing(currentMarkerId);
      showColoringUI(false);
      currentColoring = null;
      currentMarkerId = null;
    };
    document.getElementById('screenshotBtn').onclick = () => {
      if (!currentColoring) return;
      const a = document.createElement('a');
      a.download = `magic-coloring-${currentMarkerId+1}.png`;
      a.href = currentColoring.canvas.toDataURL();
      a.click();
      showHint(isUA ? 'Збережено!' : 'Saved!');
      saveDrawing(currentMarkerId);
    };

    // === AR ===
    document.getElementById('startBtn').onclick = async () => {
      document.getElementById('loadingIndicator').style.display = 'block';
      try {
        await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        document.querySelector('a-scene').systems['mindar-image-system'].start();
        document.getElementById('hintScreen').style.display = 'flex';
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('loadingIndicator').style.display = 'none';
        if (soundOn) music.play();
      } catch(e) {
        alert(isUA ? "Дозволь камеру!" : "Please allow camera!");
      }
    };

    // Створюємо 12 цільових маркерів
    for (let i = 0; i < TOTAL_PAGES; i++) {
      const anchor = document.createElement('a-entity');
      anchor.setAttribute('mindar-image-target', `targetIndex: ${i}`);

      anchor.addEventListener('targetFound', () => {
        if (currentMarkerId !== null) return; // вже відкрито
        currentMarkerId = i;

        document.getElementById('imageLoading').style.display = 'block';

        const img = new Image();
        img.onload = () => {
          document.getElementById('imageLoading').style.display = 'none';
          currentColoring = new ColoringApp(canvas);
          currentColoring.setImage(img);

          // Відновлення збереженого
          const saved = localStorage.getItem(`drawing-${i}`);
          if (saved) {
            const savedImg = new Image();
            savedImg.onload = () => currentColoring.ctx.drawImage(savedImg, 0, 0);
            savedImg.src = saved;
          }

          canvas.style.display = 'block';
          showColoringUI(true);
          document.getElementById('undoBtn').style.display = 'block';
          showHint(isUA ? 'Малюй! Зберігай Camera' : 'Draw! Save Camera');
        };
        img.src = `images/${String(i+1).padStart(2,'0')}.jpg?t=${Date.now()}`;
      });

      anchor.addEventListener('targetLost', () => {
        if (currentMarkerId === i) {
          if (currentColoring) saveDrawing(i);
          showColoringUI(false);
          currentColoring = null;
          currentMarkerId = null;
        }
      });

      document.querySelector('a-scene').appendChild(anchor);
    }

    // Готово!
    setLanguage(false);
    updateProgress();
  </script>
</body>
</html>
