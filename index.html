<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ú–∞–≥—ñ—á–Ω–µ —Ä–æ–∑—Ñ–∞—Ä–±–æ–≤—É–≤–∞–Ω–Ω—è</title>

  <!-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ò–ô –ü–û–†–Ø–î–û–ö -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    * { 
      margin:0; padding:0; box-sizing:border-box; 
      -webkit-tap-highlight-color: transparent; /* –í–∏–¥–∞–ª—è—î —Å–∏–Ω—ñ–π highlight –Ω–∞ —Ç–∞–ø */
      -webkit-touch-callout: none; /* –í–∏–º–∏–∫–∞—î –º–µ–Ω—é –Ω–∞ –¥–æ–≤–≥–∏–π —Ç–∞–ø */
    }
    
    body, html { 
      margin:0; height:100%; overflow:hidden; 
      background:#000; font-family:'Comic Sans MS',cursive,sans-serif;
      touch-action: manipulation; /* –ó–∞–ø–æ–±—ñ–≥–∞—î –∑—É–º—É –Ω–∞ —Ç–∞–ø */
      position: fixed; /* –§—ñ–∫—Å—É—î —Å–∫—Ä–æ–ª */
      width: 100%;
    }
    
    #hint { 
      position:fixed; top: max(20px, env(safe-area-inset-top, 20px)); 
      left:50%; transform:translateX(-50%); 
      background:#ff1493; color:#fff; padding:12px 24px; 
      border-radius:50px; font-size:clamp(16px, 4vw, 24px); 
      z-index:999; box-shadow:0 0 30px #ff1493; text-align:center;
      width: 90%;
      max-width: 400px;
    }
    
    .controls { 
      position:fixed; 
      bottom: max(20px, env(safe-area-inset-bottom, 20px));
      left:50%; transform:translateX(-50%); 
      display:flex; gap:10px; align-items:center; z-index:1000; 
      background:rgba(0,0,0,0.85); padding:12px 16px; border-radius:25px; 
      backdrop-filter: blur(10px);
      width: 95%;
      max-width: 500px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .colors { 
      display:flex; gap:6px; 
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .color-btn { 
      width:clamp(36px, 8vw, 44px); 
      height:clamp(36px, 8vw, 44px); 
      border-radius:50%; border:3px solid transparent; 
      cursor:pointer; transition:all .2s; 
      flex-shrink: 0;
    }
    
    .color-btn.active { 
      border:3px solid white; transform:scale(1.15); 
      box-shadow:0 0 15px rgba(255,255,255,0.6); 
    }
    
    input[type="range"] { 
      width:clamp(100px, 25vw, 130px); 
      accent-color:#ff1493; 
      flex-shrink: 0;
    }
    
    .zoom-btn { 
      width:clamp(42px, 10vw, 50px); 
      height:clamp(42px, 10vw, 50px); 
      border-radius:50%; background:#fff; color:#000; 
      font-size:clamp(20px, 6vw, 28px); font-weight:bold; 
      display:flex; align-items:center; justify-content:center; 
      cursor:pointer; user-select:none; flex-shrink: 0;
    }
    
    #brushValue { 
      color:white; font-size:clamp(14px, 4vw, 18px); 
      min-width:30px; text-align:center; 
      flex-shrink: 0;
    }
    
    #cameraPreview {
      position:fixed; top:0; left:0; width:100%; height:100%; 
      object-fit:cover; z-index:0; display:none;
    }
    
    /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è iOS */
    @supports (-webkit-touch-callout: none) {
      .controls {
        padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      }
    }
    
    /* –ê–Ω—ñ–º–∞—Ü—ñ—ó –¥–ª—è –∫—Ä–∞—â–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó */
    .color-btn:active, .zoom-btn:active {
      transform: scale(0.95);
      transition: transform 0.1s;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
    @media (max-height: 700px) {
      .controls {
        padding: 8px 12px;
        gap: 8px;
      }
      
      .colors {
        gap: 4px;
      }
      
      #hint {
        padding: 8px 16px;
        font-size: clamp(14px, 3.5vw, 18px);
      }
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –¥—É–∂–µ –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
    @media (max-width: 350px) {
      .controls {
        flex-direction: column;
        gap: 8px;
      }
      
      .colors {
        order: 1;
      }
    }
  </style>
</head>
<body>

  <video id="cameraPreview" playsinline muted autoplay></video>
  <div id="hint">–ù–∞—Ç–∏—Å–Ω–∏ –µ–∫—Ä–∞–Ω ‚Üí –ø–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä ‚Üí –º–∞–ª—é–π!</div>

  <div class="controls">
    <div class="colors">
      <div class="color-btn active" data-color="#ff6961" style="background:#ff6961"></div>
      <div class="color-btn" data-color="#fdfd96" style="background:#fdfd96"></div>
      <div class="color-btn" data-color="#77dd77" style="background:#77dd77"></div>
      <div class="color-btn" data-color="#84b6f4" style="background:#84b6f4"></div>
      <div class="color-btn" data-color="#fdcae1" style="background:#fdcae1"></div>
      <div class="color-btn" data-color="#cbaacb" style="background:#cbaacb"></div>
      <div class="color-btn" data-color="#ff9ff3" style="background:#ff9ff3"></div>
      <div class="color-btn" data-color="#feca57" style="background:#feca57"></div>
      <div class="color-btn" data-color="#2d3436" style="background:#2d3436"></div>
    </div>
    <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
      <input type="range" id="brushSize" min="3" max="50" value="15">
      <div id="brushValue">15</div>
    </div>
    <div style="display: flex; gap: 5px; flex-shrink: 0;">
      <div class="zoom-btn" onclick="zoomIn()">+</div>
      <div class="zoom-btn" onclick="zoomOut()">‚Äì</div>
    </div>
  </div>

  <a-scene
    embedded
    mindar-image="imageTargetSrc: ./calendar.mind; autoStart:false; uiLoading:no; uiError:no; uiScanning:no; filterMinCF:0.0001; filterBeta:1000; warmupTolerance:5"
    renderer="colorManagement:true; antialias: true;"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    xr-mode-ui="enabled: false">
    
    <a-camera 
      active="false"
      raycaster="objects: .draw-surface; far: 100"
      cursor="fuse: false; rayOrigin: mouse"
      wasd-controls="enabled: false"
      look-controls="enabled: false">
    </a-camera>
    
    <a-entity id="drawing-container"></a-entity>
  </a-scene>

  <script>
    // === –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ ===
    let currentColor = '#ff6961';
    let brushSize = 15;
    let scale = 1;
    let drawingCanvas = null;
    let ctx = null;
    let activeTargetIndex = null;
    let audio = null;
    let isDrawing = false;
    let lastIntersection = null;
    let cameraStream = null;
    let userInteracted = false;

    // === –ê—É–¥—ñ–æ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∫–∞ ===
    function unlockAudio() {
      if (userInteracted) return;
      userInteracted = true;
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioCtx.resume();
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∏—Ö–∏–π –∑–≤—É–∫ –¥–ª—è —Ä–æ–∑–±–ª–æ–∫–æ–≤–∫–∏ –∞—É–¥—ñ–æ –≤ iOS
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        gainNode.gain.value = 0.001; // –î—É–∂–µ —Ç–∏—Ö–æ
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        setTimeout(() => oscillator.stop(), 100);
      } catch (e) {
        console.log('–ê—É–¥—ñ–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
      }
    }

    // === Touch events –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö ===
    function setupTouchEvents() {
      const scene = document.querySelector('a-scene');
      
      // –î–ª—è touch –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤
      scene.addEventListener('touchstart', (e) => {
        if (e.touches.length > 0) {
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
          });
          scene.dispatchEvent(mouseEvent);
        }
        e.preventDefault();
      }, { passive: false });

      scene.addEventListener('touchmove', (e) => {
        if (e.touches.length > 0) {
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
          });
          scene.dispatchEvent(mouseEvent);
        }
        e.preventDefault();
      }, { passive: false });

      scene.addEventListener('touchend', (e) => {
        scene.dispatchEvent(new MouseEvent('mouseup'));
        e.preventDefault();
      }, { passive: false });
    }

    // === –°—Ç–≤–æ—Ä–µ–Ω–Ω—è 12 —Ü—ñ–ª–µ–π ===
    function createTargets() {
      const container = document.getElementById('drawing-container');
      for (let i = 0; i < 12; i++) {
        const target = document.createElement('a-entity');
        target.setAttribute('mindar-image-target', { targetIndex: i });
        target.id = `target-${i}`;
        container.appendChild(target);
      }
    }

    // === –ó–∞–ø—É—Å–∫ AR –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫ ===
    async function startAR() {
      try {
        console.log('üöÄ –ó–∞–ø—É—Å–∫ AR –∑ –∫–∞–º–µ—Ä–æ—é...');
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('–ö–∞–º–µ—Ä–∞ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –Ω–∞ —Ü—å–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó');
        }

        // –û—Ç—Ä–∏–º—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–µ–≤'—é –∫–∞–º–µ—Ä–∏
        const cameraPreview = document.getElementById('cameraPreview');
        cameraPreview.srcObject = cameraStream;
        cameraPreview.style.display = 'block';
        
        console.log('‚úÖ –ö–∞–º–µ—Ä–∞ —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞');

        // –ó–∞–ø—É—Å–∫–∞—î–º–æ MindAR
        const scene = document.querySelector('a-scene');
        const mindarSystem = scene.systems['mindar-image-system'];
        
        if (mindarSystem) {
          // –ß–µ–∫–∞—î–º–æ —Ç—Ä–æ—Ö–∏ –¥–ª—è —Å—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞–º–µ—Ä–∏
          await new Promise(resolve => setTimeout(resolve, 500));
          
          await mindarSystem.start();
          console.log('‚úÖ MindAR —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ');
          
          // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–∞–º–µ—Ä—É A-Frame
          const aframeCamera = document.querySelector('a-camera');
          aframeCamera.setAttribute('active', 'true');
          
          document.getElementById('hint').textContent = '–ü–æ–∫–∞–∂–∏ –º–∞—Ä–∫–µ—Ä –∫–∞–º–µ—Ä—ñ! üì±';
        }

      } catch (err) {
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏:', err);
        
        let errorMessage = '‚ùå –ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏! ';
        if (err.name === 'NotAllowedError') {
          errorMessage += '–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
        } else if (err.name === 'NotFoundError') {
          errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞.';
        } else {
          errorMessage += '–°–ø—Ä–æ–±—É–π –ø—ñ–∑–Ω—ñ—à–µ.';
        }
        
        document.getElementById('hint').textContent = errorMessage;
        userInteracted = false; // –î–æ–∑–≤–æ–ª—è—î–º–æ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑
      }
    }

    // === –Ü–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –Ω–µ–∑–º—ñ–Ω–Ω–∏–º–∏ ===
    function onTargetFound(e) {
      const idx = e.detail.targetIndex;
      console.log('–ó–Ω–∞–π–¥–µ–Ω–æ –º–∞—Ä–∫–µ—Ä:', idx);
      if (activeTargetIndex === idx) return;
      resetAll();
      activeTargetIndex = idx;
      loadImageAndSound(idx);
    }

    function onTargetLost(e) {
      console.log('–í—Ç—Ä–∞—á–µ–Ω–æ –º–∞—Ä–∫–µ—Ä:', e.detail.targetIndex);
      if (activeTargetIndex === e.detail.targetIndex) {
        resetAll();
      }
    }

    function resetAll() {
      if (audio) { 
        audio.pause(); 
        audio = null; 
      }
      document.querySelectorAll('.draw-surface').forEach(el => el.remove());
      drawingCanvas = ctx = null;
      scale = 1;
      activeTargetIndex = null;
      isDrawing = false;
    }

    async function loadImageAndSound(idx) {
      try {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = `./images/${String(idx + 1).padStart(2, '0')}.jpg?t=${Date.now()}`;
        
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = () => reject(new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ${idx + 1}`));
        });

        try {
          audio = new Audio(`./fon/fon${idx + 1}.mp3`);
          audio.loop = true;
          audio.volume = 0.5;
          await audio.play().catch(e => console.log('üîá –ó–≤—É–∫ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä—é—î—Ç—å—Å—è'));
        } catch(e) {
          console.log('–§–∞–π–ª –∑–≤—É–∫—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        }

        createCanvas(img, idx);
      } catch(error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
        createFallbackCanvas(idx);
      }
    }

    function createCanvas(img, idx) {
      const canvas = document.createElement('canvas');
      // –û–±–º–µ–∂—É—î–º–æ —Ä–æ–∑–º—ñ—Ä –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤
      const maxSize = 1024;
      const ratio = Math.min(maxSize / img.width, maxSize / img.height, 1);
      canvas.width = img.width * ratio;
      canvas.height = img.height * ratio;
      
      ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      const plane = document.createElement('a-plane');
      plane.className = 'draw-surface';
      plane.setAttribute('position', '0 0 0.01');
      plane.setAttribute('width', 0.6);
      plane.setAttribute('height', (canvas.height / canvas.width) * 0.6);
      plane.setAttribute('material', 'src', canvas.toDataURL());
      plane.setAttribute('material', 'transparent', 'true');
      plane.setAttribute('class', 'draw-surface interactive');
      
      document.getElementById(`target-${idx}`).appendChild(plane);
      drawingCanvas = canvas;
    }

    function createFallbackCanvas(idx) {
      const canvas = document.createElement('canvas');
      canvas.width = 800;
      canvas.height = 600;
      ctx = canvas.getContext('2d');
      ctx.fillStyle = '#2a2a2a';
      ctx.fillRect(0, 0, 800, 600);
      ctx.fillStyle = '#fff';
      ctx.font = '40px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('–ú–∞–ª—é–π —Ç—É—Ç!', 400, 300);

      const plane = document.createElement('a-plane');
      plane.className = 'draw-surface';
      plane.setAttribute('position', '0 0 0.01');
      plane.setAttribute('width', 0.6);
      plane.setAttribute('height', 0.45);
      plane.setAttribute('material', 'src', canvas.toDataURL());
      plane.setAttribute('material', 'transparent', 'true');
      plane.setAttribute('class', 'draw-surface interactive');
      
      document.getElementById(`target-${idx}`).appendChild(plane);
      drawingCanvas = canvas;
    }

    function handleDrawing(intersection) {
      if (!intersection || !drawingCanvas || !ctx) return;
      
      const uv = intersection.uv;
      if (!uv) return;
      
      const x = uv.x * drawingCanvas.width;
      const y = (1 - uv.y) * drawingCanvas.height;
      
      if (isDrawing && lastIntersection) {
        const lastUV = lastIntersection.uv;
        const lastX = lastUV.x * drawingCanvas.width;
        const lastY = (1 - lastUV.y) * drawingCanvas.height;
        
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        updateCanvasTexture();
      }
      
      lastIntersection = intersection;
    }

    function updateCanvasTexture() {
      const plane = document.querySelector('.draw-surface');
      if (plane && drawingCanvas) {
        plane.setAttribute('material', 'src', drawingCanvas.toDataURL());
      }
    }

    // === –ö–µ—Ä—É–≤–∞–Ω–Ω—è ===
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentColor = btn.dataset.color;
      });
    });

    document.getElementById('brushSize').addEventListener('input', e => {
      brushSize = Number(e.target.value);
      document.getElementById('brushValue').textContent = brushSize;
    });

    function zoomIn()  { 
      scale = Math.min(3, scale + 0.25); 
      updateScale(); 
    }
    
    function zoomOut() { 
      scale = Math.max(0.6, scale - 0.25); 
      updateScale(); 
    }
    
    function updateScale() {
      const plane = document.querySelector('.draw-surface');
      if (!plane || !drawingCanvas) return;
      const baseW = 0.6;
      const baseH = (drawingCanvas.height / drawingCanvas.width) * 0.6;
      plane.setAttribute('width', baseW * scale);
      plane.setAttribute('height', baseH * scale);
    }

    function cleanup() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      resetAll();
    }

    // === –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ===
    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log('–°—Ü–µ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è...');
      createTargets();
      setupTouchEvents(); // ‚úÖ –î–æ–¥–∞—î–º–æ touch events
      
      const scene = document.querySelector('a-scene');
      scene.addEventListener('targetFound', onTargetFound);
      scene.addEventListener('targetLost', onTargetLost);
      
      scene.addEventListener('mousedown', (e) => {
        if (e.detail.intersectedEl && e.detail.intersectedEl.classList.contains('draw-surface')) {
          isDrawing = true;
          lastIntersection = e.detail.intersection;
          handleDrawing(e.detail.intersection);
        }
      });
      
      scene.addEventListener('mouseup', () => {
        isDrawing = false;
        lastIntersection = null;
      });
      
      scene.addEventListener('mousemove', (e) => {
        if (isDrawing && e.detail.intersectedEl && e.detail.intersectedEl.classList.contains('draw-surface')) {
          handleDrawing(e.detail.intersection);
        }
      });

      // –ó–∞–ø—É—Å–∫ AR –ø–æ –∫–ª—ñ–∫—É
      document.body.addEventListener('click', () => {
        unlockAudio();
        startAR();
      }, { once: true });
      
      document.getElementById('hint').textContent = '–ì–æ—Ç–æ–≤–æ! –ù–∞—Ç–∏—Å–Ω–∏ –¥–ª—è –∑–∞–ø—É—Å–∫—É –∫–∞–º–µ—Ä–∏ üì±';
    });

    window.addEventListener('beforeunload', cleanup);
    window.addEventListener('pagehide', cleanup);
  </script>
</body>
</html>
